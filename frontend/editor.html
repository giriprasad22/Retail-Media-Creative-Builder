<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Editor - AI Powered</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/ai-panel.css">
    <link rel="stylesheet" href="css/tesco.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark-bg: #0a0a0f;
            --dark-surface: #12121a;
            --dark-card: #1a1a24;
            --dark-border: #2a2a3a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            
            /* Scrollbar variables */
            --scrollbar-width: 8px;
            --scrollbar-track: rgba(26, 26, 36, 0.4);
            --scrollbar-thumb: rgba(99, 102, 241, 0.3);
            --scrollbar-thumb-hover: rgba(99, 102, 241, 0.5);
            --scrollbar-thumb-active: rgba(99, 102, 241, 0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ============================================
           CUSTOM SCROLLBAR STYLES
           ============================================ */
        
        /* Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: var(--scrollbar-width);
            height: var(--scrollbar-width);
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        ::-webkit-scrollbar-thumb:active {
            background: var(--scrollbar-thumb-active);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }

        /* Enhanced scrollbar for dark surfaces */
        .sidebar-left::-webkit-scrollbar-track,
        .sidebar-right::-webkit-scrollbar-track,
        .layers-list::-webkit-scrollbar-track,
        .ai-messages::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: rgba(18, 18, 26, 0.6);
        }

        /* Gradient scrollbar thumb effect */
        .ai-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.4) 0%, rgba(139, 92, 246, 0.4) 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .ai-messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.6) 0%, rgba(139, 92, 246, 0.6) 100%);
            background-clip: padding-box;
        }

        /* Scrollbar corner (where horizontal and vertical meet) */
        ::-webkit-scrollbar-corner {
            background: var(--dark-surface);
        }

        /* Smooth scrolling for all containers */
        html {
            scroll-behavior: smooth;
        }

        .layers-list,
        .ai-messages,
        .tab-content,
        .suggestions-cards,
        .modal-body {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease;
        }

        .sidebar-left:not(.collapsed) {
            width: 280px;
        }

        .sidebar-right:not(.collapsed) {
            width: 320px;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            background: rgba(18, 18, 26, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--dark-border);
            box-shadow: 0 1px 0 0 rgba(99, 102, 241, 0.1);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .back-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s;
        }

        .back-btn:hover::before {
            left: 100%;
        }

        .back-btn:hover {
            background: var(--dark-card);
            color: var(--text-primary);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .project-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .platform-select {
            padding: 0.5rem 1rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }

        .platform-select:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.1);
        }

        .platform-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .platform-select option {
            background: var(--dark-card);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tool-divider {
            width: 1px;
            height: 24px;
            background: var(--dark-border);
            margin: 0 0.5rem;
        }

        .tool-btn {
            width: 40px;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .tool-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .export-btn {
            padding: 0.6rem 1.25rem;
            background: var(--gradient-1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Sidebar - Layers */
        .sidebar-left {
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--dark-border);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .sidebar-header:hover {
            background: var(--dark-card);
        }

        .sidebar-header .toggle-icon {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-left.collapsed .sidebar-header .toggle-icon {
            transform: rotate(180deg);
        }

        .sidebar-left {
            transition: width 0.3s ease;
        }

        .sidebar-left.collapsed {
            width: 50px;
        }

        .sidebar-left.collapsed .layers-list {
            display: none;
        }

        .sidebar-left.collapsed .sidebar-header span {
            display: none;
        }

        .sidebar-left.collapsed .sidebar-header {
            justify-content: center;
            padding: 1rem 0.5rem;
        }

        .sidebar-left.collapsed .sidebar-header .toggle-icon {
            margin-left: 0;
        }

        .layers-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .layer-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            border-radius: 10px 0 0 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .layer-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .layer-item:hover::before {
            opacity: 1;
        }

        .layer-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), inset 0 0 0 1px rgba(99, 102, 241, 0.2);
        }

        .layer-item.selected::before {
            opacity: 1;
        }

        .layer-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark-surface);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .layer-info {
            flex: 1;
            min-width: 0;
        }

        .layer-name {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .layer-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .layer-visibility {
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
        }

        .layer-visibility:hover {
            color: var(--text-primary);
        }

        /* Canvas Area - Full Editor Background */
        .canvas-area {
            background: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%),
                linear-gradient(-45deg, #1a1a1a 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1a1a1a 75%),
                linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #0f0f0f;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: auto;
            padding: 2rem;
        }

        .canvas-container {
            position: relative;
            background: transparent;
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.05),
                0 25px 80px rgba(0, 0, 0, 0.8),
                0 10px 40px rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            flex-shrink: 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #mainCanvas {
            display: block;
        }

        .zoom-controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0.75rem;
            background: rgba(18, 18, 26, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(99, 102, 241, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .zoom-controls:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(26, 26, 36, 0.6);
            border: 1px solid transparent;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .zoom-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .zoom-btn:hover::before {
            width: 60px;
            height: 60px;
        }

        .zoom-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: var(--primary-light);
            transform: translateY(-2px);
        }

        .zoom-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .zoom-value {
            min-width: 55px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Sidebar Right - Properties & AI */
        .sidebar-right {
            background: var(--dark-surface);
            border-left: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar-right.collapsed {
            width: 50px;
        }

        .sidebar-right.collapsed .tabs {
            flex-direction: column;
            padding: 0.5rem 0;
        }

        .sidebar-right.collapsed .tab {
            padding: 0.75rem;
            justify-content: center;
        }

        .sidebar-right.collapsed .tab span {
            display: none;
        }

        .sidebar-right.collapsed .tab i {
            margin: 0;
        }

        .sidebar-right.collapsed .tab-content {
            display: none;
        }

        .sidebar-right .sidebar-toggle {
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--dark-border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            transition: all 0.2s;
        }

        .sidebar-right .sidebar-toggle:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .sidebar-right.collapsed .sidebar-toggle {
            justify-content: center;
        }

        .sidebar-right .sidebar-toggle .toggle-icon {
            transition: transform 0.3s ease;
        }

        .sidebar-right.collapsed .sidebar-toggle .toggle-icon {
            transform: rotate(180deg);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--dark-border);
        }

        .tab {
            flex: 1;
            padding: 0.875rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* AI Chat Panel */
        .ai-chat {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-light);
        }

        .ai-brain-icon {
            font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .ai-dots {
            display: flex;
            gap: 0.25rem;
        }

        .ai-dots .dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .ai-dots .dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-dots .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ai-message {
            padding: 0.875rem;
            border-radius: 16px;
            max-width: 95%;
            animation: messageSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message.assistant {
            background: rgba(26, 26, 36, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.2);
            align-self: flex-start;
        }

        .ai-message.user {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            align-self: flex-end;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .ai-message-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .ai-suggestion {
            padding: 0.4rem 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--primary-light);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .ai-suggestion::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ai-suggestion:hover::before {
            width: 200px;
            height: 200px;
        }

        .ai-suggestion:hover {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .ai-input-area {
            padding: 1rem;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
            background: linear-gradient(180deg, transparent 0%, rgba(18, 18, 26, 0.5) 100%);
        }

        .ai-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            position: relative;
        }

        .ai-input {
            flex: 1;
            padding: 0.875rem 1rem;
            background: rgba(26, 26, 36, 0.8);
            border: 1.5px solid var(--dark-border);
            border-radius: 14px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 44px;
            max-height: 120px;
        }

        .ai-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .ai-input:hover {
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(26, 26, 36, 0.95);
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(26, 26, 36, 1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .ai-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .ai-send-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ai-send-btn:hover::after {
            width: 100px;
            height: 100px;
        }

        .ai-send-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .ai-send-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: 0.75rem;
            border-radius: 10px;
            overflow: hidden;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            transition: all 0.3s ease;
        }

        .collapsible-section .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            background: var(--dark-surface);
            user-select: none;
            transition: background 0.2s;
        }

        .collapsible-section .section-header:hover {
            background: var(--dark-card);
        }

        .collapsible-section .toggle-icon {
            transition: transform 0.3s ease;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .collapsible-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible-section .section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 1rem;
        }

        .collapsible-section.collapsed .section-content {
            max-height: 0;
            padding: 0 1rem;
        }

        /* Properties Panel */
        .property-group {
            margin-bottom: 1.5rem;
        }

        .property-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .property-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .property-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 60px;
        }

        .property-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .property-input-small {
            width: 70px;
            text-align: center;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-preview {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid var(--dark-border);
            cursor: pointer;
        }

        .color-input {
            opacity: 0;
            position: absolute;
            width: 32px;
            height: 32px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .quick-action {
            padding: 0.75rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: var(--dark-border);
            color: var(--text-primary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 0.875rem 1.25rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: toastIn 0.3s ease;
        }

        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error { border-color: var(--error); color: var(--error); }
        .toast.warning { border-color: var(--warning); color: var(--warning); }

        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI Processing Indicator */
        .ai-processing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--primary-light);
        }

        .ai-processing .dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .ai-processing .dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-processing .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Compliance Badge */
        .compliance-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .compliance-indicator.compliant {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .compliance-indicator.issues {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-panel {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-panel {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(85vh - 70px);
        }

        /* Templates Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .template-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .template-preview {
            aspect-ratio: 16/9;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .template-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-preview .template-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }

        .template-info {
            padding: 0.875rem;
        }

        .template-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .template-category {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Resize Panel */
        .resize-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .resize-option {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .resize-option:hover {
            border-color: var(--primary);
        }

        .resize-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .resize-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
            background: var(--dark-surface);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .resize-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .resize-dimensions {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .custom-size-form {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            padding: 1.5rem;
            background: var(--dark-card);
            border-radius: 12px;
            margin-top: 1rem;
        }

        .size-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .size-input-group label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .size-input-group input {
            width: 100px;
            padding: 0.625rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .apply-btn {
            padding: 0.625rem 1.5rem;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apply-btn:hover {
            background: var(--primary-dark);
        }

        /* Effects Panel */
        .effects-section {
            margin-bottom: 1.5rem;
        }

        .effects-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .effect-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .effect-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .effect-btn i {
            font-size: 1.25rem;
        }

        .effect-btn span {
            font-size: 0.75rem;
        }

        .slider-group {
            margin-bottom: 1rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .slider-label span:first-child {
            color: var(--text-secondary);
        }

        .slider-label span:last-child {
            color: var(--text-muted);
        }

        .effect-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--dark-border);
            border-radius: 3px;
            outline: none;
        }

        .effect-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Text Presets */
        .text-presets-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .text-preset {
            padding: 1rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .text-preset:hover {
            border-color: var(--primary);
        }

        .text-preset-preview {
            font-size: var(--preset-size, 18px);
            font-weight: var(--preset-weight, 400);
            color: var(--preset-color, #ffffff);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .text-preset-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Layer Controls Enhancement */
        .layer-controls {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .layer-item:hover .layer-controls {
            opacity: 1;
        }

        .layer-control-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.7rem;
        }

        .layer-control-btn:hover {
            background: var(--dark-surface);
            color: var(--text-primary);
        }

        .layer-item.locked {
            opacity: 0.6;
        }

        .layer-item.locked .layer-icon {
            position: relative;
        }

        .layer-item.locked .layer-icon::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 0.6rem;
            color: var(--warning);
        }

        /* Hidden file input */
        #imageUploadInput {
            display: none;
        }

        /* Processing overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            gap: 1.5rem;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--dark-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .processing-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        /* Category filters */
        .category-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .category-filter {
            padding: 0.5rem 1rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-filter:hover {
            border-color: var(--primary);
        }

        .category-filter.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        .palette-color {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .palette-color:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .palette-color.selected {
            border-color: var(--primary);
        }

        /* Brand Colors */
        .brand-colors {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--dark-border);
        }

        .brand-color {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .brand-color:hover {
            transform: scale(1.15);
        }

        .add-brand-color {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px dashed var(--dark-border);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .add-brand-color:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Undo/Redo buttons */
        .history-controls {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 1px solid var(--dark-border);
        }

        .history-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-btn:hover:not(:disabled) {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .history-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Guideline Checker Panel */
        .guideline-panel {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .guideline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .guideline-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .guideline-status.pass {
            color: var(--success);
        }

        .guideline-status.fail {
            color: var(--error);
        }

        .guideline-status.warning {
            color: var(--warning);
        }

        .guideline-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .guideline-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.625rem;
            background: var(--dark-surface);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .guideline-item i {
            margin-top: 2px;
        }

        .guideline-item.pass i { color: var(--success); }
        .guideline-item.fail i { color: var(--error); }
        .guideline-item.warning i { color: var(--warning); }

        .guideline-item-text {
            flex: 1;
        }

        .guideline-fix-btn {
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .guideline-fix-btn:hover {
            background: var(--primary-dark);
        }

        /* Export Panel */
        .export-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 1.5rem;
            width: 400px;
            max-width: 90vw;
            z-index: 2000;
            display: none;
        }

        .export-panel.active {
            display: block;
        }

        .export-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .export-panel-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .export-formats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .export-format {
            padding: 1rem;
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-format:hover {
            border-color: var(--primary);
        }

        .export-format.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .export-format i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .export-format-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .export-sizes {
            margin-bottom: 1.5rem;
        }

        .export-sizes-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .export-size-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .export-size-option {
            padding: 0.5rem 0.75rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-size-option:hover {
            border-color: var(--primary);
        }

        .export-size-option.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .export-quality {
            margin-bottom: 1.5rem;
        }

        .export-actions {
            display: flex;
            gap: 0.75rem;
        }

        .export-action-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-action-btn.primary {
            background: var(--gradient-1);
            border: none;
            color: white;
        }

        .export-action-btn.secondary {
            background: transparent;
            border: 1px solid var(--dark-border);
            color: var(--text-secondary);
        }

        /* AI Suggestions Panel */
        .ai-suggestions-box {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .ai-suggestions-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-suggestions-title i {
            color: var(--primary);
        }

        .ai-headline-suggestions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ai-headline-item {
            padding: 0.625rem;
            background: var(--dark-surface);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-headline-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-light);
        }

        /* Extracted Colors */
        .extracted-colors {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .extracted-color {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .extracted-color:hover {
            transform: scale(1.15);
        }

        /* Remove Template Button */
        .remove-template-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .remove-template-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .remove-template-btn:active {
            transform: translateY(0);
        }
        
        .remove-template-btn i {
            font-size: 1rem;
        }

        /* Demo Tour Styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .tour-overlay.active {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        .tour-spotlight {
            position: fixed;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85);
            z-index: 10000;
            pointer-events: none;
            transition: all 0.4s ease;
            border: 3px solid #6366f1;
            background: transparent;
        }

        .tour-card {
            position: fixed;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            z-index: 10001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: tourCardPop 0.3s ease;
            pointer-events: auto;
        }

        @keyframes tourCardPop {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .tour-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .tour-step-badge {
            width: 32px;
            height: 32px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .tour-card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .tour-card-content {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1.25rem;
        }

        .tour-shortcut {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin: 0.25rem 0;
        }

        .tour-key {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--primary-light);
            min-width: 28px;
            text-align: center;
        }

        .tour-shortcut-desc {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        .tour-shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .tour-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tour-progress {
            display: flex;
            gap: 0.35rem;
        }

        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--dark-border);
            transition: all 0.2s;
        }

        .tour-dot.active {
            background: var(--primary);
            width: 20px;
            border-radius: 4px;
        }

        .tour-dot.completed {
            background: var(--success);
        }

        .tour-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .tour-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-btn-secondary {
            background: transparent;
            border: 1px solid var(--dark-border);
            color: var(--text-secondary);
        }

        .tour-btn-secondary:hover {
            background: var(--dark-card);
            color: var(--text-primary);
        }

        .tour-btn-primary {
            background: var(--primary);
            border: none;
            color: white;
        }

        .tour-btn-primary:hover {
            background: var(--primary-dark);
        }

        .tour-welcome {
            text-align: center;
            max-width: 500px;
        }

        .tour-welcome-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
        }

        .tour-welcome h2 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .tour-welcome p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .tour-skip-link {
            display: block;
            margin-top: 1rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tour-skip-link:hover {
            color: var(--text-primary);
        }

        .tour-feature-icon {
            width: 48px;
            height: 48px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Don't show again checkbox */
        .tour-dont-show {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--dark-border);
        }

        .tour-dont-show input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .tour-dont-show label {
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </a>
                <span class="project-name" id="projectName">New Creative</span>
                <select class="platform-select" id="platformSelect" onchange="changePlatform(this.value)" title="Select Platform">
                    <option value="amazon">Amazon</option>
                    <option value="flipkart">Flipkart</option>
                    <option value="dmart">DMart</option>
                    <option value="tesco">Tesco</option>
                    <option value="general">General</option>
                </select>
            </div>
            <div class="header-center">
                <div class="tool-group">
                    <button class="tool-btn active" data-tool="select" title="Select (V)">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                    <button class="tool-btn" data-tool="move" title="Move (M)">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                </div>
                <div class="tool-divider"></div>
                <div class="tool-group">
                    <button class="tool-btn" data-tool="shape" title="Shape (S)">
                        <i class="fas fa-square"></i>
                    </button>
                    <button class="tool-btn" data-tool="image" title="Add Image (I)">
                        <i class="fas fa-image"></i>
                    </button>
                </div>
                <div class="tool-divider"></div>
                <div class="tool-group">
                    <button class="tool-btn" data-tool="eraser" title="Eraser (E)">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button class="tool-btn" data-tool="crop" title="Crop (C)">
                        <i class="fas fa-crop-alt"></i>
                    </button>
                </div>
                <div class="tool-divider"></div>
                <div class="tool-group">
                    <button class="tool-btn" onclick="openTemplatesPanel()" title="Templates">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="tool-btn" onclick="openResizePanel()" title="Resize Canvas">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="tool-btn" onclick="removeBackground()" title="Remove Background">
                        <i class="fas fa-magic"></i>
                    </button>
                </div>
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" onclick="undo()" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" onclick="redo()" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <button class="tool-btn" onclick="runGuidelineCheck()" title="Check Guidelines">
                    <i class="fas fa-check-double"></i>
                </button>
                <div class="compliance-indicator compliant" id="complianceStatus" onclick="openGuidelinePanel()">
                    <i class="fas fa-check-circle"></i>
                    <span>Compliant</span>
                </div>
                <button class="export-btn" onclick="openExportPanel()">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
        </header>

        <!-- Left Sidebar - Layers -->
        <aside class="sidebar-left" id="layersSidebar">
            <div class="sidebar-header" onclick="toggleLayersSidebar()">
                <i class="fas fa-layer-group"></i>
                <span>Layers</span>
                <i class="fas fa-chevron-left toggle-icon"></i>
            </div>
            <div class="layers-list" id="layersList">
                <!-- Layers populated dynamically -->
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-area">
            <div class="canvas-container" id="canvasContainer">
                <canvas id="mainCanvas" width="1200" height="628"></canvas>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
                <span class="zoom-value" id="zoomValue">100%</span>
                <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
                <button class="zoom-btn" onclick="zoomReset()"><i class="fas fa-expand"></i></button>
            </div>
        </main>

        <!-- Right Sidebar - Properties & AI -->
        <aside class="sidebar-right" id="propertiesSidebar">
            <button class="sidebar-toggle" onclick="togglePropertiesSidebar()">
                <i class="fas fa-chevron-right toggle-icon"></i>
            </button>
            <div class="tabs">
                <button class="tab active" data-tab="ai">
                    <i class="fas fa-robot"></i> <span>AI</span>
                </button>
                <button class="tab" data-tab="elements">
                    <i class="fas fa-shapes"></i> <span>Elements</span>
                </button>
                <button class="tab" data-tab="properties">
                    <i class="fas fa-sliders-h"></i> <span>Props</span>
                </button>
            </div>

            <!-- AI Chat Tab -->
            <div class="tab-content active" id="aiTab">
                <div class="ai-chat">
                    <!-- Language Toggle -->
                    <div id="aiLanguageToggle"></div>
                    
                    <!-- Undo/Redo Version Controls -->
                    <div class="version-controls">
                        <button class="version-btn" onclick="aiAgent?.undo()" title="Undo (Ctrl+Z)">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        <button class="version-btn" onclick="aiAgent?.redo()" title="Redo (Ctrl+Y)">
                            <i class="fas fa-redo"></i> Redo
                        </button>
                    </div>
                    
                    <!-- AI Suggestions Panel -->
                    <div id="aiSuggestionsPanel" class="collapsible-section collapsed">
                        <div class="section-header" onclick="toggleSection('aiSuggestionsPanel')">
                            <span> AI Suggestions</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="section-content"></div>
                    </div>
                    
                    <!-- Festival Presets -->
                    <div id="aiFestivalPresets" class="collapsible-section collapsed">
                        <div class="section-header" onclick="toggleSection('aiFestivalPresets')">
                            <span> Festival Themes</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="section-content"></div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="ai-quick-actions">
                        <button class="quick-action-btn" onclick="aiAgent?.getSuggestions()">
                            <i class="fas fa-lightbulb"></i> Suggest
                        </button>
                        <button class="quick-action-btn" onclick="aiAgent?.generateABVariants()">
                            <i class="fas fa-flask"></i> A/B Test
                        </button>
                        <button class="quick-action-btn" onclick="aiAgent?.localizeContent()">
                            <i class="fas fa-globe"></i> Localize
                        </button>
                        <button class="quick-action-btn" onclick="aiAgent?.optimizeCTA()">
                            <i class="fas fa-bullseye"></i> CTA
                        </button>
                        <button class="quick-action-btn" onclick="aiAgent?.getLayoutSuggestions()">
                            <i class="fas fa-th-large"></i> Layout
                        </button>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="ai-messages" id="aiMessages">
                        <div class="ai-message assistant">
                            <div class="ai-message-content">
                                 Hi! I'm your AI creative assistant for Indian e-commerce banners.
                            </div>
                            <div class="ai-suggestions">
                                <span class="ai-suggestion" onclick="sendAICommand('make the headline bigger and bolder')">Bigger headline</span>
                                <span class="ai-suggestion" onclick="sendAICommand('translate to Hindi')">Translate to Hindi</span>
                                <span class="ai-suggestion" onclick="sendAICommand('apply Diwali theme')">Diwali theme</span>
                                <span class="ai-suggestion" onclick="sendAICommand('optimize CTA for conversions')">Optimize CTA</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="ai-input-area">
                        <div class="ai-input-wrapper">
                            <textarea 
                                class="ai-input" 
                                id="aiInput" 
                                placeholder="Tell me what to change... (e.g., 'make headline red', 'translate to Telugu')"
                                rows="2"
                            ></textarea>
                            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAICommand()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Elements Tab -->
            <div class="tab-content" id="elementsTab">
                <div class="effects-section">
                    <div class="effects-title">Text Presets</div>
                    <div class="text-presets-grid">
                        <div class="text-preset" onclick="addTextPreset('headline')">
                            <div class="text-preset-preview" style="--preset-size: 24px; --preset-weight: 700;">Headline</div>
                            <div class="text-preset-name">Bold Headline</div>
                        </div>
                        <div class="text-preset" onclick="addTextPreset('subheadline')">
                            <div class="text-preset-preview" style="--preset-size: 18px; --preset-weight: 500;">Subheading</div>
                            <div class="text-preset-name">Subheading</div>
                        </div>
                        <div class="text-preset" onclick="addTextPreset('body')">
                            <div class="text-preset-preview" style="--preset-size: 14px; --preset-weight: 400;">Body Text</div>
                            <div class="text-preset-name">Body Text</div>
                        </div>
                        <div class="text-preset" onclick="addTextPreset('price')">
                            <div class="text-preset-preview" style="--preset-size: 28px; --preset-weight: 800; --preset-color: #10b981;">999</div>
                            <div class="text-preset-name">Price Tag</div>
                        </div>
                        <div class="text-preset" onclick="addTextPreset('discount')">
                            <div class="text-preset-preview" style="--preset-size: 22px; --preset-weight: 700; --preset-color: #ef4444;">50% OFF</div>
                            <div class="text-preset-name">Discount Badge</div>
                        </div>
                        <div class="text-preset" onclick="addTextPreset('label')">
                            <div class="text-preset-preview" style="--preset-size: 12px; --preset-weight: 500; --preset-color: #94a3b8;">LABEL</div>
                            <div class="text-preset-name">Small Label</div>
                        </div>
                    </div>
                </div>

                <div class="effects-section">
                    <div class="effects-title">Quick Shapes</div>
                    <div class="effects-grid">
                        <button class="effect-btn" onclick="addQuickShape('rectangle')">
                            <i class="fas fa-square"></i>
                            <span>Rectangle</span>
                        </button>
                        <button class="effect-btn" onclick="addQuickShape('roundedRect')">
                            <i class="fas fa-square" style="border-radius: 4px;"></i>
                            <span>Rounded</span>
                        </button>
                        <button class="effect-btn" onclick="addQuickShape('button')">
                            <i class="fas fa-hand-pointer"></i>
                            <span>Button</span>
                        </button>
                        <button class="effect-btn" onclick="addQuickShape('badge')">
                            <i class="fas fa-certificate"></i>
                            <span>Badge</span>
                        </button>
                    </div>
                </div>

                <div class="effects-section">
                    <div class="effects-title">Image Effects</div>
                    <div class="effects-grid">
                        <button class="effect-btn" onclick="openEffectsPanel()">
                            <i class="fas fa-sliders-h"></i>
                            <span>Adjust</span>
                        </button>
                        <button class="effect-btn" onclick="removeBackground()">
                            <i class="fas fa-magic"></i>
                            <span>Remove BG</span>
                        </button>
                        <button class="effect-btn" onclick="applyFilter('grayscale')">
                            <i class="fas fa-adjust"></i>
                            <span>B&W</span>
                        </button>
                        <button class="effect-btn" onclick="applyFilter('sepia')">
                            <i class="fas fa-sun"></i>
                            <span>Vintage</span>
                        </button>
                    </div>
                </div>

                <div class="effects-section">
                    <div class="effects-title">Color Palette</div>
                    <div class="color-palette" id="colorPalette">
                        <div class="palette-color" style="background: #6366f1;" onclick="setElementColor('#6366f1')"></div>
                        <div class="palette-color" style="background: #8b5cf6;" onclick="setElementColor('#8b5cf6')"></div>
                        <div class="palette-color" style="background: #ec4899;" onclick="setElementColor('#ec4899')"></div>
                        <div class="palette-color" style="background: #ef4444;" onclick="setElementColor('#ef4444')"></div>
                        <div class="palette-color" style="background: #f97316;" onclick="setElementColor('#f97316')"></div>
                        <div class="palette-color" style="background: #fbbf24;" onclick="setElementColor('#fbbf24')"></div>
                        <div class="palette-color" style="background: #10b981;" onclick="setElementColor('#10b981')"></div>
                        <div class="palette-color" style="background: #06b6d4;" onclick="setElementColor('#06b6d4')"></div>
                        <div class="palette-color" style="background: #3b82f6;" onclick="setElementColor('#3b82f6')"></div>
                        <div class="palette-color" style="background: #ffffff;" onclick="setElementColor('#ffffff')"></div>
                        <div class="palette-color" style="background: #000000;" onclick="setElementColor('#000000')"></div>
                        <div class="palette-color" style="background: #64748b;" onclick="setElementColor('#64748b')"></div>
                    </div>
                </div>

                <!-- Tesco Elements Section -->
                <div class="effects-section" id="tescoElementsSection" style="display: none;">
                    <div class="effects-title">
                        <i class="fas fa-shopping-cart" style="color: #0050AA; margin-right: 0.5rem;"></i>
                        Tesco Elements
                    </div>
                    
                    <!-- Tesco Value Tiles -->
                    <div class="subsection-title" style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase;">Value Tiles</div>
                    <div class="text-presets-grid">
                        <div class="text-preset" onclick="addTescoValueTile('new')">
                            <div class="text-preset-preview" style="--preset-size: 16px; --preset-weight: 700; --preset-color: #0050AA; background: #ffffff; padding: 8px; border-radius: 4px;">NEW</div>
                            <div class="text-preset-name">New Tile</div>
                        </div>
                        <div class="text-preset" onclick="addTescoValueTile('white')">
                            <div class="text-preset-preview" style="--preset-size: 18px; --preset-weight: 700; --preset-color: #0050AA; background: #ffffff; padding: 8px; border-radius: 4px;">9.99</div>
                            <div class="text-preset-name">Price Tile</div>
                        </div>
                        <div class="text-preset" onclick="addTescoValueTile('clubcard')">
                            <div class="text-preset-preview" style="--preset-size: 14px; --preset-weight: 700; --preset-color: #ffffff; background: #0050AA; padding: 8px; border-radius: 4px;">7.99<br><span style="font-size: 10px;">Clubcard</span></div>
                            <div class="text-preset-name">Clubcard Tile</div>
                        </div>
                    </div>

                    <!-- Tesco Tags -->
                    <div class="subsection-title" style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase;">Tesco Tags</div>
                    <div class="effects-grid">
                        <button class="effect-btn" onclick="addTescoTag('only')">
                            <i class="fas fa-star"></i>
                            <span>Only at Tesco</span>
                        </button>
                        <button class="effect-btn" onclick="addTescoTag('available')">
                            <i class="fas fa-shopping-bag"></i>
                            <span>Available</span>
                        </button>
                        <button class="effect-btn" onclick="addTescoTag('selected')">
                            <i class="fas fa-store"></i>
                            <span>Selected Stores</span>
                        </button>
                        <button class="effect-btn" onclick="addTescoTag('clubcard')">
                            <i class="fas fa-credit-card"></i>
                            <span>Clubcard</span>
                        </button>
                    </div>

                    <!-- Tesco Brand Colors -->
                    <div class="subsection-title" style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase;">Tesco Brand Colors</div>
                    <div class="color-palette">
                        <div class="palette-color" style="background: #0050AA;" onclick="setElementColor('#0050AA')" title="Tesco Blue"></div>
                        <div class="palette-color" style="background: #EE1C2E;" onclick="setElementColor('#EE1C2E')" title="Tesco Red"></div>
                        <div class="palette-color" style="background: #FFFFFF; border: 1px solid var(--dark-border);" onclick="setElementColor('#FFFFFF')" title="White"></div>
                        <div class="palette-color" style="background: #000000;" onclick="setElementColor('#000000')" title="Black"></div>
                    </div>

                    <!-- Drinkaware -->
                    <div class="subsection-title" style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 0.5rem; text-transform: uppercase;">Compliance</div>
                    <button class="effect-btn" onclick="addDrinkawareLogo()" style="width: 100%;">
                        <i class="fas fa-glass-martini-alt"></i>
                        <span>Add Drinkaware Logo</span>
                    </button>
                </div>
            </div>

            <!-- Properties Tab -->
            <div class="tab-content" id="propertiesTab">
                <div id="noSelection" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="fas fa-mouse-pointer" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Select an element to edit its properties
                </div>
                
                <div id="elementProperties" style="display: none;">
                    <div class="property-group">
                        <div class="property-group-title">Position</div>
                        <div class="property-row">
                            <span class="property-label">X</span>
                            <input type="number" class="property-input property-input-small" id="propX" onchange="updateElementProperty('x', this.value)">
                            <span class="property-label">Y</span>
                            <input type="number" class="property-input property-input-small" id="propY" onchange="updateElementProperty('y', this.value)">
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <div class="property-group-title">Size</div>
                        <div class="property-row">
                            <span class="property-label">W</span>
                            <input type="number" class="property-input property-input-small" id="propW" onchange="updateElementProperty('width', this.value)">
                            <span class="property-label">H</span>
                            <input type="number" class="property-input property-input-small" id="propH" onchange="updateElementProperty('height', this.value)">
                        </div>
                    </div>
                    
                    <div class="property-group" id="textProperties">
                        <div class="property-group-title">Text</div>
                        <div class="property-row">
                            <span class="property-label">Content</span>
                            <input type="text" class="property-input" id="propText" onchange="updateElementProperty('text', this.value)">
                        </div>
                        <div class="property-row">
                            <span class="property-label">Size</span>
                            <input type="number" class="property-input property-input-small" id="propFontSize" onchange="updateElementProperty('fontSize', this.value)">
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <div class="property-group-title">Style</div>
                        <div class="property-row">
                            <span class="property-label">Color</span>
                            <div class="color-picker-wrapper">
                                <div class="color-preview" id="colorPreview" style="background: #ffffff;"></div>
                                <input type="color" class="color-input" id="propColor" onchange="updateElementProperty('color', this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-action" onclick="duplicateElement()">
                            <i class="fas fa-copy"></i> Duplicate
                        </button>
                        <button class="quick-action" onclick="deleteElement()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="quick-action" onclick="bringToFront()">
                            <i class="fas fa-arrow-up"></i> To Front
                        </button>
                        <button class="quick-action" onclick="sendToBack()">
                            <i class="fas fa-arrow-down"></i> To Back
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Hidden file input for image upload -->
    <input type="file" id="imageUploadInput" accept="image/*" onchange="handleImageUpload(event)">

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
        <div class="modal-panel">
            <div class="modal-header">
                <h2 class="modal-title">Template Library</h2>
                <button class="modal-close" onclick="closeTemplatesPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="category-filters" style="flex-wrap: wrap; gap: 0.5rem;">
                        <button class="category-filter active" data-category="all">All</button>
                        <button class="category-filter" data-category="ecommerce">E-commerce</button>
                        <button class="category-filter" data-category="social">Social Media</button>
                        <button class="category-filter" data-category="sale">Sale/Promo</button>
                        <button class="category-filter" data-category="product">Product</button>
                        <button class="category-filter" data-category="business">Business</button>
                        <button class="category-filter" data-category="fashion">Fashion</button>
                        <button class="category-filter" data-category="food">Food</button>
                        <button class="category-filter" data-category="realestate">Real Estate</button>
                        <button class="category-filter" data-category="education">Education</button>
                        <button class="category-filter" data-category="healthcare">Healthcare</button>
                    </div>
                    <button class="remove-template-btn" onclick="removeTemplate()" id="removeTemplateBtn" 
                            style="display: none;">
                        <i class="fas fa-undo-alt"></i> Remove Template
                    </button>
                </div>
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Resize Modal -->
    <div class="modal-overlay" id="resizeModal">
        <div class="modal-panel">
            <div class="modal-header">
                <h2 class="modal-title">Resize Canvas</h2>
                <button class="modal-close" onclick="closeResizePanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="resize-options" id="resizeOptions">
                    <!-- Resize options populated dynamically -->
                </div>
                <div class="custom-size-form">
                    <div class="size-input-group">
                        <label>Width (px)</label>
                        <input type="number" id="customWidth" value="1200">
                    </div>
                    <div class="size-input-group">
                        <label>Height (px)</label>
                        <input type="number" id="customHeight" value="628">
                    </div>
                    <button class="apply-btn" onclick="applyCustomSize()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Effects Modal -->
    <div class="modal-overlay" id="effectsModal">
        <div class="modal-panel">
            <div class="modal-header">
                <h2 class="modal-title">Image Effects</h2>
                <button class="modal-close" onclick="closeEffectsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="effects-section">
                    <div class="effects-title">Quick Effects</div>
                    <div class="effects-grid">
                        <button class="effect-btn" onclick="applyEffect('grayscale')">
                            <i class="fas fa-adjust"></i>
                            <span>Grayscale</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('sepia')">
                            <i class="fas fa-sun"></i>
                            <span>Sepia</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('invert')">
                            <i class="fas fa-circle-half-stroke"></i>
                            <span>Invert</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('blur')">
                            <i class="fas fa-droplet"></i>
                            <span>Blur</span>
                        </button>
                    </div>
                </div>
                <div class="effects-section">
                    <div class="effects-title">Adjustments</div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Brightness</span>
                            <span id="brightnessValue">100%</span>
                        </div>
                        <input type="range" class="effect-slider" id="brightnessSlider" min="0" max="200" value="100" oninput="updateEffect('brightness', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Contrast</span>
                            <span id="contrastValue">100%</span>
                        </div>
                        <input type="range" class="effect-slider" id="contrastSlider" min="0" max="200" value="100" oninput="updateEffect('contrast', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Saturation</span>
                            <span id="saturationValue">100%</span>
                        </div>
                        <input type="range" class="effect-slider" id="saturationSlider" min="0" max="200" value="100" oninput="updateEffect('saturation', this.value)">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Opacity</span>
                            <span id="opacityValue">100%</span>
                        </div>
                        <input type="range" class="effect-slider" id="opacitySlider" min="0" max="100" value="100" oninput="updateEffect('opacity', this.value)">
                    </div>
                </div>
                <button class="apply-btn" style="width: 100%; margin-top: 1rem;" onclick="resetEffects()">
                    <i class="fas fa-undo"></i> Reset All Effects
                </button>
            </div>
        </div>
    </div>

    <!-- Text Presets Panel (inline in sidebar) -->



    <!-- Guideline Checker Modal -->
    <div class="modal-overlay" id="guidelineModal">
        <div class="modal-panel" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Guideline Checker</h2>
                <button class="modal-close" onclick="closeGuidelinePanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="guideline-panel" style="margin-bottom: 0; border: none; padding: 0;">
                    <div class="guideline-header">
                        <div class="guideline-status pass" id="guidelineOverallStatus">
                            <i class="fas fa-check-circle"></i>
                            <span>All Checks Passed</span>
                        </div>
                        <button class="brand-kit-btn" onclick="runGuidelineCheck()">
                            <i class="fas fa-sync"></i> Re-check
                        </button>
                    </div>
                    <div class="guideline-list" id="guidelineResults">
                        <div class="guideline-item pass">
                            <i class="fas fa-check"></i>
                            <span class="guideline-item-text">Canvas dimensions match platform requirements</span>
                        </div>
                        <div class="guideline-item pass">
                            <i class="fas fa-check"></i>
                            <span class="guideline-item-text">Text is within safe zone</span>
                        </div>
                        <div class="guideline-item pass">
                            <i class="fas fa-check"></i>
                            <span class="guideline-item-text">Minimum font size met (12px)</span>
                        </div>
                        <div class="guideline-item pass">
                            <i class="fas fa-check"></i>
                            <span class="guideline-item-text">Color contrast ratio meets WCAG AA</span>
                        </div>
                    </div>
                </div>
                <button class="apply-btn" style="width: 100%; margin-top: 1.5rem;" onclick="autoFixAll()">
                    <i class="fas fa-magic"></i> Auto-Fix All Issues
                </button>
            </div>
        </div>
    </div>

    <!-- Export Panel -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-panel" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Export Creative</h2>
                <button class="modal-close" onclick="closeExportPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-formats">
                    <div class="export-format selected" data-format="png" onclick="selectExportFormat('png')">
                        <i class="fas fa-image"></i>
                        <div class="export-format-name">PNG</div>
                    </div>
                    <div class="export-format" data-format="jpg" onclick="selectExportFormat('jpg')">
                        <i class="fas fa-file-image"></i>
                        <div class="export-format-name">JPG</div>
                    </div>
                    <div class="export-format" data-format="webp" onclick="selectExportFormat('webp')">
                        <i class="fas fa-globe"></i>
                        <div class="export-format-name">WebP</div>
                    </div>
                </div>
                
                <div class="export-sizes">
                    <div class="export-sizes-title">Export Sizes</div>
                    <div class="export-size-options">
                        <div class="export-size-option selected" data-scale="1" onclick="selectExportScale(1)">1x</div>
                        <div class="export-size-option" data-scale="2" onclick="selectExportScale(2)">2x</div>
                        <div class="export-size-option" data-scale="3" onclick="selectExportScale(3)">3x</div>
                    </div>
                </div>
                
                <div class="export-quality">
                    <div class="slider-label">
                        <span>Quality</span>
                        <span id="exportQualityValue">90%</span>
                    </div>
                    <input type="range" class="effect-slider" id="exportQualitySlider" min="50" max="100" value="90" oninput="document.getElementById('exportQualityValue').textContent = this.value + '%'">
                </div>
                
                <div class="export-sizes" style="margin-bottom: 1rem;">
                    <div class="export-sizes-title">Quick Export All Platforms</div>
                    <div class="export-size-options">
                        <div class="export-size-option" onclick="exportAllPlatforms()">
                            <i class="fas fa-download"></i> Export All Sizes
                        </div>
                    </div>
                </div>
                
                <div class="export-actions">
                    <button class="export-action-btn secondary" onclick="closeExportPanel()">Cancel</button>
                    <button class="export-action-btn primary" onclick="doExport()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Tour -->
    <div class="tour-overlay" id="tourOverlay">
        <!-- Tour content injected dynamically -->
    </div>
    <div id="tourSpotlight" class="tour-spotlight" style="display: none;"></div>
    <div id="tourCard" class="tour-card" style="display: none;"></div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Backend API base URL - Change this if backend runs on different port
        const API_BASE = 'http://localhost:8000';
        
        // State
        let canvasState = {
            elements: [],
            background: { type: 'gradient', colors: ['#1a1a2e', '#6366f1'] },
            dimensions: { width: 1200, height: 628 }
        };
        let selectedElement = null;
        let zoom = 1;
        let platform = 'amazon';
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let aiConversation = [];
        let layersSidebarCollapsed = false;
        let propertiesSidebarCollapsed = false;
        
        // Tool state
        let currentTool = 'select';
        let isDrawing = false;
        let drawStart = { x: 0, y: 0 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let canvasOffset = { x: 0, y: 0 };

        // Toggle layers sidebar (left)
        function toggleLayersSidebar() {
            const sidebar = document.getElementById('layersSidebar');
            layersSidebarCollapsed = !layersSidebarCollapsed;
            sidebar.classList.toggle('collapsed', layersSidebarCollapsed);
            localStorage.setItem('layersSidebarCollapsed', layersSidebarCollapsed);
        }

        // Toggle properties sidebar (right)
        function togglePropertiesSidebar() {
            const sidebar = document.getElementById('propertiesSidebar');
            propertiesSidebarCollapsed = !propertiesSidebarCollapsed;
            sidebar.classList.toggle('collapsed', propertiesSidebarCollapsed);
            localStorage.setItem('propertiesSidebarCollapsed', propertiesSidebarCollapsed);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Restore sidebar states
            layersSidebarCollapsed = localStorage.getItem('layersSidebarCollapsed') === 'true';
            propertiesSidebarCollapsed = localStorage.getItem('propertiesSidebarCollapsed') === 'true';
            
            if (layersSidebarCollapsed) {
                document.getElementById('layersSidebar').classList.add('collapsed');
            }
            if (propertiesSidebarCollapsed) {
                document.getElementById('propertiesSidebar').classList.add('collapsed');
            }
            
            loadCreativeData();  // Loads data but doesn't render yet
            setupCanvas();       // Sets up canvas with correct dimensions
            setupTools();        // Setup toolbar functionality
            renderCanvas();      // Now render with correct dimensions
            renderLayers();      // Update layers UI
            setupTabs();
            setupKeyboardShortcuts();
            setupAIInput();
            restoreCollapsedStates(); // Restore section collapse states
            initializePlatform();  // Initialize platform and show/hide relevant elements
        });

        // ============================================
        // PLATFORM MANAGEMENT
        // ============================================
        function initializePlatform() {
            const savedPlatform = localStorage.getItem('editPlatform') || 'amazon';
            const platformSelect = document.getElementById('platformSelect');
            if (platformSelect) {
                platformSelect.value = savedPlatform;
            }
            changePlatform(savedPlatform, false);
        }

        function changePlatform(newPlatform, showToast = true) {
            platform = newPlatform;
            localStorage.setItem('editPlatform', newPlatform);
            
            // Show/hide Tesco elements section
            toggleTescoElements(newPlatform === 'tesco');
            
            if (showToast) {
                showToast(`Switched to ${newPlatform.charAt(0).toUpperCase() + newPlatform.slice(1)} platform`, 'info');
            }
            
            // Update platform select if not already updated
            const platformSelect = document.getElementById('platformSelect');
            if (platformSelect && platformSelect.value !== newPlatform) {
                platformSelect.value = newPlatform;
            }
        }

        // ============================================
        // COLLAPSIBLE SECTIONS
        // ============================================
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = section.classList.contains('collapsed');
                localStorage.setItem(`${sectionId}_collapsed`, isCollapsed);
            }
        }

        // Restore collapsed states on load
        function restoreCollapsedStates() {
            ['aiSuggestionsPanel', 'aiFestivalPresets'].forEach(sectionId => {
                const isCollapsed = localStorage.getItem(`${sectionId}_collapsed`) === 'true';
                const section = document.getElementById(sectionId);
                if (section && isCollapsed) {
                    section.classList.add('collapsed');
                }
            });
        }

        function loadCreativeData() {
            const savedData = localStorage.getItem('editCreativeData');
            platform = localStorage.getItem('editPlatform') || 'amazon';
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    console.log('Loaded creative data:', data);
                    
                    // Convert layout to canvas elements
                    canvasState.background = data.background || { 
                        type: 'gradient', 
                        colors: data.style?.colors || ['#1a1a2e', '#6366f1'] 
                    };
                    
                    canvasState.dimensions = data.dimensions || { width: 1200, height: 628 };
                    
                    // Convert elements
                    canvasState.elements = [];
                    const elements = data.elements || {};
                    
                    Object.entries(elements).forEach(([key, el], index) => {
                        if (!el) return; // Skip null elements
                        
                        const content = typeof el === 'string' ? el : (el.content || el.text || '');
                        
                        // Handle both position formats: el.x/el.y or el.position.x/el.position.y
                        const posX = el.x !== undefined ? el.x : (el.position?.x || 100);
                        const posY = el.y !== undefined ? el.y : (el.position?.y || 100 + index * 80);
                        
                        canvasState.elements.push({
                            id: `el-${Date.now()}-${index}`,
                            type: key === 'cta' ? 'button' : (el.type === 'button' || el.type === 'badge' ? 'button' : 'text'),
                            name: key.charAt(0).toUpperCase() + key.slice(1),
                            text: content,
                            x: posX,
                            y: posY,
                            width: el.width || (key === 'headline' ? 600 : 200),
                            height: el.height || (key === 'cta' ? 50 : 60),
                            fontSize: el.fontSize || el.font_size || (key === 'headline' ? 48 : key === 'discount' ? 36 : 18),
                            color: el.color || '#ffffff',
                            backgroundColor: el.background || el.backgroundColor || el.background_color || (key === 'cta' ? '#6366f1' : null),
                            visible: true
                        });
                    });
                    
                    document.getElementById('projectName').textContent = `${platform.charAt(0).toUpperCase() + platform.slice(1)} Banner`;
                    
                } catch (e) {
                    console.error('Failed to load creative data:', e);
                    createDefaultElements();
                }
            } else {
                createDefaultElements();
            }
            // renderCanvas and renderLayers are called from DOMContentLoaded after setupCanvas
        }

        function createDefaultElements() {
            canvasState.elements = [
                {
                    id: 'el-headline',
                    type: 'text',
                    name: 'Headline',
                    text: 'Your Headline Here',
                    x: 300,
                    y: 150,
                    width: 600,
                    height: 60,
                    fontSize: 48,
                    color: '#ffffff',
                    visible: true
                },
                {
                    id: 'el-discount',
                    type: 'text',
                    name: 'Discount',
                    text: '50% OFF',
                    x: 500,
                    y: 280,
                    width: 200,
                    height: 50,
                    fontSize: 36,
                    color: '#10b981',
                    visible: true
                },
                {
                    id: 'el-cta',
                    type: 'button',
                    name: 'CTA Button',
                    text: 'Shop Now',
                    x: 500,
                    y: 450,
                    width: 200,
                    height: 50,
                    fontSize: 18,
                    color: '#ffffff',
                    backgroundColor: '#6366f1',
                    visible: true
                }
            ];
        }

        function setupCanvas() {
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvasState.dimensions.width;
            canvas.height = canvasState.dimensions.height;
            
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            canvas.addEventListener('dblclick', handleCanvasDoubleClick);
        }

        // Setup toolbar functionality
        // Note: setupTools() function is defined later (line ~6042) with enhanced functionality

        // Handle double click for text editing
        function handleCanvasDoubleClick(e) {
            if (currentTool !== 'select' && currentTool !== 'text') return;
            
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom;
            const y = (e.clientY - rect.top) / zoom;
            
            // Find clicked element
            const clicked = [...canvasState.elements].reverse().find(el => {
                return el.visible && 
                       x >= el.x && x <= el.x + el.width &&
                       y >= el.y && y <= el.y + el.height;
            });
            
            if (clicked && (clicked.type === 'text' || clicked.type === 'button')) {
                editTextElement(clicked);
            }
        }

        // Edit text element inline
        function editTextElement(element) {
            const newText = prompt('Edit text:', element.text);
            if (newText !== null) {
                element.text = newText;
                renderCanvas();
                renderLayers();
                showToast('Text updated', 'success');
            }
        }

        function handleCanvasClick(e) {
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom;
            const y = (e.clientY - rect.top) / zoom;
            
            switch(currentTool) {
                case 'select':
                case 'move':
                    // Find clicked element
                    const clicked = [...canvasState.elements].reverse().find(el => {
                        return el.visible && 
                               x >= el.x && x <= el.x + el.width &&
                               y >= el.y && y <= el.y + el.height;
                    });
                    selectElement(clicked);
                    break;
                    
                case 'eraser':
                    // Find and delete clicked element
                    const elementToErase = [...canvasState.elements].reverse().find(el => {
                        return el.visible && 
                               x >= el.x && x <= el.x + el.width &&
                               y >= el.y && y <= el.y + el.height;
                    });
                    
                    if (elementToErase) {
                        if (elementToErase.locked) {
                            showToast('Cannot erase locked element', 'warning');
                        } else {
                            // Save to history before deleting
                            saveToHistory({ action: 'Move Element', elementId: elementToMove.id });
                            // Remove element
                            const index = canvasState.elements.findIndex(el => el.id === elementToErase.id);
                            if (index > -1) {
                                canvasState.elements.splice(index, 1);
                                if (selectedElement && selectedElement.id === elementToErase.id) {
                                    selectElement(null);
                                }
                                renderCanvas();
                                renderLayers();
                                showToast('Element erased', 'success');
                            }
                        }
                    }
                    break;
                    
                case 'text':
                    // Check if clicking on existing text
                    const existingText = [...canvasState.elements].reverse().find(el => {
                        return el.visible && el.type === 'text' &&
                               x >= el.x && x <= el.x + el.width &&
                               y >= el.y && y <= el.y + el.height;
                    });
                    
                    if (existingText) {
                        selectElement(existingText);
                    } else {
                        // Create new text element
                        addTextElement(x, y);
                    }
                    break;
                    
                case 'shape':
                    // Create new shape at click position
                    addShapeElement(x, y);
                    break;
            }
        }

        // Add new text element
        function addTextElement(x, y) {
            const text = prompt('Enter text:', 'New Text');
            if (text) {
                const newElement = {
                    id: `el-${Date.now()}`,
                    type: 'text',
                    name: `Text ${canvasState.elements.length + 1}`,
                    text: text,
                    x: Math.round(x - 100),
                    y: Math.round(y - 20),
                    width: 200,
                    height: 40,
                    fontSize: 24,
                    color: '#ffffff',
                    visible: true
                };
                canvasState.elements.push(newElement);
                selectElement(newElement);
                renderCanvas();
                renderLayers();
                showToast('Text added', 'success');
            }
        }

        // Add new shape element
        function addShapeElement(x, y) {
            const newElement = {
                id: `el-${Date.now()}`,
                type: 'button',
                name: `Shape ${canvasState.elements.length + 1}`,
                text: '',
                x: Math.round(x - 50),
                y: Math.round(y - 25),
                width: 100,
                height: 50,
                fontSize: 16,
                color: '#ffffff',
                backgroundColor: '#6366f1',
                visible: true
            };
            canvasState.elements.push(newElement);
            selectElement(newElement);
            renderCanvas();
            renderLayers();
            showToast('Shape added', 'success');
        }

        function handleMouseDown(e) {
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom;
            const y = (e.clientY - rect.top) / zoom;
            
            switch(currentTool) {
                case 'select':
                    // Only drag if element selected and clicked on it
                    if (!selectedElement) return;
                    if (x >= selectedElement.x && x <= selectedElement.x + selectedElement.width &&
                        y >= selectedElement.y && y <= selectedElement.y + selectedElement.height) {
                        isDragging = true;
                        dragStart = { x: x - selectedElement.x, y: y - selectedElement.y };
                    }
                    break;
                    
                case 'move':
                    // Move tool - drag any element under cursor
                    const elementToMove = [...canvasState.elements].reverse().find(el => {
                        return el.visible && 
                               x >= el.x && x <= el.x + el.width &&
                               y >= el.y && y <= el.y + el.height;
                    });
                    if (elementToMove) {
                        selectElement(elementToMove);
                        isDragging = true;
                        dragStart = { x: x - elementToMove.x, y: y - elementToMove.y };
                    }
                    break;
                    
                case 'shape':
                    // Start drawing shape
                    isDrawing = true;
                    drawStart = { x, y };
                    break;
                    
                case 'crop':
                    // Find any element under cursor to crop (images, shapes, buttons)
                    const elementToCrop = [...canvasState.elements].reverse().find(el => {
                        return el.visible && (el.type === 'image' || el.type === 'button') &&
                               x >= el.x && x <= el.x + el.width &&
                               y >= el.y && y <= el.y + el.height;
                    });
                    
                    if (elementToCrop) {
                        selectElement(elementToCrop);
                        cropTargetElement = elementToCrop;
                        isDrawing = true;
                        drawStart = { x, y };
                    } else {
                        showToast('Click on an element to crop it', 'info');
                    }
                    break;
            }
        }

        // Store crop target
        let cropTargetElement = null;

        function handleMouseMove(e) {
            const rect = e.target.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom;
            const y = (e.clientY - rect.top) / zoom;
            
            // Handle element dragging
            if (isDragging && selectedElement) {
                selectedElement.x = Math.round(x - dragStart.x);
                selectedElement.y = Math.round(y - dragStart.y);
                
                // Snap to grid (optional, 10px grid)
                // selectedElement.x = Math.round(selectedElement.x / 10) * 10;
                // selectedElement.y = Math.round(selectedElement.y / 10) * 10;
                
                updatePropertyPanel();
                renderCanvas();
                return;
            }
            
            // Handle shape drawing preview
            if (isDrawing && currentTool === 'shape') {
                renderCanvas();
                
                // Draw preview rectangle
                const canvas = document.getElementById('mainCanvas');
                const ctx = canvas.getContext('2d');
                
                const width = x - drawStart.x;
                const height = y - drawStart.y;
                
                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(drawStart.x, drawStart.y, width, height);
                ctx.setLineDash([]);
            }
            
            // Handle crop area preview
            if (isDrawing && currentTool === 'crop' && cropTargetElement) {
                renderCanvas();
                
                const canvas = document.getElementById('mainCanvas');
                const ctx = canvas.getContext('2d');
                const el = cropTargetElement;
                
                // Constrain crop to image bounds
                const cropX = Math.max(el.x, Math.min(drawStart.x, x));
                const cropY = Math.max(el.y, Math.min(drawStart.y, y));
                const cropEndX = Math.min(el.x + el.width, Math.max(drawStart.x, x));
                const cropEndY = Math.min(el.y + el.height, Math.max(drawStart.y, y));
                const cropWidth = cropEndX - cropX;
                const cropHeight = cropEndY - cropY;
                
                // Darken areas outside crop on the image
                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                // Top
                ctx.fillRect(el.x, el.y, el.width, cropY - el.y);
                // Bottom
                ctx.fillRect(el.x, cropEndY, el.width, el.y + el.height - cropEndY);
                // Left
                ctx.fillRect(el.x, cropY, cropX - el.x, cropHeight);
                // Right
                ctx.fillRect(cropEndX, cropY, el.x + el.width - cropEndX, cropHeight);
                
                // Draw crop border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(cropX, cropY, cropWidth, cropHeight);
                
                // Draw corner handles
                const hs = 10;
                ctx.fillStyle = '#ffffff';
                // Corners
                ctx.fillRect(cropX - 2, cropY - 2, hs, 3);
                ctx.fillRect(cropX - 2, cropY - 2, 3, hs);
                ctx.fillRect(cropEndX - hs + 2, cropY - 2, hs, 3);
                ctx.fillRect(cropEndX - 1, cropY - 2, 3, hs);
                ctx.fillRect(cropX - 2, cropEndY - 1, hs, 3);
                ctx.fillRect(cropX - 2, cropEndY - hs + 2, 3, hs);
                ctx.fillRect(cropEndX - hs + 2, cropEndY - 1, hs, 3);
                ctx.fillRect(cropEndX - 1, cropEndY - hs + 2, 3, hs);
                
                // Draw size indicator
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                const labelW = 90;
                const labelH = 24;
                ctx.fillRect(cropX + cropWidth/2 - labelW/2, cropY + cropHeight/2 - labelH/2, labelW, labelH);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${Math.round(cropWidth)}  ${Math.round(cropHeight)}`, cropX + cropWidth/2, cropY + cropHeight/2 + 4);
                ctx.textAlign = 'left';
            }
        }

        function handleMouseUp(e) {
            // Finalize shape drawing
            if (isDrawing && currentTool === 'shape' && e) {
                const rect = e.target.getBoundingClientRect();
                const x = (e.clientX - rect.left) / zoom;
                const y = (e.clientY - rect.top) / zoom;
                
                const width = Math.abs(x - drawStart.x);
                const height = Math.abs(y - drawStart.y);
                
                // Only create shape if it has minimum size
                if (width > 20 && height > 20) {
                    const newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: `Shape ${canvasState.elements.length + 1}`,
                        text: '',
                        x: Math.round(Math.min(drawStart.x, x)),
                        y: Math.round(Math.min(drawStart.y, y)),
                        width: Math.round(width),
                        height: Math.round(height),
                        fontSize: 16,
                        color: '#ffffff',
                        backgroundColor: '#6366f1',
                        visible: true
                    };
                    canvasState.elements.push(newElement);
                    selectElement(newElement);
                    renderLayers();
                    showToast('Shape created', 'success');
                }
                
                renderCanvas();
            }
            
            // Finalize crop on image
            if (isDrawing && currentTool === 'crop' && cropTargetElement && e) {
                const rect = e.target.getBoundingClientRect();
                const x = (e.clientX - rect.left) / zoom;
                const y = (e.clientY - rect.top) / zoom;
                const el = cropTargetElement;
                
                // Calculate crop area constrained to image bounds
                const startX = Math.min(drawStart.x, x);
                const startY = Math.min(drawStart.y, y);
                const endX = Math.max(drawStart.x, x);
                const endY = Math.max(drawStart.y, y);
                
                // Clamp to image boundaries
                const cropX = Math.max(el.x, startX);
                const cropY = Math.max(el.y, startY);
                const cropEndX = Math.min(el.x + el.width, endX);
                const cropEndY = Math.min(el.y + el.height, endY);
                const cropWidth = cropEndX - cropX;
                const cropHeight = cropEndY - cropY;
                
                console.log('Crop:', { cropX, cropY, cropWidth, cropHeight, elX: el.x, elY: el.y, elW: el.width, elH: el.height });
                
                // Only crop if area is big enough
                if (cropWidth > 10 && cropHeight > 10) {
                    cropImage(el, cropX, cropY, cropWidth, cropHeight);
                } else {
                    renderCanvas();
                    showToast('Crop area too small', 'warning');
                }
                
                cropTargetElement = null;
            }
            
            isDragging = false;
            isDrawing = false;
        }
        
        // Crop any element (image, button, shape)
        function cropImage(element, cropX, cropY, cropWidth, cropHeight) {
            console.log('cropImage called:', { cropX, cropY, cropWidth, cropHeight });
            console.log('Element before crop:', { x: element.x, y: element.y, w: element.width, h: element.height });
            
            // Save to history before modifying
            saveToHistory({ action: 'crop', elementId: element.id });
            
            // For non-image elements (buttons, shapes), just resize them
            if (element.type !== 'image') {
                element.x = Math.round(cropX);
                element.y = Math.round(cropY);
                element.width = Math.round(cropWidth);
                element.height = Math.round(cropHeight);
                
                renderCanvas();
                renderLayers();
                updatePropertyPanel();
                saveToHistory({ action: 'crop_complete', elementId: element.id });
                showToast('Element resized successfully', 'success');
                return;
            }
            
            // For image elements, perform actual crop
            const relX = cropX - element.x;
            const relY = cropY - element.y;
            
            console.log('Relative crop position:', { relX, relY });
            
            // Store original values for rollback
            const originalX = element.x;
            const originalY = element.y;
            const originalWidth = element.width;
            const originalHeight = element.height;
            const originalSrc = element.src;
            
            const img = new Image();
            
            img.onload = function() {
                try {
                    // Calculate scale between display size and actual image size
                    const scaleX = img.naturalWidth / originalWidth;
                    const scaleY = img.naturalHeight / originalHeight;
                    
                    // Source coordinates in the original image
                    const srcX = relX * scaleX;
                    const srcY = relY * scaleY;
                    const srcWidth = cropWidth * scaleX;
                    const srcHeight = cropHeight * scaleY;
                    
                    // Create canvas at the cropped size (use display size, not scaled)
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = Math.round(cropWidth);
                    tempCanvas.height = Math.round(cropHeight);
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Draw the cropped portion
                    tempCtx.drawImage(
                        img,
                        srcX, srcY, srcWidth, srcHeight,  // Source rectangle
                        0, 0, cropWidth, cropHeight        // Destination rectangle
                    );
                    
                    // Get the cropped image data
                    const croppedDataUrl = tempCanvas.toDataURL('image/png');
                    
                    // Update element with cropped image
                    element.src = croppedDataUrl;
                    element.x = Math.round(cropX);
                    element.y = Math.round(cropY);
                    element.width = Math.round(cropWidth);
                    element.height = Math.round(cropHeight);
                    
                    // Clear image cache so it reloads with new cropped image
                    delete element._imageCache;
                    
                    renderCanvas();
                    renderLayers();
                    updatePropertyPanel();
                    saveToHistory({ action: 'crop_complete', elementId: element.id });
                    showToast('Image cropped successfully', 'success');
                } catch (err) {
                    console.error('Crop error:', err);
                    // Restore original on error
                    element.x = originalX;
                    element.y = originalY;
                    element.width = originalWidth;
                    element.height = originalHeight;
                    element.src = originalSrc;
                    renderCanvas();
                    showToast('Failed to crop image', 'error');
                }
            };
            
            img.onerror = function() {
                console.error('Image load error for crop');
                showToast('Failed to load image for cropping', 'error');
                renderCanvas();
            };
            
            // Handle both data URLs and regular URLs
            if (element.src.startsWith('data:')) {
                img.src = element.src;
            } else {
                img.crossOrigin = 'anonymous';
                img.src = element.src;
            }
        }

        function selectElement(element) {
            selectedElement = element;
            
            // Update layers UI
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.id === element?.id);
            });
            
            // Update properties panel
            updatePropertyPanel();
            renderCanvas();
        }

        function updatePropertyPanel() {
            const noSel = document.getElementById('noSelection');
            const props = document.getElementById('elementProperties');
            const textProps = document.getElementById('textProperties');
            
            if (selectedElement) {
                noSel.style.display = 'none';
                props.style.display = 'block';
                
                document.getElementById('propX').value = selectedElement.x;
                document.getElementById('propY').value = selectedElement.y;
                document.getElementById('propW').value = selectedElement.width;
                document.getElementById('propH').value = selectedElement.height;
                
                if (selectedElement.type === 'text' || selectedElement.type === 'button') {
                    textProps.style.display = 'block';
                    document.getElementById('propText').value = selectedElement.text || '';
                    document.getElementById('propFontSize').value = selectedElement.fontSize || 16;
                } else {
                    textProps.style.display = 'none';
                }
                
                const color = selectedElement.color || '#ffffff';
                document.getElementById('propColor').value = color;
                document.getElementById('colorPreview').style.background = color;
            } else {
                noSel.style.display = 'block';
                props.style.display = 'none';
            }
        }

        function updateElementProperty(prop, value) {
            if (!selectedElement) return;
            
            if (['x', 'y', 'width', 'height', 'fontSize'].includes(prop)) {
                selectedElement[prop] = parseInt(value);
            } else {
                selectedElement[prop] = value;
            }
            
            renderCanvas();
            renderLayers();
            
            // Update color preview
            if (prop === 'color') {
                document.getElementById('colorPreview').style.background = value;
            }
        }

        function renderCanvas() {
            const canvas = document.getElementById('mainCanvas');
            if (!canvas) {
                console.error('Canvas not found!');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Ensure canvas has correct dimensions
            if (canvas.width !== canvasState.dimensions.width || canvas.height !== canvasState.dimensions.height) {
                canvas.width = canvasState.dimensions.width;
                canvas.height = canvasState.dimensions.height;
                console.log('Set canvas dimensions:', canvas.width, 'x', canvas.height);
            }
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            console.log('Rendering canvas, background type:', canvasState.background.type);
            
            // Draw background
            if (canvasState.background.type === 'image' && canvasState.background.src) {
                // Load and draw image background
                if (!canvasState.backgroundImage || canvasState.backgroundImage.src !== canvasState.background.src) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        canvasState.backgroundImage = img;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        drawElements(ctx);
                    };
                    img.onerror = () => {
                        // Fallback to gradient
                        drawGradientBackground(ctx, canvas.width, canvas.height, ['#1a1a2e', '#6366f1']);
                        drawElements(ctx);
                    };
                    img.src = canvasState.background.src;
                    return; // Async load
                } else {
                    ctx.drawImage(canvasState.backgroundImage, 0, 0, canvas.width, canvas.height);
                }
            } else if (canvasState.background.type === 'gradient') {
                drawGradientBackground(ctx, canvas.width, canvas.height, canvasState.background.colors || ['#1a1a2e', '#6366f1']);
            } else {
                ctx.fillStyle = canvasState.background.color || '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Draw elements (for non-async backgrounds)
            drawElements(ctx);
        }

        function drawGradientBackground(ctx, w, h, colors) {
            console.log('Drawing gradient:', colors, 'on canvas:', w, 'x', h);
            const gradient = ctx.createLinearGradient(0, 0, w, h);
            gradient.addColorStop(0, colors[0] || '#1a1a2e');
            gradient.addColorStop(1, colors[1] || colors[0] || '#6366f1');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
        }

        // Tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                });
            });
        }

        // AI Input
        function setupAIInput() {
            const input = document.getElementById('aiInput');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAICommand();
                }
            });
        }

        // AI Command Processing - Handled by ai-agent.js
        // The sendAICommand() function is defined in frontend/js/ai-agent.js
        // This handles all AI interactions including natural language commands, translations, etc.

        function applyAICommands(commands) {
            commands.forEach(cmd => {
                const target = cmd.target?.toLowerCase() || '';
                const element = canvasState.elements.find(el => 
                    el.name?.toLowerCase().includes(target) || 
                    el.type?.toLowerCase().includes(target)
                );
                
                switch (cmd.action) {
                    case 'resize':
                        if (element && cmd.parameters) {
                            if (cmd.parameters.width) element.width = cmd.parameters.width;
                            if (cmd.parameters.height) element.height = cmd.parameters.height;
                            if (cmd.parameters.scale) {
                                element.width *= cmd.parameters.scale;
                                element.height *= cmd.parameters.scale;
                                element.fontSize *= cmd.parameters.scale;
                            }
                        }
                        break;
                    case 'move':
                        if (element && cmd.parameters) {
                            if (cmd.parameters.x !== undefined) element.x = cmd.parameters.x;
                            if (cmd.parameters.y !== undefined) element.y = cmd.parameters.y;
                            if (cmd.parameters.position === 'center') {
                                element.x = (canvasState.dimensions.width - element.width) / 2;
                            }
                        }
                        break;
                    case 'change_color':
                        if (element && cmd.parameters?.color) {
                            element.color = cmd.parameters.color;
                        }
                        break;
                    case 'change_background':
                        if (cmd.parameters?.colors) {
                            canvasState.background.colors = cmd.parameters.colors;
                        } else if (cmd.parameters?.color) {
                            canvasState.background.colors = [cmd.parameters.color, cmd.parameters.color];
                        }
                        break;
                    case 'update_text':
                        if (element && cmd.parameters?.text) {
                            element.text = cmd.parameters.text;
                        }
                        break;
                    case 'change_font_size':
                        if (element && cmd.parameters?.size) {
                            element.fontSize = cmd.parameters.size;
                        }
                        break;
                }
            });
            
            renderCanvas();
            renderLayers();
        }

        async function fallbackProcessCommand(command) {
            const lower = command.toLowerCase();
            let applied = false;
            let message = "I processed your request.";
            
            // Simple pattern matching
            if (lower.includes('bigger') || lower.includes('larger')) {
                const target = findTargetElement(lower);
                if (target) {
                    target.fontSize = Math.round(target.fontSize * 1.2);
                    target.width = Math.round(target.width * 1.1);
                    applied = true;
                    message = `Made ${target.name} bigger.`;
                }
            } else if (lower.includes('smaller')) {
                const target = findTargetElement(lower);
                if (target) {
                    target.fontSize = Math.round(target.fontSize * 0.85);
                    target.width = Math.round(target.width * 0.9);
                    applied = true;
                    message = `Made ${target.name} smaller.`;
                }
            } else if (lower.includes('center')) {
                const target = findTargetElement(lower);
                if (target) {
                    target.x = (canvasState.dimensions.width - target.width) / 2;
                    applied = true;
                    message = `Centered ${target.name}.`;
                }
            } else if (lower.includes('blue') || lower.includes('red') || lower.includes('green')) {
                const colorMap = { blue: '#3b82f6', red: '#ef4444', green: '#10b981', purple: '#8b5cf6', orange: '#f97316' };
                const color = Object.keys(colorMap).find(c => lower.includes(c));
                
                if (lower.includes('background')) {
                    canvasState.background.colors = [colorMap[color], colorMap[color]];
                    applied = true;
                    message = `Changed background to ${color}.`;
                } else {
                    const target = findTargetElement(lower) || selectedElement;
                    if (target) {
                        if (target.type === 'button') {
                            target.backgroundColor = colorMap[color];
                        } else {
                            target.color = colorMap[color];
                        }
                        applied = true;
                        message = `Changed ${target.name} color to ${color}.`;
                    }
                }
            } else if (lower.includes('move')) {
                const target = findTargetElement(lower);
                if (target) {
                    if (lower.includes('left')) target.x -= 50;
                    else if (lower.includes('right')) target.x += 50;
                    else if (lower.includes('up')) target.y -= 50;
                    else if (lower.includes('down')) target.y += 50;
                    applied = true;
                    message = `Moved ${target.name}.`;
                }
            }
            
            if (applied) {
                renderCanvas();
                renderLayers();
            } else {
                message = "I understood your request but couldn't determine the specific changes. Try being more specific like 'make the headline bigger' or 'change background to blue'.";
            }
            
            return {
                success: applied,
                message: message,
                suggestions: ['Make headline bigger', 'Center CTA', 'Blue background']
            };
        }

        function findTargetElement(text) {
            const lower = text.toLowerCase();
            
            if (lower.includes('headline') || lower.includes('title')) {
                return canvasState.elements.find(e => e.name?.toLowerCase().includes('headline'));
            }
            if (lower.includes('cta') || lower.includes('button')) {
                return canvasState.elements.find(e => e.type === 'button' || e.name?.toLowerCase().includes('cta'));
            }
            if (lower.includes('discount') || lower.includes('price') || lower.includes('offer')) {
                return canvasState.elements.find(e => e.name?.toLowerCase().includes('discount'));
            }
            
            return selectedElement;
        }

        function addAIMessage(content, role, suggestions = []) {
            const messages = document.getElementById('aiMessages');
            const msg = document.createElement('div');
            msg.className = `ai-message ${role}`;
            
            let html = `<div class="ai-message-content">${content}</div>`;
            
            if (suggestions.length > 0 && role === 'assistant') {
                html += '<div class="ai-suggestions">';
                suggestions.forEach(s => {
                    html += `<span class="ai-suggestion" onclick="sendAICommand('${s}')">${s}</span>`;
                });
                html += '</div>';
            }
            
            msg.innerHTML = html;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        // Enhanced AI message with confidence, explanation, and actions
        function addEnhancedAIMessage(result) {
            const messages = document.getElementById('aiMessages');
            const msg = document.createElement('div');
            msg.className = 'ai-message assistant';
            
            let html = `<div class="ai-message-content">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem;"></div>
                    <div style="flex: 1;">
                        <p style="margin: 0 0 0.5rem 0; font-weight: 500;">${result.message}</p>`;
            
            // Add explanation if available
            if (result.explanation) {
                html += `<p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                     ${result.explanation}
                </p>`;
            }
            
            // Add confidence score if available
            if (result.confidence) {
                const confidencePercent = Math.round(result.confidence * 100);
                const confidenceColor = confidencePercent > 85 ? '#10b981' : confidencePercent > 70 ? '#f59e0b' : '#ef4444';
                html += `<div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                        <div style="width: ${confidencePercent}%; height: 100%; background: ${confidenceColor}; transition: width 0.3s;"></div>
                    </div>
                    <span style="font-size: 0.75rem; color: ${confidenceColor}; font-weight: 600;">${confidencePercent}%</span>
                </div>`;
            }
            
            html += `</div></div></div>`;
            
            // Add action buttons
            if (result.actions && result.actions.length > 0) {
                html += '<div class="ai-actions" style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">';
                result.actions.forEach((action, idx) => {
                    html += `<button onclick="applyAIAction(${idx})" 
                        style="padding: 0.4rem 0.75rem; background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4); 
                        border-radius: 8px; color: var(--primary-light); font-size: 0.8rem; cursor: pointer;">
                         ${action.label || action.action}
                    </button>`;
                });
                html += '</div>';
            }
            
            // Add suggestions
            if (result.suggestions && result.suggestions.length > 0) {
                html += '<div class="ai-suggestions" style="margin-top: 0.75rem;">';
                result.suggestions.forEach(s => {
                    html += `<span class="ai-suggestion" onclick="sendAICommand('${s.replace(/'/g, "\\'")}')">${s}</span>`;
                });
                html += '</div>';
            }
            
            msg.innerHTML = html;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        // Apply AI actions
        function applyAIActions(actions) {
            if (!actions || actions.length === 0) return;
            
            actions.forEach(action => {
                const targetEl = findElementByAction(action);
                
                switch (action.type) {
                    case 'update_text':
                        if (targetEl && action.value) {
                            targetEl.text = action.value;
                        }
                        break;
                    
                    case 'update_style':
                        if (targetEl && action.properties) {
                            Object.assign(targetEl, action.properties);
                        }
                        break;
                    
                    case 'move':
                        if (targetEl && action.position) {
                            if (action.position.x !== undefined) targetEl.x = action.position.x;
                            if (action.position.y !== undefined) targetEl.y = action.position.y;
                            if (action.position === 'center') {
                                targetEl.x = (canvasState.dimensions.width - targetEl.width) / 2;
                            }
                        }
                        break;
                    
                    case 'resize':
                        if (targetEl && action.size) {
                            if (action.size.width) targetEl.width = action.size.width;
                            if (action.size.height) targetEl.height = action.size.height;
                            if (action.size.scale) {
                                targetEl.width *= action.size.scale;
                                targetEl.height *= action.size.scale;
                                if (targetEl.fontSize) targetEl.fontSize *= action.size.scale;
                            }
                        }
                        break;
                    
                    case 'create':
                        if (action.element) {
                            canvasState.elements.push({
                                id: `el-${Date.now()}-${Math.random()}`,
                                ...action.element
                            });
                        }
                        break;
                    
                    case 'delete':
                        if (targetEl) {
                            canvasState.elements = canvasState.elements.filter(e => e !== targetEl);
                        }
                        break;
                }
            });
            
            renderCanvas();
            renderLayers();
        }

        function findElementByAction(action) {
            if (!action.target) return selectedElement;
            
            const target = action.target.toLowerCase();
            return canvasState.elements.find(el => 
                el.id === action.target ||
                el.name?.toLowerCase().includes(target) ||
                el.type?.toLowerCase().includes(target)
            ) || selectedElement;
        }

        // Element operations
        function duplicateElement() {
            if (!selectedElement) return;
            
            const newEl = {
                ...selectedElement,
                id: `el-${Date.now()}`,
                x: selectedElement.x + 20,
                y: selectedElement.y + 20
            };
            
            canvasState.elements.push(newEl);
            selectElement(newEl);
            renderCanvas();
            renderLayers();
            showToast('Element duplicated', 'success');
            
            saveToHistory({
                action: 'Duplicate Element',
                element: newEl.id,
                timestamp: Date.now()
            });
        }

        function deleteElement() {
            if (!selectedElement) return;
            
            const deletedEl = selectedElement;
            canvasState.elements = canvasState.elements.filter(e => e !== selectedElement);
            selectElement(null);
            renderCanvas();
            renderLayers();
            showToast('Element deleted', 'success');
            
            saveToHistory({
                action: 'Delete Element',
                element: deletedEl.id,
                timestamp: Date.now()
            });
        }

        function bringToFront() {
            if (!selectedElement) return;
            
            canvasState.elements = canvasState.elements.filter(e => e !== selectedElement);
            canvasState.elements.push(selectedElement);
            renderCanvas();
            renderLayers();
        }

        // ============================================
        // UNDO/REDO SYSTEM WITH BACKEND SUPPORT
        // ============================================
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        function saveToHistory(metadata = {}) {
            // Remove any future states if we're not at the end
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            
            // Add current state
            historyStack.push({
                canvasState: JSON.parse(JSON.stringify(canvasState)),
                metadata: {
                    ...metadata,
                    timestamp: Date.now()
                }
            });
            
            // Limit history size
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            } else {
                historyIndex++;
            }
            
            // Update button states
            updateHistoryButtons();
            
            // Send to backend for persistence
            sendHistoryToBackend();
        }

        async function sendHistoryToBackend() {
            try {
                const creativeId = canvasState.id || `creative-${Date.now()}`;
                await fetch(`${API_BASE}/api/history/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        creative_id: creativeId,
                        state: canvasState,
                        metadata: historyStack[historyIndex]?.metadata || {}
                    })
                });
            } catch (error) {
                console.log('History save failed (non-critical):', error.message);
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                canvasState = JSON.parse(JSON.stringify(historyStack[historyIndex].canvasState));
                selectedElement = null;
                renderCanvas();
                renderLayers();
                updateHistoryButtons();
                showToast('Undo successful', 'info');
            } else {
                showToast('Nothing to undo', 'warning');
            }
        }

        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                canvasState = JSON.parse(JSON.stringify(historyStack[historyIndex].canvasState));
                selectedElement = null;
                renderCanvas();
                renderLayers();
                updateHistoryButtons();
                showToast('Redo successful', 'info');
            } else {
                showToast('Nothing to redo', 'warning');
            }
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) {
                undoBtn.disabled = historyIndex <= 0;
                undoBtn.style.opacity = historyIndex <= 0 ? '0.5' : '1';
            }
            if (redoBtn) {
                redoBtn.disabled = historyIndex >= historyStack.length - 1;
                redoBtn.style.opacity = historyIndex >= historyStack.length - 1 ? '0.5' : '1';
            }
        }

        // ============================================
        // PREVIEW SYSTEM
        // ============================================
        async function previewAIChanges(command) {
            try {
                const creativeId = canvasState.id || `creative-${Date.now()}`;
                const response = await fetch(`${API_BASE}/api/preview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        creative_id: creativeId,
                        command: command,
                        current_state: canvasState
                    })
                });
                
                if (response.ok) {
                    const previewData = await response.json();
                    showPreviewModal(previewData);
                } else {
                    throw new Error('Preview not available');
                }
            } catch (error) {
                console.log('Preview unavailable:', error.message);
                showToast('Preview not available, applying directly', 'info');
                sendAICommand(command);
            }
        }

        function showPreviewModal(previewData) {
            // Create preview modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--dark-surface); padding: 2rem; border-radius: 16px; max-width: 90%; max-height: 90%; overflow: auto;">
                    <h2 style="margin: 0 0 1rem 0; color: var(--text-primary);">Preview Changes</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">Before</h3>
                            <div id="previewBefore" style="border: 2px solid var(--dark-border); border-radius: 8px; overflow: hidden;"></div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: var(--primary); font-size: 0.9rem;">After</h3>
                            <div id="previewAfter" style="border: 2px solid var(--primary); border-radius: 8px; overflow: hidden;"></div>
                        </div>
                    </div>
                    ${previewData.changes ? `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--dark-card); border-radius: 8px;">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary); font-size: 0.9rem;">Changes:</h4>
                            <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                                ${previewData.changes.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" 
                            style="padding: 0.75rem 1.5rem; background: var(--dark-card); border: 1px solid var(--dark-border); 
                            border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem;">
                            Cancel
                        </button>
                        <button onclick="applyPreviewChanges(${JSON.stringify(previewData).replace(/"/g, '&quot;')}); this.closest('.modal').remove();"
                            style="padding: 0.75rem 1.5rem; background: var(--primary); border: none; 
                            border-radius: 8px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                             Apply Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Render before/after canvases
            setTimeout(() => {
                const beforeCanvas = createPreviewCanvas(canvasState);
                const afterCanvas = createPreviewCanvas(previewData.new_state || canvasState);
                document.getElementById('previewBefore').appendChild(beforeCanvas);
                document.getElementById('previewAfter').appendChild(afterCanvas);
            }, 100);
        }

        function createPreviewCanvas(state) {
            const scale = 0.4;
            const canvas = document.createElement('canvas');
            canvas.width = state.dimensions.width * scale;
            canvas.height = state.dimensions.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            
            // Simple render (reuse existing render logic)
            renderStateToCanvas(ctx, state);
            
            return canvas;
        }

        function renderStateToCanvas(ctx, state) {
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 0, state.dimensions.height);
            state.background.colors.forEach((color, i) => {
                gradient.addColorStop(i / (state.background.colors.length - 1), color);
            });
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, state.dimensions.width, state.dimensions.height);
            
            // Elements
            state.elements.forEach(el => {
                if (!el.visible) return;
                
                ctx.save();
                
                if (el.type === 'text' || el.type === 'button') {
                    ctx.font = `${el.fontWeight || 'normal'} ${el.fontSize}px ${el.fontFamily || 'Inter'}`;
                    ctx.textAlign = el.textAlign || 'left';
                    ctx.textBaseline = 'top';
                    
                    if (el.backgroundColor) {
                        ctx.fillStyle = el.backgroundColor;
                        ctx.fillRect(el.x, el.y, el.width, el.height);
                    }
                    
                    ctx.fillStyle = el.color || '#000';
                    ctx.fillText(el.text || '', el.x + (el.textAlign === 'center' ? el.width/2 : 10), el.y + 10);
                }
                
                ctx.restore();
            });
        }

        function applyPreviewChanges(previewData) {
            if (previewData.new_state) {
                canvasState = previewData.new_state;
                renderCanvas();
                renderLayers();
                showToast(' Changes applied!', 'success');
                saveToHistory({ action: 'Apply Preview', timestamp: Date.now() });
            }
        }

        // ============================================
        // AUTO-SUGGESTIONS BASED ON CONTEXT
        // ============================================
        let suggestionTimer;
        
        function triggerAutoSuggestions() {
            clearTimeout(suggestionTimer);
            suggestionTimer = setTimeout(async () => {
                try {
                    const creativeId = canvasState.id || `creative-${Date.now()}`;
                    const response = await fetch(`${API_BASE}/api/ai/suggest-improvements`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            creative_id: creativeId,
                            current_state: canvasState,
                            platform: platform || 'amazon'
                        })
                    });
                    
                    if (response.ok) {
                        const suggestions = await response.json();
                        if (suggestions.suggestions && suggestions.suggestions.length > 0) {
                            showAutoSuggestionsBanner(suggestions.suggestions);
                        }
                    }
                } catch (error) {
                    console.log('Auto-suggestions not available');
                }
            }, 2000); // Wait 2s after last change
        }

        function showAutoSuggestionsBanner(suggestions) {
            // Remove existing banner
            const existing = document.getElementById('autoSuggestionsBanner');
            if (existing) existing.remove();
            
            const banner = document.createElement('div');
            banner.id = 'autoSuggestionsBanner';
            banner.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: var(--dark-surface);
                border: 1px solid var(--primary);
                border-radius: 12px;
                padding: 1rem 1.5rem;
                box-shadow: var(--shadow-2xl);
                max-width: 400px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            banner.innerHTML = `
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div style="font-size: 1.5rem;"></div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; justify-between; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">AI Suggestions</h4>
                            <button onclick="this.closest('#autoSuggestionsBanner').remove()" 
                                style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;"></button>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${suggestions.slice(0, 3).map(s => `
                                <button onclick="sendAICommand('${s.command.replace(/'/g, "\\'")}'); this.closest('#autoSuggestionsBanner').remove();"
                                    style="padding: 0.5rem 0.75rem; background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); 
                                    border-radius: 8px; color: var(--primary-light); cursor: pointer; text-align: left; font-size: 0.85rem;">
                                    ${s.label || s.command}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            // Auto-dismiss after 30 seconds
            setTimeout(() => {
                if (banner.parentNode) banner.remove();
            }, 30000);
        }

        function sendToBack() {
            if (!selectedElement) return;
            
            canvasState.elements = canvasState.elements.filter(e => e !== selectedElement);
            canvasState.elements.unshift(selectedElement);
            renderCanvas();
            renderLayers();
        }

        // Zoom controls
        function zoomIn() {
            zoom = Math.min(zoom * 1.2, 3);
            updateZoom();
        }

        function zoomOut() {
            zoom = Math.max(zoom / 1.2, 0.25);
            updateZoom();
        }

        function zoomReset() {
            zoom = 1;
            updateZoom();
        }

        function updateZoom() {
            const container = document.getElementById('canvasContainer');
            container.style.transform = `scale(${zoom})`;
            document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
        }

        // Export
        async function exportCreative() {
            const canvas = document.getElementById('mainCanvas');
            
            // Deselect for clean export
            const wasSelected = selectedElement;
            selectElement(null);
            renderCanvas();
            
            const link = document.createElement('a');
            link.download = `creative-${platform}-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // Restore selection
            selectElement(wasSelected);
            renderCanvas();
            
            showToast('Creative exported!', 'success');
        }

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Tool buttons
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => setTool(btn.dataset.tool));
        });

        // ============================================
        // TEMPLATES LIBRARY
        // ============================================
        // Template layout state
        let appliedTemplate = null;
        let preTemplateState = null;

        const templates = [
            // ============================================
            // E-COMMERCE TEMPLATES - BATCH 1 (20 Templates)
            // ============================================
            
            // Amazon & E-commerce Platforms (1-5)
            { id: 1, name: 'Amazon Hero Banner', category: 'ecommerce', width: 1200, height: 628, 
              background: { type: 'gradient', colors: ['#232f3e', '#485769'] },
              layout: { logo: { x: 0.05, y: 0.05, width: 0.12, height: 0.1 }, title: { x: 0.08, y: 0.28, width: 0.42, height: 0.16 }, subtitle: { x: 0.08, y: 0.48, width: 0.38, height: 0.11 }, cta: { x: 0.08, y: 0.68, width: 0.2, height: 0.13 }, image: { x: 0.57, y: 0.12, width: 0.38, height: 0.76 } }
            },
            { id: 2, name: 'Flipkart Deal Banner', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#2874f0', '#1a5bb9'] },
              layout: { badge: { x: 0.05, y: 0.08, width: 0.18, height: 0.18 }, title: { x: 0.08, y: 0.32, width: 0.48, height: 0.2 }, subtitle: { x: 0.08, y: 0.56, width: 0.42, height: 0.12 }, cta: { x: 0.08, y: 0.74, width: 0.22, height: 0.14 }, image: { x: 0.62, y: 0.08, width: 0.33, height: 0.84 } }
            },
            { id: 3, name: 'DMart Grocery Special', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#00a651', '#007d3c'] },
              layout: { header: { x: 0.08, y: 0.12, width: 0.55, height: 0.14 }, offer: { x: 0.08, y: 0.32, width: 0.5, height: 0.22 }, details: { x: 0.08, y: 0.58, width: 0.45, height: 0.11 }, cta: { x: 0.08, y: 0.75, width: 0.25, height: 0.14 }, decorative: { x: 0.68, y: 0.15, width: 0.27, height: 0.7 } }
            },
            { id: 4, name: 'Myntra Fashion Banner', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ff3f6c', '#fc2c5b'] },
              layout: { title: { x: 0.1, y: 0.18, width: 0.45, height: 0.18 }, tagline: { x: 0.1, y: 0.4, width: 0.4, height: 0.12 }, price: { x: 0.1, y: 0.56, width: 0.25, height: 0.14 }, cta: { x: 0.1, y: 0.74, width: 0.22, height: 0.13 }, image: { x: 0.58, y: 0.1, width: 0.37, height: 0.8 } }
            },
            { id: 5, name: 'Meesho Value Deal', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#9b1fe9', '#7b1ab8'] },
              layout: { badge: { x: 0.08, y: 0.1, width: 0.2, height: 0.2 }, title: { x: 0.32, y: 0.14, width: 0.55, height: 0.16 }, subtitle: { x: 0.32, y: 0.34, width: 0.5, height: 0.12 }, features: { x: 0.32, y: 0.5, width: 0.5, height: 0.25 }, cta: { x: 0.32, y: 0.78, width: 0.25, height: 0.12 } }
            },

            // Modern E-commerce Layouts (6-10)
            { id: 6, name: 'Split Product Showcase', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f8fafc', '#e2e8f0'] },
              layout: { image: { x: 0, y: 0, width: 0.5, height: 1 }, brand: { x: 0.55, y: 0.2, width: 0.38, height: 0.1 }, title: { x: 0.55, y: 0.34, width: 0.38, height: 0.16 }, description: { x: 0.55, y: 0.54, width: 0.38, height: 0.12 }, cta: { x: 0.55, y: 0.72, width: 0.25, height: 0.13 } }
            },
            { id: 7, name: 'Premium Collection', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#0f172a', '#1e293b'] },
              layout: { logo: { x: 0.08, y: 0.1, width: 0.15, height: 0.12 }, title: { x: 0.08, y: 0.3, width: 0.5, height: 0.2 }, subtitle: { x: 0.08, y: 0.54, width: 0.45, height: 0.12 }, cta: { x: 0.08, y: 0.72, width: 0.22, height: 0.13 }, product: { x: 0.62, y: 0.15, width: 0.32, height: 0.7 } }
            },
            { id: 8, name: 'Category Header Wide', category: 'ecommerce', width: 1584, height: 396,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { title: { x: 0.1, y: 0.25, width: 0.55, height: 0.28 }, subtitle: { x: 0.1, y: 0.58, width: 0.48, height: 0.18 }, decorative: { x: 0.7, y: 0.12, width: 0.25, height: 0.76 } }
            },
            { id: 9, name: 'Flash Deal Spotlight', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#d97706'] },
              layout: { timer: { x: 0.15, y: 0.1, width: 0.7, height: 0.12 }, title: { x: 0.15, y: 0.28, width: 0.7, height: 0.24 }, discount: { x: 0.3, y: 0.56, width: 0.4, height: 0.18 }, cta: { x: 0.35, y: 0.78, width: 0.3, height: 0.14 } }
            },
            { id: 10, name: 'Clearance Sale Dynamic', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dc2626', '#991b1b'] },
              layout: { badge: { x: 0.05, y: 0.05, width: 0.28, height: 0.28 }, title: { x: 0.38, y: 0.2, width: 0.57, height: 0.22 }, subtitle: { x: 0.38, y: 0.46, width: 0.52, height: 0.14 }, timer: { x: 0.38, y: 0.64, width: 0.4, height: 0.12 }, cta: { x: 0.38, y: 0.8, width: 0.28, height: 0.13 } }
            },

            // Specialized E-commerce (11-15)
            { id: 11, name: 'New Arrival Announcement', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { badge: { x: 0.35, y: 0.08, width: 0.3, height: 0.16 }, title: { x: 0.15, y: 0.3, width: 0.7, height: 0.22 }, subtitle: { x: 0.15, y: 0.56, width: 0.7, height: 0.12 }, cta: { x: 0.35, y: 0.74, width: 0.3, height: 0.14 } }
            },
            { id: 12, name: 'Limited Stock Alert', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ea580c', '#c2410c'] },
              layout: { warning: { x: 0.1, y: 0.12, width: 0.8, height: 0.15 }, title: { x: 0.1, y: 0.32, width: 0.8, height: 0.2 }, stock: { x: 0.3, y: 0.56, width: 0.4, height: 0.12 }, cta: { x: 0.35, y: 0.72, width: 0.3, height: 0.15 } }
            },
            { id: 13, name: 'Bundle Offer Layout', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.14 }, product1: { x: 0.1, y: 0.3, width: 0.22, height: 0.4 }, plus: { x: 0.35, y: 0.45, width: 0.08, height: 0.1 }, product2: { x: 0.46, y: 0.3, width: 0.22, height: 0.4 }, equals: { x: 0.71, y: 0.45, width: 0.08, height: 0.1 }, savings: { x: 0.82, y: 0.35, width: 0.13, height: 0.3 }, cta: { x: 0.35, y: 0.78, width: 0.3, height: 0.13 } }
            },
            { id: 14, name: 'Brand Partnership', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { logo1: { x: 0.15, y: 0.15, width: 0.18, height: 0.15 }, xmark: { x: 0.36, y: 0.15, width: 0.08, height: 0.15 }, logo2: { x: 0.47, y: 0.15, width: 0.18, height: 0.15 }, title: { x: 0.15, y: 0.4, width: 0.7, height: 0.18 }, subtitle: { x: 0.15, y: 0.62, width: 0.7, height: 0.12 }, cta: { x: 0.35, y: 0.78, width: 0.3, height: 0.13 } }
            },
            { id: 15, name: 'Festive Sale Banner', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#7c3aed', '#5b21b6'] },
              layout: { decoration: { x: 0, y: 0, width: 0.25, height: 1 }, title: { x: 0.3, y: 0.2, width: 0.6, height: 0.2 }, offer: { x: 0.3, y: 0.45, width: 0.6, height: 0.15 }, validity: { x: 0.3, y: 0.64, width: 0.5, height: 0.1 }, cta: { x: 0.4, y: 0.78, width: 0.28, height: 0.13 } }
            },

            // App Store & Mobile Commerce (16-20)
            { id: 16, name: 'App Download Banner', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { app_icon: { x: 0.08, y: 0.25, width: 0.15, height: 0.24 }, title: { x: 0.28, y: 0.22, width: 0.5, height: 0.16 }, subtitle: { x: 0.28, y: 0.42, width: 0.5, height: 0.12 }, features: { x: 0.28, y: 0.58, width: 0.5, height: 0.2 }, stores: { x: 0.28, y: 0.82, width: 0.4, height: 0.12 }, mockup: { x: 0.82, y: 0.15, width: 0.13, height: 0.7 } }
            },
            { id: 17, name: 'Refer & Earn', category: 'ecommerce', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { icon: { x: 0.35, y: 0.15, width: 0.3, height: 0.2 }, title: { x: 0.1, y: 0.4, width: 0.8, height: 0.15 }, reward: { x: 0.25, y: 0.58, width: 0.5, height: 0.2 }, code: { x: 0.2, y: 0.82, width: 0.6, height: 0.08 } }
            },
            { id: 18, name: 'Loyalty Program Card', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#a855f7', '#7e22ce'] },
              layout: { logo: { x: 0.08, y: 0.12, width: 0.15, height: 0.12 }, title: { x: 0.08, y: 0.3, width: 0.45, height: 0.18 }, benefits: { x: 0.08, y: 0.52, width: 0.45, height: 0.28 }, card: { x: 0.58, y: 0.2, width: 0.35, height: 0.6 } }
            },
            { id: 19, name: 'Super Saver Week', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f97316', '#ea580c'] },
              layout: { badge: { x: 0.08, y: 0.08, width: 0.22, height: 0.22 }, title: { x: 0.35, y: 0.15, width: 0.57, height: 0.2 }, grid1: { x: 0.08, y: 0.4, width: 0.26, height: 0.35 }, grid2: { x: 0.37, y: 0.4, width: 0.26, height: 0.35 }, grid3: { x: 0.66, y: 0.4, width: 0.26, height: 0.35 }, cta: { x: 0.35, y: 0.82, width: 0.3, height: 0.12 } }
            },
            { id: 20, name: 'Weekend Special Deals', category: 'ecommerce', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#8b5cf6', '#6d28d9'] },
              layout: { header: { x: 0.15, y: 0.1, width: 0.7, height: 0.16 }, offer1: { x: 0.1, y: 0.32, width: 0.25, height: 0.42 }, offer2: { x: 0.38, y: 0.32, width: 0.25, height: 0.42 }, offer3: { x: 0.66, y: 0.32, width: 0.25, height: 0.42 }, cta: { x: 0.35, y: 0.8, width: 0.3, height: 0.13 } }
            },

            // ============================================
            // SOCIAL MEDIA TEMPLATES - BATCH 2 (20 Templates)
            // ============================================
            
            // Instagram Posts (21-25)
            { id: 21, name: 'Instagram Square Modern', category: 'social', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#833ab4', '#fd1d1d', '#fcb045'] },
              layout: { logo: { x: 0.08, y: 0.08, width: 0.15, height: 0.1 }, title: { x: 0.1, y: 0.35, width: 0.8, height: 0.18 }, subtitle: { x: 0.1, y: 0.56, width: 0.8, height: 0.12 }, cta: { x: 0.3, y: 0.75, width: 0.4, height: 0.11 } }
            },
            { id: 22, name: 'Instagram Quote Card', category: 'social', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#2dd4bf', '#14b8a6'] },
              layout: { quote_mark: { x: 0.1, y: 0.15, width: 0.12, height: 0.12 }, quote: { x: 0.15, y: 0.32, width: 0.7, height: 0.35 }, author: { x: 0.15, y: 0.72, width: 0.5, height: 0.08 }, decoration: { x: 0.75, y: 0.72, width: 0.15, height: 0.15 } }
            },
            { id: 23, name: 'Instagram Product Feature', category: 'social', width: 1080, height: 1080,
              background: { type: 'solid', color: '#f8fafc' },
              layout: { image: { x: 0.1, y: 0.1, width: 0.8, height: 0.5 }, brand: { x: 0.1, y: 0.64, width: 0.3, height: 0.06 }, title: { x: 0.1, y: 0.72, width: 0.8, height: 0.12 }, price: { x: 0.1, y: 0.86, width: 0.25, height: 0.08 }, shop_btn: { x: 0.7, y: 0.85, width: 0.2, height: 0.09 } }
            },
            { id: 24, name: 'Instagram Carousel Template', category: 'social', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { slide_num: { x: 0.85, y: 0.05, width: 0.1, height: 0.06 }, content: { x: 0.1, y: 0.25, width: 0.8, height: 0.5 }, swipe: { x: 0.35, y: 0.8, width: 0.3, height: 0.08 } }
            },
            { id: 25, name: 'Instagram Promotion', category: 'social', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#f43f5e', '#e11d48'] },
              layout: { badge: { x: 0.3, y: 0.15, width: 0.4, height: 0.2 }, title: { x: 0.1, y: 0.4, width: 0.8, height: 0.15 }, offer: { x: 0.25, y: 0.58, width: 0.5, height: 0.12 }, code: { x: 0.25, y: 0.73, width: 0.5, height: 0.08 }, valid: { x: 0.25, y: 0.84, width: 0.5, height: 0.06 } }
            },

            // Instagram Stories (26-30)
            { id: 26, name: 'Instagram Story Minimal', category: 'social', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#667eea', '#764ba2'] },
              layout: { logo: { x: 0.08, y: 0.04, width: 0.2, height: 0.08 }, image: { x: 0.1, y: 0.15, width: 0.8, height: 0.4 }, title: { x: 0.1, y: 0.6, width: 0.8, height: 0.1 }, description: { x: 0.1, y: 0.72, width: 0.8, height: 0.12 }, cta: { x: 0.25, y: 0.88, width: 0.5, height: 0.06 } }
            },
            { id: 27, name: 'Instagram Story Poll', category: 'social', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { question: { x: 0.1, y: 0.25, width: 0.8, height: 0.15 }, option1: { x: 0.1, y: 0.45, width: 0.8, height: 0.12 }, option2: { x: 0.1, y: 0.6, width: 0.8, height: 0.12 }, decoration: { x: 0.3, y: 0.78, width: 0.4, height: 0.15 } }
            },
            { id: 28, name: 'Instagram Story Countdown', category: 'social', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { header: { x: 0.1, y: 0.15, width: 0.8, height: 0.12 }, event: { x: 0.1, y: 0.35, width: 0.8, height: 0.18 }, timer: { x: 0.15, y: 0.58, width: 0.7, height: 0.2 }, details: { x: 0.1, y: 0.82, width: 0.8, height: 0.1 } }
            },
            { id: 29, name: 'Instagram Story Announcement', category: 'social', width: 1080, height: 1920,
              background: { type: 'solid', color: '#0f172a' },
              layout: { badge: { x: 0.35, y: 0.2, width: 0.3, height: 0.15 }, title: { x: 0.1, y: 0.42, width: 0.8, height: 0.2 }, subtitle: { x: 0.1, y: 0.66, width: 0.8, height: 0.12 }, link: { x: 0.2, y: 0.82, width: 0.6, height: 0.08 } }
            },
            { id: 30, name: 'Instagram Story Behind Scenes', category: 'social', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { header: { x: 0.1, y: 0.06, width: 0.8, height: 0.08 }, image_main: { x: 0.05, y: 0.18, width: 0.9, height: 0.55 }, caption: { x: 0.1, y: 0.78, width: 0.8, height: 0.15 } }
            },

            // Facebook & Twitter (31-35)
            { id: 31, name: 'Facebook Ad Modern', category: 'social', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#1877f2', '#0d5db8'] },
              layout: { icon: { x: 0.08, y: 0.15, width: 0.12, height: 0.2 }, title: { x: 0.24, y: 0.22, width: 0.65, height: 0.18 }, subtitle: { x: 0.24, y: 0.44, width: 0.6, height: 0.12 }, cta: { x: 0.24, y: 0.62, width: 0.25, height: 0.14 } }
            },
            { id: 32, name: 'Facebook Cover Photo', category: 'social', width: 820, height: 312,
              background: { type: 'gradient', colors: ['#3b5998', '#2d4373'] },
              layout: { logo: { x: 0.08, y: 0.25, width: 0.18, height: 0.35 }, title: { x: 0.32, y: 0.28, width: 0.6, height: 0.22 }, tagline: { x: 0.32, y: 0.55, width: 0.55, height: 0.15 } }
            },
            { id: 33, name: 'Facebook Event Banner', category: 'social', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#8b5cf6', '#6d28d9'] },
              layout: { date_badge: { x: 0.08, y: 0.15, width: 0.15, height: 0.25 }, title: { x: 0.28, y: 0.2, width: 0.6, height: 0.18 }, details: { x: 0.28, y: 0.42, width: 0.6, height: 0.22 }, rsvp: { x: 0.28, y: 0.7, width: 0.25, height: 0.15 } }
            },
            { id: 34, name: 'Twitter Post Card', category: 'social', width: 1200, height: 675,
              background: { type: 'gradient', colors: ['#1da1f2', '#0c85d0'] },
              layout: { icon: { x: 0.1, y: 0.18, width: 0.1, height: 0.15 }, title: { x: 0.1, y: 0.38, width: 0.8, height: 0.18 }, subtitle: { x: 0.1, y: 0.6, width: 0.75, height: 0.12 }, hashtags: { x: 0.1, y: 0.76, width: 0.6, height: 0.08 } }
            },
            { id: 35, name: 'Twitter Header Banner', category: 'social', width: 1500, height: 500,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { title: { x: 0.1, y: 0.3, width: 0.5, height: 0.22 }, subtitle: { x: 0.1, y: 0.56, width: 0.45, height: 0.14 }, decoration: { x: 0.65, y: 0.2, width: 0.3, height: 0.6 } }
            },

            // LinkedIn & Professional (36-40)
            { id: 36, name: 'LinkedIn Post Professional', category: 'social', width: 1200, height: 627,
              background: { type: 'gradient', colors: ['#0a66c2', '#004182'] },
              layout: { profile: { x: 0.08, y: 0.12, width: 0.12, height: 0.18 }, name: { x: 0.24, y: 0.14, width: 0.6, height: 0.08 }, title: { x: 0.08, y: 0.36, width: 0.84, height: 0.16 }, content: { x: 0.08, y: 0.56, width: 0.84, height: 0.25 } }
            },
            { id: 37, name: 'LinkedIn Company Update', category: 'social', width: 1200, height: 627,
              background: { type: 'solid', color: '#ffffff' },
              layout: { logo: { x: 0.08, y: 0.15, width: 0.15, height: 0.18 }, announcement: { x: 0.28, y: 0.2, width: 0.64, height: 0.15 }, details: { x: 0.08, y: 0.42, width: 0.84, height: 0.35 }, cta: { x: 0.35, y: 0.82, width: 0.3, height: 0.12 } }
            },
            { id: 38, name: 'LinkedIn Article Header', category: 'social', width: 1200, height: 627,
              background: { type: 'gradient', colors: ['#1e293b', '#334155'] },
              layout: { category: { x: 0.1, y: 0.15, width: 0.25, height: 0.08 }, title: { x: 0.1, y: 0.3, width: 0.8, height: 0.25 }, author: { x: 0.1, y: 0.62, width: 0.4, height: 0.12 }, read_time: { x: 0.1, y: 0.78, width: 0.25, height: 0.08 } }
            },
            { id: 39, name: 'LinkedIn Job Posting', category: 'social', width: 1200, height: 627,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { badge: { x: 0.08, y: 0.12, width: 0.18, height: 0.15 }, job_title: { x: 0.08, y: 0.32, width: 0.84, height: 0.14 }, company: { x: 0.08, y: 0.5, width: 0.5, height: 0.1 }, details: { x: 0.08, y: 0.64, width: 0.84, height: 0.18 }, apply: { x: 0.35, y: 0.85, width: 0.3, height: 0.1 } }
            },
            { id: 40, name: 'LinkedIn Banner Profile', category: 'social', width: 1584, height: 396,
              background: { type: 'gradient', colors: ['#0a66c2', '#004182'] },
              layout: { title: { x: 0.08, y: 0.28, width: 0.5, height: 0.24 }, subtitle: { x: 0.08, y: 0.58, width: 0.45, height: 0.16 }, decoration: { x: 0.65, y: 0.15, width: 0.3, height: 0.7 } }
            },

            // ============================================
            // SALE/PROMO TEMPLATES - BATCH 3 (20 Templates)
            // ============================================
            
            // Flash Sales & Limited Time (41-45)
            { id: 41, name: 'Flash Sale Countdown', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { badge: { x: 0.18, y: 0.12, width: 0.64, height: 0.22 }, discount: { x: 0.28, y: 0.4, width: 0.44, height: 0.28 }, timer: { x: 0.25, y: 0.72, width: 0.5, height: 0.14 } }
            },
            { id: 42, name: 'Limited Time Deal', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { urgency: { x: 0.1, y: 0.15, width: 0.8, height: 0.12 }, offer: { x: 0.1, y: 0.32, width: 0.8, height: 0.25 }, details: { x: 0.1, y: 0.62, width: 0.8, height: 0.12 }, cta: { x: 0.35, y: 0.78, width: 0.3, height: 0.14 } }
            },
            { id: 43, name: 'Hourly Deal Banner', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dc2626', '#991b1b'] },
              layout: { clock: { x: 0.08, y: 0.15, width: 0.2, height: 0.3 }, title: { x: 0.32, y: 0.18, width: 0.6, height: 0.2 }, discount: { x: 0.32, y: 0.42, width: 0.5, height: 0.18 }, valid: { x: 0.32, y: 0.64, width: 0.5, height: 0.1 }, cta: { x: 0.32, y: 0.78, width: 0.28, height: 0.13 } }
            },
            { id: 44, name: 'Daily Deal Spotlight', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#7c3aed', '#5b21b6'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.18 }, product: { x: 0.08, y: 0.35, width: 0.35, height: 0.5 }, details: { x: 0.48, y: 0.35, width: 0.44, height: 0.3 }, buy: { x: 0.48, y: 0.7, width: 0.3, height: 0.15 } }
            },
            { id: 45, name: 'Deal of the Day', category: 'sale', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, product_img: { x: 0.2, y: 0.32, width: 0.6, height: 0.35 }, price: { x: 0.3, y: 0.72, width: 0.4, height: 0.12 }, cta: { x: 0.25, y: 0.87, width: 0.5, height: 0.08 } }
            },

            // Percentage Off & Discounts (46-50)
            { id: 46, name: '50% Off Special', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { badge_percent: { x: 0.05, y: 0.15, width: 0.25, height: 0.35 }, title: { x: 0.35, y: 0.22, width: 0.57, height: 0.18 }, subtitle: { x: 0.35, y: 0.44, width: 0.57, height: 0.12 }, terms: { x: 0.35, y: 0.6, width: 0.5, height: 0.08 }, cta: { x: 0.35, y: 0.72, width: 0.28, height: 0.14 } }
            },
            { id: 47, name: 'Up to 70% Off', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f97316', '#ea580c'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.2 }, discount: { x: 0.25, y: 0.42, width: 0.5, height: 0.25 }, categories: { x: 0.15, y: 0.72, width: 0.7, height: 0.12 }, cta: { x: 0.35, y: 0.88, width: 0.3, height: 0.09 } }
            },
            { id: 48, name: 'Clearance 80% Off', category: 'sale', width: 1200, height: 628,
              background: { type: 'solid', color: '#dc2626' },
              layout: { warning: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, huge_discount: { x: 0.2, y: 0.28, width: 0.6, height: 0.32 }, limited: { x: 0.25, y: 0.64, width: 0.5, height: 0.1 }, shop: { x: 0.35, y: 0.78, width: 0.3, height: 0.14 } }
            },
            { id: 49, name: 'Flat Discount Banner', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { header: { x: 0.1, y: 0.15, width: 0.8, height: 0.14 }, amount: { x: 0.3, y: 0.35, width: 0.4, height: 0.22 }, on_text: { x: 0.3, y: 0.6, width: 0.4, height: 0.12 }, cta: { x: 0.35, y: 0.76, width: 0.3, height: 0.14 } }
            },
            { id: 50, name: 'Multi-Tier Discount', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#8b5cf6', '#6d28d9'] },
              layout: { title: { x: 0.15, y: 0.12, width: 0.7, height: 0.14 }, tier1: { x: 0.08, y: 0.32, width: 0.28, height: 0.42 }, tier2: { x: 0.38, y: 0.32, width: 0.28, height: 0.42 }, tier3: { x: 0.68, y: 0.32, width: 0.28, height: 0.42 }, cta: { x: 0.35, y: 0.8, width: 0.3, height: 0.13 } }
            },

            // BOGO & Bundle Offers (51-55)
            { id: 51, name: 'Buy 1 Get 1 Free', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { badge: { x: 0.25, y: 0.1, width: 0.5, height: 0.2 }, visual: { x: 0.15, y: 0.35, width: 0.7, height: 0.35 }, terms: { x: 0.15, y: 0.74, width: 0.7, height: 0.1 }, cta: { x: 0.35, y: 0.87, width: 0.3, height: 0.1 } }
            },
            { id: 52, name: 'Bundle & Save Deal', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, item1: { x: 0.1, y: 0.32, width: 0.22, height: 0.38 }, plus: { x: 0.35, y: 0.47, width: 0.08, height: 0.1 }, item2: { x: 0.46, y: 0.32, width: 0.22, height: 0.38 }, equals: { x: 0.71, y: 0.47, width: 0.08, height: 0.1 }, savings: { x: 0.82, y: 0.38, width: 0.13, height: 0.25 }, cta: { x: 0.35, y: 0.78, width: 0.3, height: 0.13 } }
            },
            { id: 53, name: 'Combo Offer Special', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#d97706'] },
              layout: { header: { x: 0.15, y: 0.1, width: 0.7, height: 0.15 }, combo: { x: 0.2, y: 0.3, width: 0.6, height: 0.38 }, save: { x: 0.35, y: 0.72, width: 0.3, height: 0.12 }, cta: { x: 0.35, y: 0.87, width: 0.3, height: 0.1 } }
            },
            { id: 54, name: 'Package Deal Promo', category: 'sale', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#a855f7', '#7e22ce'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.15 }, package: { x: 0.15, y: 0.3, width: 0.7, height: 0.4 }, price: { x: 0.3, y: 0.74, width: 0.4, height: 0.12 }, cta: { x: 0.25, y: 0.89, width: 0.5, height: 0.08 } }
            },
            { id: 55, name: 'Multi-Buy Savings', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#06b6d4', '#0891b2'] },
              layout: { title: { x: 0.1, y: 0.15, width: 0.8, height: 0.14 }, option1: { x: 0.08, y: 0.35, width: 0.27, height: 0.38 }, option2: { x: 0.37, y: 0.35, width: 0.27, height: 0.38 }, option3: { x: 0.66, y: 0.35, width: 0.27, height: 0.38 }, cta: { x: 0.35, y: 0.8, width: 0.3, height: 0.13 } }
            },

            // Seasonal & Special Events (56-60)
            { id: 56, name: 'Black Friday Blitz', category: 'sale', width: 1200, height: 628,
              background: { type: 'solid', color: '#000000' },
              layout: { event: { x: 0.15, y: 0.15, width: 0.7, height: 0.18 }, discount: { x: 0.25, y: 0.38, width: 0.5, height: 0.25 }, countdown: { x: 0.25, y: 0.68, width: 0.5, height: 0.12 }, cta: { x: 0.35, y: 0.84, width: 0.3, height: 0.11 } }
            },
            { id: 57, name: 'Cyber Monday Sale', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#3b82f6', '#1d4ed8'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.16 }, deals: { x: 0.1, y: 0.34, width: 0.8, height: 0.38 }, timer: { x: 0.25, y: 0.76, width: 0.5, height: 0.11 }, cta: { x: 0.35, y: 0.9, width: 0.3, height: 0.08 } }
            },
            { id: 58, name: 'End of Season Sale', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#eab308', '#ca8a04'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.2 }, discount: { x: 0.3, y: 0.43, width: 0.4, height: 0.2 }, items: { x: 0.15, y: 0.68, width: 0.7, height: 0.12 }, cta: { x: 0.35, y: 0.84, width: 0.3, height: 0.12 } }
            },
            { id: 59, name: 'Festive Sale Extravaganza', category: 'sale', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dc2626', '#991b1b'] },
              layout: { decoration: { x: 0, y: 0, width: 0.2, height: 1 }, title: { x: 0.25, y: 0.2, width: 0.7, height: 0.18 }, offer: { x: 0.25, y: 0.42, width: 0.7, height: 0.2 }, valid: { x: 0.25, y: 0.66, width: 0.6, height: 0.1 }, cta: { x: 0.4, y: 0.8, width: 0.28, height: 0.13 } }
            },
            { id: 60, name: 'Anniversary Special', category: 'sale', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#a855f7', '#7e22ce'] },
              layout: { badge: { x: 0.3, y: 0.12, width: 0.4, height: 0.2 }, years: { x: 0.35, y: 0.36, width: 0.3, height: 0.2 }, offers: { x: 0.1, y: 0.6, width: 0.8, height: 0.2 }, cta: { x: 0.25, y: 0.84, width: 0.5, height: 0.1 } }
            },

            // ============================================
            // PRODUCT TEMPLATES - BATCH 4 (20 Templates)
            // ============================================
            
            // Product Showcases (61-65)
            { id: 61, name: 'Hero Product Launch', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { product: { x: 0.08, y: 0.18, width: 0.4, height: 0.64 }, title: { x: 0.52, y: 0.22, width: 0.42, height: 0.14 }, features: { x: 0.52, y: 0.4, width: 0.42, height: 0.28 }, cta: { x: 0.52, y: 0.72, width: 0.28, height: 0.13 } }
            },
            { id: 62, name: 'Product Feature Highlight', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { image: { x: 0.1, y: 0.1, width: 0.45, height: 0.8 }, title: { x: 0.58, y: 0.15, width: 0.35, height: 0.12 }, feat1: { x: 0.58, y: 0.32, width: 0.35, height: 0.12 }, feat2: { x: 0.58, y: 0.48, width: 0.35, height: 0.12 }, feat3: { x: 0.58, y: 0.64, width: 0.35, height: 0.12 }, price: { x: 0.58, y: 0.82, width: 0.2, height: 0.1 } }
            },
            { id: 63, name: 'New Arrival Announcement', category: 'product', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { badge: { x: 0.3, y: 0.08, width: 0.4, height: 0.12 }, product: { x: 0.15, y: 0.24, width: 0.7, height: 0.45 }, name: { x: 0.15, y: 0.72, width: 0.7, height: 0.1 }, cta: { x: 0.3, y: 0.86, width: 0.4, height: 0.09 } }
            },
            { id: 64, name: 'Product Grid Catalog', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#f3f4f6' },
              layout: { title: { x: 0.1, y: 0.08, width: 0.8, height: 0.12 }, prod1: { x: 0.08, y: 0.24, width: 0.21, height: 0.68 }, prod2: { x: 0.32, y: 0.24, width: 0.21, height: 0.68 }, prod3: { x: 0.56, y: 0.24, width: 0.21, height: 0.68 }, prod4: { x: 0.8, y: 0.24, width: 0.18, height: 0.68 } }
            },
            { id: 65, name: 'Premium Product Display', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#1f2937', '#111827'] },
              layout: { product: { x: 0.3, y: 0.15, width: 0.4, height: 0.7 }, title: { x: 0.1, y: 0.1, width: 0.8, height: 0.08 }, price: { x: 0.42, y: 0.88, width: 0.16, height: 0.08 } }
            },

            // Product Comparisons (66-70)
            { id: 66, name: 'Before After Comparison', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { title: { x: 0.25, y: 0.08, width: 0.5, height: 0.12 }, before: { x: 0.08, y: 0.24, width: 0.42, height: 0.68 }, after: { x: 0.52, y: 0.24, width: 0.42, height: 0.68 } }
            },
            { id: 67, name: 'Product vs Product', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f9fafb', '#e5e7eb'] },
              layout: { title: { x: 0.3, y: 0.1, width: 0.4, height: 0.1 }, prod_left: { x: 0.08, y: 0.24, width: 0.4, height: 0.66 }, vs: { x: 0.46, y: 0.45, width: 0.08, height: 0.1 }, prod_right: { x: 0.54, y: 0.24, width: 0.4, height: 0.66 } }
            },
            { id: 68, name: 'Size Comparison Chart', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.14 }, small: { x: 0.08, y: 0.3, width: 0.28, height: 0.55 }, medium: { x: 0.38, y: 0.3, width: 0.28, height: 0.55 }, large: { x: 0.68, y: 0.3, width: 0.28, height: 0.55 } }
            },
            { id: 69, name: 'Price Tier Comparison', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dbeafe', '#bfdbfe'] },
              layout: { title: { x: 0.2, y: 0.08, width: 0.6, height: 0.1 }, basic: { x: 0.05, y: 0.22, width: 0.28, height: 0.7 }, pro: { x: 0.36, y: 0.22, width: 0.28, height: 0.7 }, premium: { x: 0.67, y: 0.22, width: 0.28, height: 0.7 } }
            },
            { id: 70, name: 'Feature Matrix', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { header: { x: 0.1, y: 0.08, width: 0.8, height: 0.12 }, labels: { x: 0.05, y: 0.24, width: 0.25, height: 0.68 }, col1: { x: 0.32, y: 0.24, width: 0.2, height: 0.68 }, col2: { x: 0.54, y: 0.24, width: 0.2, height: 0.68 }, col3: { x: 0.76, y: 0.24, width: 0.2, height: 0.68 } }
            },

            // Color Variants (71-75)
            { id: 71, name: 'Color Swatch Display', category: 'product', width: 1080, height: 1080,
              background: { type: 'solid', color: '#f8fafc' },
              layout: { product: { x: 0.15, y: 0.12, width: 0.7, height: 0.5 }, title: { x: 0.15, y: 0.66, width: 0.7, height: 0.1 }, colors: { x: 0.25, y: 0.8, width: 0.5, height: 0.12 } }
            },
            { id: 72, name: 'Available in Colors', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fafafa', '#e5e5e5'] },
              layout: { product: { x: 0.12, y: 0.2, width: 0.35, height: 0.6 }, title: { x: 0.52, y: 0.25, width: 0.4, height: 0.12 }, swatches: { x: 0.52, y: 0.42, width: 0.4, height: 0.18 }, cta: { x: 0.52, y: 0.68, width: 0.26, height: 0.13 } }
            },
            { id: 73, name: 'Rainbow Product Line', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fef2f2', '#fee2e2'] },
              layout: { title: { x: 0.25, y: 0.12, width: 0.5, height: 0.14 }, var1: { x: 0.06, y: 0.32, width: 0.17, height: 0.56 }, var2: { x: 0.25, y: 0.32, width: 0.17, height: 0.56 }, var3: { x: 0.44, y: 0.32, width: 0.17, height: 0.56 }, var4: { x: 0.63, y: 0.32, width: 0.17, height: 0.56 }, var5: { x: 0.82, y: 0.32, width: 0.16, height: 0.56 } }
            },
            { id: 74, name: 'Material Showcase', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#f5f5f4' },
              layout: { title: { x: 0.15, y: 0.1, width: 0.7, height: 0.12 }, mat1: { x: 0.08, y: 0.28, width: 0.26, height: 0.62 }, mat2: { x: 0.37, y: 0.28, width: 0.26, height: 0.62 }, mat3: { x: 0.66, y: 0.28, width: 0.26, height: 0.62 } }
            },
            { id: 75, name: 'Texture Collection', category: 'product', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#e7e5e4', '#d6d3d1'] },
              layout: { header: { x: 0.1, y: 0.08, width: 0.8, height: 0.1 }, tex1: { x: 0.1, y: 0.22, width: 0.37, height: 0.32 }, tex2: { x: 0.53, y: 0.22, width: 0.37, height: 0.32 }, tex3: { x: 0.1, y: 0.58, width: 0.37, height: 0.32 }, tex4: { x: 0.53, y: 0.58, width: 0.37, height: 0.32 } }
            },

            // Specifications & Details (76-80)
            { id: 76, name: 'Product Spec Sheet', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { image: { x: 0.05, y: 0.12, width: 0.38, height: 0.76 }, title: { x: 0.48, y: 0.12, width: 0.47, height: 0.1 }, spec_list: { x: 0.48, y: 0.26, width: 0.47, height: 0.55 }, logo: { x: 0.48, y: 0.84, width: 0.12, height: 0.1 } }
            },
            { id: 77, name: 'Technical Details', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#eff6ff', '#dbeafe'] },
              layout: { header: { x: 0.1, y: 0.08, width: 0.8, height: 0.12 }, product: { x: 0.1, y: 0.24, width: 0.35, height: 0.68 }, specs: { x: 0.5, y: 0.24, width: 0.43, height: 0.68 } }
            },
            { id: 78, name: 'Infographic Product', category: 'product', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fef3c7', '#fde68a'] },
              layout: { product: { x: 0.25, y: 0.1, width: 0.5, height: 0.35 }, info1: { x: 0.08, y: 0.5, width: 0.4, height: 0.12 }, info2: { x: 0.52, y: 0.5, width: 0.4, height: 0.12 }, info3: { x: 0.08, y: 0.66, width: 0.4, height: 0.12 }, info4: { x: 0.52, y: 0.66, width: 0.4, height: 0.12 }, cta: { x: 0.3, y: 0.84, width: 0.4, height: 0.1 } }
            },
            { id: 79, name: 'Dimension Display', category: 'product', width: 1200, height: 628,
              background: { type: 'solid', color: '#f9fafb' },
              layout: { title: { x: 0.15, y: 0.1, width: 0.7, height: 0.1 }, product_side: { x: 0.08, y: 0.24, width: 0.4, height: 0.68 }, product_top: { x: 0.52, y: 0.24, width: 0.4, height: 0.68 } }
            },
            { id: 80, name: 'Warranty & Guarantee', category: 'product', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dcfce7', '#bbf7d0'] },
              layout: { badge: { x: 0.35, y: 0.15, width: 0.3, height: 0.25 }, title: { x: 0.15, y: 0.48, width: 0.7, height: 0.12 }, details: { x: 0.15, y: 0.64, width: 0.7, height: 0.2 }, logo: { x: 0.45, y: 0.88, width: 0.1, height: 0.08 } }
            },

            // ============================================
            // BUSINESS/CORPORATE TEMPLATES - BATCH 5 (20 Templates)
            // ============================================
            
            // Corporate Announcements (81-85)
            { id: 81, name: 'Corporate Announcement', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#1e40af', '#1e3a8a'] },
              layout: { logo: { x: 0.08, y: 0.12, width: 0.15, height: 0.15 }, title: { x: 0.08, y: 0.32, width: 0.84, height: 0.18 }, message: { x: 0.08, y: 0.54, width: 0.84, height: 0.28 } }
            },
            { id: 82, name: 'Company Milestone', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#059669', '#047857'] },
              layout: { badge: { x: 0.3, y: 0.15, width: 0.4, height: 0.22 }, achievement: { x: 0.2, y: 0.42, width: 0.6, height: 0.18 }, details: { x: 0.15, y: 0.64, width: 0.7, height: 0.12 }, logo: { x: 0.42, y: 0.8, width: 0.16, height: 0.14 } }
            },
            { id: 83, name: 'New Office Opening', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#f0f9ff' },
              layout: { header: { x: 0.15, y: 0.12, width: 0.7, height: 0.14 }, image: { x: 0.1, y: 0.3, width: 0.4, height: 0.58 }, address: { x: 0.54, y: 0.35, width: 0.38, height: 0.4 }, cta: { x: 0.54, y: 0.78, width: 0.28, height: 0.12 } }
            },
            { id: 84, name: 'Press Release', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#ffffff' },
              layout: { logo: { x: 0.05, y: 0.08, width: 0.12, height: 0.12 }, headline: { x: 0.05, y: 0.24, width: 0.9, height: 0.16 }, body: { x: 0.05, y: 0.44, width: 0.9, height: 0.38 }, contact: { x: 0.05, y: 0.86, width: 0.4, height: 0.1 } }
            },
            { id: 85, name: 'Award Recognition', category: 'business', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { trophy: { x: 0.35, y: 0.12, width: 0.3, height: 0.28 }, title: { x: 0.1, y: 0.45, width: 0.8, height: 0.12 }, award: { x: 0.15, y: 0.6, width: 0.7, height: 0.15 }, logo: { x: 0.4, y: 0.82, width: 0.2, height: 0.12 } }
            },

            // Team & Leadership (86-90)
            { id: 86, name: 'Meet the Team', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { header: { x: 0.2, y: 0.12, width: 0.6, height: 0.14 }, member1: { x: 0.08, y: 0.32, width: 0.26, height: 0.58 }, member2: { x: 0.37, y: 0.32, width: 0.26, height: 0.58 }, member3: { x: 0.66, y: 0.32, width: 0.26, height: 0.58 } }
            },
            { id: 87, name: 'Leadership Spotlight', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#0f172a' },
              layout: { photo: { x: 0.08, y: 0.15, width: 0.35, height: 0.7 }, name: { x: 0.48, y: 0.22, width: 0.44, height: 0.12 }, title_role: { x: 0.48, y: 0.38, width: 0.44, height: 0.08 }, bio: { x: 0.48, y: 0.5, width: 0.44, height: 0.28 } }
            },
            { id: 88, name: 'New Hire Welcome', category: 'business', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#a855f7', '#9333ea'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.12 }, photo: { x: 0.3, y: 0.26, width: 0.4, height: 0.32 }, name: { x: 0.15, y: 0.62, width: 0.7, height: 0.1 }, position: { x: 0.15, y: 0.74, width: 0.7, height: 0.08 }, welcome: { x: 0.15, y: 0.85, width: 0.7, height: 0.08 } }
            },
            { id: 89, name: 'Employee of Month', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#3b82f6', '#2563eb'] },
              layout: { star: { x: 0.42, y: 0.08, width: 0.16, height: 0.2 }, photo: { x: 0.35, y: 0.32, width: 0.3, height: 0.38 }, name: { x: 0.25, y: 0.74, width: 0.5, height: 0.1 }, achievement: { x: 0.2, y: 0.87, width: 0.6, height: 0.08 } }
            },
            { id: 90, name: 'Team Achievement', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.16 }, team_photo: { x: 0.2, y: 0.36, width: 0.6, height: 0.42 }, caption: { x: 0.2, y: 0.82, width: 0.6, height: 0.1 } }
            },

            // Reports & Data (91-95)
            { id: 91, name: 'Quarterly Report', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#f8fafc' },
              layout: { header: { x: 0.08, y: 0.1, width: 0.84, height: 0.12 }, chart: { x: 0.08, y: 0.26, width: 0.55, height: 0.62 }, stats: { x: 0.66, y: 0.26, width: 0.28, height: 0.62 } }
            },
            { id: 92, name: 'Annual Growth Stats', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#dbeafe', '#bfdbfe'] },
              layout: { title: { x: 0.15, y: 0.12, width: 0.7, height: 0.14 }, graph: { x: 0.1, y: 0.3, width: 0.8, height: 0.48 }, footer: { x: 0.1, y: 0.82, width: 0.8, height: 0.1 } }
            },
            { id: 93, name: 'Performance Dashboard', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#1e293b' },
              layout: { header: { x: 0.08, y: 0.08, width: 0.84, height: 0.1 }, metric1: { x: 0.08, y: 0.22, width: 0.26, height: 0.32 }, metric2: { x: 0.37, y: 0.22, width: 0.26, height: 0.32 }, metric3: { x: 0.66, y: 0.22, width: 0.26, height: 0.32 }, chart: { x: 0.08, y: 0.58, width: 0.84, height: 0.34 } }
            },
            { id: 94, name: 'Financial Summary', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ecfdf5', '#d1fae5'] },
              layout: { title: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, revenue: { x: 0.1, y: 0.28, width: 0.38, height: 0.58 }, expenses: { x: 0.52, y: 0.28, width: 0.38, height: 0.58 } }
            },
            { id: 95, name: 'KPI Achievement', category: 'business', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.1 }, kpi1: { x: 0.1, y: 0.24, width: 0.8, height: 0.16 }, kpi2: { x: 0.1, y: 0.44, width: 0.8, height: 0.16 }, kpi3: { x: 0.1, y: 0.64, width: 0.8, height: 0.16 }, footer: { x: 0.1, y: 0.84, width: 0.8, height: 0.08 } }
            },

            // Events & Conferences (96-100)
            { id: 96, name: 'Conference Banner', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { event_name: { x: 0.1, y: 0.18, width: 0.8, height: 0.2 }, date_time: { x: 0.1, y: 0.42, width: 0.8, height: 0.12 }, speakers: { x: 0.1, y: 0.58, width: 0.8, height: 0.18 }, register: { x: 0.35, y: 0.8, width: 0.3, height: 0.13 } }
            },
            { id: 97, name: 'Webinar Invitation', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#7c3aed', '#6d28d9'] },
              layout: { badge: { x: 0.08, y: 0.12, width: 0.2, height: 0.12 }, title: { x: 0.08, y: 0.3, width: 0.84, height: 0.18 }, speaker: { x: 0.08, y: 0.52, width: 0.4, height: 0.14 }, date: { x: 0.52, y: 0.52, width: 0.4, height: 0.14 }, cta: { x: 0.35, y: 0.72, width: 0.3, height: 0.16 } }
            },
            { id: 98, name: 'Trade Show Booth', category: 'business', width: 1200, height: 628,
              background: { type: 'solid', color: '#0ea5e9' },
              layout: { company: { x: 0.15, y: 0.15, width: 0.7, height: 0.12 }, booth_number: { x: 0.3, y: 0.32, width: 0.4, height: 0.22 }, tagline: { x: 0.15, y: 0.6, width: 0.7, height: 0.12 }, visit: { x: 0.35, y: 0.76, width: 0.3, height: 0.14 } }
            },
            { id: 99, name: 'Networking Event', category: 'business', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { title: { x: 0.1, y: 0.15, width: 0.8, height: 0.14 }, details: { x: 0.1, y: 0.34, width: 0.8, height: 0.3 }, venue: { x: 0.1, y: 0.68, width: 0.8, height: 0.12 }, rsvp: { x: 0.3, y: 0.84, width: 0.4, height: 0.1 } }
            },
            { id: 100, name: 'Summit Registration', category: 'business', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { logo: { x: 0.42, y: 0.08, width: 0.16, height: 0.14 }, event: { x: 0.15, y: 0.28, width: 0.7, height: 0.18 }, schedule: { x: 0.15, y: 0.5, width: 0.7, height: 0.2 }, register: { x: 0.35, y: 0.74, width: 0.3, height: 0.16 } }
            },

            // ============================================
            // FASHION/LIFESTYLE TEMPLATES - BATCH 6 (20 Templates)
            // ============================================
            
            // Fashion Lookbooks (101-105)
            { id: 101, name: 'Fashion Lookbook Cover', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fce7f3', '#fbcfe8'] },
              layout: { title: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, model: { x: 0.15, y: 0.26, width: 0.7, height: 0.58 }, season: { x: 0.25, y: 0.88, width: 0.5, height: 0.08 } }
            },
            { id: 102, name: 'Street Style Outfit', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fafafa' },
              layout: { image: { x: 0.1, y: 0.08, width: 0.8, height: 0.7 }, caption: { x: 0.1, y: 0.82, width: 0.8, height: 0.08 }, hashtags: { x: 0.1, y: 0.92, width: 0.8, height: 0.05 } }
            },
            { id: 103, name: 'Designer Collection', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#000000', '#1f2937'] },
              layout: { brand: { x: 0.08, y: 0.12, width: 0.3, height: 0.12 }, collection: { x: 0.08, y: 0.28, width: 0.4, height: 0.18 }, image: { x: 0.52, y: 0.1, width: 0.42, height: 0.8 }, cta: { x: 0.08, y: 0.72, width: 0.25, height: 0.13 } }
            },
            { id: 104, name: 'Trend Alert', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#f472b6', '#ec4899'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.14 }, trend_image: { x: 0.1, y: 0.28, width: 0.8, height: 0.48 }, description: { x: 0.1, y: 0.8, width: 0.8, height: 0.14 } }
            },
            { id: 105, name: 'Outfit of the Day', category: 'fashion', width: 1080, height: 1920,
              background: { type: 'solid', color: '#fff7ed' },
              layout: { header: { x: 0.1, y: 0.05, width: 0.8, height: 0.08 }, outfit: { x: 0.1, y: 0.15, width: 0.8, height: 0.6 }, details: { x: 0.1, y: 0.78, width: 0.8, height: 0.15 } }
            },

            // Beauty & Cosmetics (106-110)
            { id: 106, name: 'Beauty Product Launch', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fdf2f8', '#fce7f3'] },
              layout: { product: { x: 0.25, y: 0.15, width: 0.5, height: 0.45 }, brand: { x: 0.2, y: 0.65, width: 0.6, height: 0.1 }, tagline: { x: 0.15, y: 0.78, width: 0.7, height: 0.08 }, cta: { x: 0.3, y: 0.9, width: 0.4, height: 0.08 } }
            },
            { id: 107, name: 'Makeup Tutorial', category: 'fashion', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#fbcfe8', '#f9a8d4'] },
              layout: { title: { x: 0.1, y: 0.08, width: 0.8, height: 0.1 }, steps: { x: 0.1, y: 0.2, width: 0.8, height: 0.6 }, products: { x: 0.1, y: 0.82, width: 0.8, height: 0.12 } }
            },
            { id: 108, name: 'Skincare Routine', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'solid', color: '#ecfdf5' },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.1 }, step1: { x: 0.1, y: 0.26, width: 0.38, height: 0.3 }, step2: { x: 0.52, y: 0.26, width: 0.38, height: 0.3 }, step3: { x: 0.1, y: 0.6, width: 0.38, height: 0.3 }, step4: { x: 0.52, y: 0.6, width: 0.38, height: 0.3 } }
            },
            { id: 109, name: 'Cosmetics Sale', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#c026d3', '#a21caf'] },
              layout: { offer: { x: 0.1, y: 0.15, width: 0.8, height: 0.18 }, products: { x: 0.1, y: 0.38, width: 0.8, height: 0.38 }, cta: { x: 0.35, y: 0.8, width: 0.3, height: 0.13 } }
            },
            { id: 110, name: 'Beauty Tips', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fef3c7', '#fde68a'] },
              layout: { icon: { x: 0.4, y: 0.12, width: 0.2, height: 0.15 }, title: { x: 0.1, y: 0.32, width: 0.8, height: 0.12 }, tips: { x: 0.1, y: 0.48, width: 0.8, height: 0.4 } }
            },

            // Accessories & Jewelry (111-115)
            { id: 111, name: 'Jewelry Showcase', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'solid', color: '#1e293b' },
              layout: { product: { x: 0.2, y: 0.2, width: 0.6, height: 0.5 }, name: { x: 0.15, y: 0.74, width: 0.7, height: 0.1 }, price: { x: 0.35, y: 0.87, width: 0.3, height: 0.08 } }
            },
            { id: 112, name: 'Watch Collection', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#44403c', '#292524'] },
              layout: { brand: { x: 0.38, y: 0.12, width: 0.24, height: 0.12 }, watch1: { x: 0.08, y: 0.3, width: 0.26, height: 0.58 }, watch2: { x: 0.37, y: 0.3, width: 0.26, height: 0.58 }, watch3: { x: 0.66, y: 0.3, width: 0.26, height: 0.58 } }
            },
            { id: 113, name: 'Handbag Feature', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fef2f2', '#fee2e2'] },
              layout: { product: { x: 0.15, y: 0.15, width: 0.7, height: 0.52 }, brand: { x: 0.25, y: 0.72, width: 0.5, height: 0.08 }, details: { x: 0.15, y: 0.82, width: 0.7, height: 0.12 } }
            },
            { id: 114, name: 'Sunglasses Promo', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.14 }, glasses: { x: 0.25, y: 0.38, width: 0.5, height: 0.34 }, cta: { x: 0.35, y: 0.76, width: 0.3, height: 0.14 } }
            },
            { id: 115, name: 'Accessories Bundle', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'solid', color: '#f5f5f4' },
              layout: { title: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, item1: { x: 0.1, y: 0.26, width: 0.38, height: 0.3 }, item2: { x: 0.52, y: 0.26, width: 0.38, height: 0.3 }, item3: { x: 0.1, y: 0.6, width: 0.38, height: 0.3 }, price: { x: 0.52, y: 0.7, width: 0.38, height: 0.2 } }
            },

            // Seasonal Fashion (116-120)
            { id: 116, name: 'Summer Collection', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fef3c7', '#fcd34d'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.16 }, products: { x: 0.1, y: 0.4, width: 0.8, height: 0.42 }, cta: { x: 0.35, y: 0.86, width: 0.3, height: 0.1 } }
            },
            { id: 117, name: 'Winter Fashion', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#dbeafe', '#93c5fd'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.12 }, outfit: { x: 0.15, y: 0.28, width: 0.7, height: 0.55 }, shop: { x: 0.3, y: 0.87, width: 0.4, height: 0.09 } }
            },
            { id: 118, name: 'Spring Styles', category: 'fashion', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fae8ff', '#f5d0fe'] },
              layout: { badge: { x: 0.35, y: 0.12, width: 0.3, height: 0.14 }, collection: { x: 0.1, y: 0.32, width: 0.8, height: 0.48 }, cta: { x: 0.35, y: 0.84, width: 0.3, height: 0.12 } }
            },
            { id: 119, name: 'Autumn Wardrobe', category: 'fashion', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fed7aa', '#fdba74'] },
              layout: { title: { x: 0.1, y: 0.1, width: 0.8, height: 0.14 }, items: { x: 0.1, y: 0.28, width: 0.8, height: 0.58 }, footer: { x: 0.1, y: 0.9, width: 0.8, height: 0.07 } }
            },
            { id: 120, name: 'Fashion Week Recap', category: 'fashion', width: 1200, height: 628,
              background: { type: 'solid', color: '#000000' },
              layout: { event: { x: 0.15, y: 0.15, width: 0.7, height: 0.14 }, highlights: { x: 0.1, y: 0.34, width: 0.8, height: 0.48 }, logo: { x: 0.42, y: 0.86, width: 0.16, height: 0.1 } }
            },

            // ============================================
            // FOOD/RESTAURANT TEMPLATES - BATCH 7 (20 Templates)
            // ============================================
            
            // Restaurant Menus (121-125)
            { id: 121, name: 'Restaurant Menu Special', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fef3c7', '#fde68a'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, dish1: { x: 0.1, y: 0.26, width: 0.8, height: 0.2 }, dish2: { x: 0.1, y: 0.5, width: 0.8, height: 0.2 }, dish3: { x: 0.1, y: 0.74, width: 0.8, height: 0.2 } }
            },
            { id: 122, name: 'Signature Dish Showcase', category: 'food', width: 1200, height: 628,
              background: { type: 'solid', color: '#1e293b' },
              layout: { dish: { x: 0.08, y: 0.12, width: 0.45, height: 0.76 }, name: { x: 0.56, y: 0.22, width: 0.38, height: 0.14 }, description: { x: 0.56, y: 0.4, width: 0.38, height: 0.28 }, price: { x: 0.56, y: 0.72, width: 0.2, height: 0.12 } }
            },
            { id: 123, name: 'Weekly Food Special', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.14 }, food_image: { x: 0.1, y: 0.28, width: 0.8, height: 0.48 }, details: { x: 0.1, y: 0.8, width: 0.8, height: 0.14 } }
            },
            { id: 124, name: 'Chef Recommendation', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fcd34d', '#fbbf24'] },
              layout: { chef: { x: 0.08, y: 0.18, width: 0.28, height: 0.64 }, title: { x: 0.4, y: 0.2, width: 0.52, height: 0.14 }, dish: { x: 0.4, y: 0.38, width: 0.52, height: 0.32 }, cta: { x: 0.4, y: 0.74, width: 0.28, height: 0.12 } }
            },
            { id: 125, name: 'Combo Meal Deal', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fb923c', '#f97316'] },
              layout: { offer: { x: 0.15, y: 0.12, width: 0.7, height: 0.16 }, items: { x: 0.1, y: 0.34, width: 0.8, height: 0.42 }, price: { x: 0.35, y: 0.8, width: 0.3, height: 0.14 } }
            },

            // Cafe & Beverages (126-130)
            { id: 126, name: 'Coffee Shop Promo', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#78350f', '#451a03'] },
              layout: { cup: { x: 0.25, y: 0.15, width: 0.5, height: 0.5 }, offer: { x: 0.15, y: 0.7, width: 0.7, height: 0.12 }, cta: { x: 0.3, y: 0.86, width: 0.4, height: 0.1 } }
            },
            { id: 127, name: 'New Drink Launch', category: 'food', width: 1080, height: 1920,
              background: { type: 'gradient', colors: ['#fef3c7', '#fde68a'] },
              layout: { badge: { x: 0.3, y: 0.08, width: 0.4, height: 0.1 }, drink: { x: 0.2, y: 0.22, width: 0.6, height: 0.5 }, name: { x: 0.1, y: 0.76, width: 0.8, height: 0.1 }, cta: { x: 0.3, y: 0.89, width: 0.4, height: 0.08 } }
            },
            { id: 128, name: 'Smoothie Bowl Special', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ddd6fe', '#c4b5fd'] },
              layout: { product: { x: 0.15, y: 0.12, width: 0.7, height: 0.58 }, title: { x: 0.1, y: 0.74, width: 0.8, height: 0.1 }, ingredients: { x: 0.1, y: 0.87, width: 0.8, height: 0.08 } }
            },
            { id: 129, name: 'Happy Hour Drinks', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#c026d3', '#a21caf'] },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.16 }, time: { x: 0.15, y: 0.36, width: 0.7, height: 0.12 }, drinks: { x: 0.1, y: 0.52, width: 0.8, height: 0.36 } }
            },
            { id: 130, name: 'Bubble Tea Menu', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fecaca', '#fca5a5'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, flavors: { x: 0.1, y: 0.26, width: 0.8, height: 0.6 }, footer: { x: 0.1, y: 0.9, width: 0.8, height: 0.07 } }
            },

            // Bakery & Desserts (131-135)
            { id: 131, name: 'Bakery Fresh Daily', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fed7aa', '#fdba74'] },
              layout: { badge: { x: 0.35, y: 0.12, width: 0.3, height: 0.16 }, products: { x: 0.1, y: 0.34, width: 0.8, height: 0.48 }, cta: { x: 0.35, y: 0.86, width: 0.3, height: 0.1 } }
            },
            { id: 132, name: 'Cake of the Month', category: 'food', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fef2f2' },
              layout: { month: { x: 0.25, y: 0.1, width: 0.5, height: 0.1 }, cake: { x: 0.15, y: 0.24, width: 0.7, height: 0.52 }, details: { x: 0.15, y: 0.8, width: 0.7, height: 0.14 } }
            },
            { id: 133, name: 'Dessert Specials', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fae8ff', '#f5d0fe'] },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.14 }, item1: { x: 0.08, y: 0.36, width: 0.28, height: 0.52 }, item2: { x: 0.38, y: 0.36, width: 0.28, height: 0.52 }, item3: { x: 0.68, y: 0.36, width: 0.28, height: 0.52 } }
            },
            { id: 134, name: 'Cupcake Collection', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbcfe8', '#f9a8d4'] },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.12 }, cupcakes: { x: 0.1, y: 0.28, width: 0.8, height: 0.58 }, order: { x: 0.3, y: 0.9, width: 0.4, height: 0.08 } }
            },
            { id: 135, name: 'Ice Cream Flavors', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#a5f3fc', '#67e8f9'] },
              layout: { header: { x: 0.2, y: 0.12, width: 0.6, height: 0.14 }, scoop1: { x: 0.1, y: 0.32, width: 0.26, height: 0.58 }, scoop2: { x: 0.38, y: 0.32, width: 0.26, height: 0.58 }, scoop3: { x: 0.66, y: 0.32, width: 0.26, height: 0.58 } }
            },

            // Delivery & Takeout (136-140)
            { id: 136, name: 'Food Delivery Promo', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { icon: { x: 0.08, y: 0.25, width: 0.2, height: 0.5 }, title: { x: 0.32, y: 0.22, width: 0.6, height: 0.16 }, offer: { x: 0.32, y: 0.42, width: 0.6, height: 0.2 }, code: { x: 0.32, y: 0.66, width: 0.4, height: 0.12 } }
            },
            { id: 137, name: 'Free Delivery Banner', category: 'food', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { badge: { x: 0.25, y: 0.15, width: 0.5, height: 0.18 }, details: { x: 0.15, y: 0.38, width: 0.7, height: 0.32 }, cta: { x: 0.3, y: 0.74, width: 0.4, height: 0.12 }, terms: { x: 0.15, y: 0.9, width: 0.7, height: 0.06 } }
            },
            { id: 138, name: 'Order Now Deal', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.16 }, food: { x: 0.15, y: 0.4, width: 0.7, height: 0.32 }, button: { x: 0.35, y: 0.76, width: 0.3, height: 0.14 } }
            },
            { id: 139, name: 'Takeout Special', category: 'food', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, meal: { x: 0.15, y: 0.3, width: 0.7, height: 0.45 }, discount: { x: 0.25, y: 0.8, width: 0.5, height: 0.14 } }
            },
            { id: 140, name: 'Quick Bites', category: 'food', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f97316', '#ea580c'] },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.16 }, items: { x: 0.1, y: 0.36, width: 0.8, height: 0.42 }, time: { x: 0.35, y: 0.82, width: 0.3, height: 0.1 } }
            },

            // ============================================
            // REAL ESTATE TEMPLATES - BATCH 8 (20 Templates)
            // ============================================
            
            // Property Listings (141-145)
            { id: 141, name: 'Luxury Home Listing', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#1e293b', '#0f172a'] },
              layout: { image: { x: 0.05, y: 0.1, width: 0.52, height: 0.8 }, price: { x: 0.6, y: 0.18, width: 0.35, height: 0.14 }, features: { x: 0.6, y: 0.36, width: 0.35, height: 0.32 }, contact: { x: 0.6, y: 0.72, width: 0.35, height: 0.14 } }
            },
            { id: 142, name: 'Apartment For Rent', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'solid', color: '#f0f9ff' },
              layout: { image: { x: 0.1, y: 0.1, width: 0.8, height: 0.48 }, rent: { x: 0.1, y: 0.62, width: 0.8, height: 0.12 }, specs: { x: 0.1, y: 0.78, width: 0.8, height: 0.16 } }
            },
            { id: 143, name: 'New Development', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#3b82f6', '#2563eb'] },
              layout: { project: { x: 0.1, y: 0.15, width: 0.8, height: 0.16 }, render: { x: 0.1, y: 0.36, width: 0.8, height: 0.42 }, info: { x: 0.35, y: 0.82, width: 0.3, height: 0.12 } }
            },
            { id: 144, name: 'Property Features', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#f9fafb', '#f3f4f6'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.1 }, feat1: { x: 0.1, y: 0.24, width: 0.38, height: 0.32 }, feat2: { x: 0.52, y: 0.24, width: 0.38, height: 0.32 }, feat3: { x: 0.1, y: 0.6, width: 0.38, height: 0.32 }, feat4: { x: 0.52, y: 0.6, width: 0.38, height: 0.32 } }
            },
            { id: 145, name: 'House Tour Banner', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { image: { x: 0.08, y: 0.15, width: 0.4, height: 0.7 }, title: { x: 0.52, y: 0.22, width: 0.42, height: 0.14 }, details: { x: 0.52, y: 0.4, width: 0.42, height: 0.28 }, schedule: { x: 0.52, y: 0.72, width: 0.3, height: 0.13 } }
            },

            // Open Houses & Events (146-150)
            { id: 146, name: 'Open House This Weekend', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.16 }, address: { x: 0.15, y: 0.32, width: 0.7, height: 0.12 }, date_time: { x: 0.15, y: 0.48, width: 0.7, height: 0.2 }, agent: { x: 0.15, y: 0.72, width: 0.7, height: 0.16 } }
            },
            { id: 147, name: 'Virtual Tour Available', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#8b5cf6', '#7c3aed'] },
              layout: { icon: { x: 0.35, y: 0.15, width: 0.3, height: 0.22 }, title: { x: 0.1, y: 0.42, width: 0.8, height: 0.12 }, property: { x: 0.1, y: 0.58, width: 0.8, height: 0.2 }, cta: { x: 0.3, y: 0.82, width: 0.4, height: 0.12 } }
            },
            { id: 148, name: 'Just Listed', category: 'realestate', width: 1200, height: 628,
              background: { type: 'solid', color: '#dc2626' },
              layout: { badge: { x: 0.35, y: 0.15, width: 0.3, height: 0.18 }, property: { x: 0.15, y: 0.38, width: 0.7, height: 0.32 }, contact: { x: 0.35, y: 0.74, width: 0.3, height: 0.14 } }
            },
            { id: 149, name: 'Coming Soon Property', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { badge: { x: 0.25, y: 0.12, width: 0.5, height: 0.14 }, teaser: { x: 0.1, y: 0.3, width: 0.8, height: 0.42 }, register: { x: 0.3, y: 0.76, width: 0.4, height: 0.1 }, date: { x: 0.25, y: 0.9, width: 0.5, height: 0.06 } }
            },
            { id: 150, name: 'Price Reduced', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { alert: { x: 0.2, y: 0.12, width: 0.6, height: 0.16 }, old_price: { x: 0.2, y: 0.34, width: 0.6, height: 0.1 }, new_price: { x: 0.2, y: 0.48, width: 0.6, height: 0.18 }, cta: { x: 0.35, y: 0.7, width: 0.3, height: 0.16 } }
            },

            // Agent & Broker (151-155)
            { id: 151, name: 'Meet Your Agent', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'solid', color: '#f8fafc' },
              layout: { photo: { x: 0.25, y: 0.12, width: 0.5, height: 0.42 }, name: { x: 0.15, y: 0.58, width: 0.7, height: 0.1 }, credentials: { x: 0.15, y: 0.7, width: 0.7, height: 0.14 }, contact: { x: 0.3, y: 0.88, width: 0.4, height: 0.08 } }
            },
            { id: 152, name: 'Sold by Agent', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { sold: { x: 0.3, y: 0.15, width: 0.4, height: 0.2 }, property: { x: 0.15, y: 0.4, width: 0.7, height: 0.28 }, agent: { x: 0.15, y: 0.72, width: 0.7, height: 0.16 } }
            },
            { id: 153, name: 'Real Estate Team', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#1e40af', '#1e3a8a'] },
              layout: { title: { x: 0.2, y: 0.12, width: 0.6, height: 0.14 }, team: { x: 0.1, y: 0.32, width: 0.8, height: 0.48 }, tagline: { x: 0.2, y: 0.84, width: 0.6, height: 0.1 } }
            },
            { id: 154, name: 'Agent Success Stats', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { agent: { x: 0.3, y: 0.12, width: 0.4, height: 0.32 }, stat1: { x: 0.1, y: 0.48, width: 0.8, height: 0.12 }, stat2: { x: 0.1, y: 0.64, width: 0.8, height: 0.12 }, stat3: { x: 0.1, y: 0.8, width: 0.8, height: 0.12 } }
            },
            { id: 155, name: 'Broker Open House', category: 'realestate', width: 1200, height: 628,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.16 }, property: { x: 0.15, y: 0.36, width: 0.7, height: 0.32 }, details: { x: 0.15, y: 0.72, width: 0.7, height: 0.16 } }
            },

            // Commercial & Investment (156-160)
            { id: 156, name: 'Commercial Property', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#475569', '#334155'] },
              layout: { building: { x: 0.08, y: 0.12, width: 0.45, height: 0.76 }, type: { x: 0.56, y: 0.18, width: 0.38, height: 0.12 }, specs: { x: 0.56, y: 0.34, width: 0.38, height: 0.4 }, contact: { x: 0.56, y: 0.78, width: 0.28, height: 0.12 } }
            },
            { id: 157, name: 'Investment Opportunity', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, property: { x: 0.1, y: 0.3, width: 0.8, height: 0.38 }, roi: { x: 0.1, y: 0.72, width: 0.8, height: 0.18 } }
            },
            { id: 158, name: 'Office Space Lease', category: 'realestate', width: 1200, height: 628,
              background: { type: 'solid', color: '#f0f9ff' },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.14 }, space: { x: 0.1, y: 0.34, width: 0.8, height: 0.4 }, terms: { x: 0.35, y: 0.78, width: 0.3, height: 0.14 } }
            },
            { id: 159, name: 'Retail Space Available', category: 'realestate', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.12 }, location: { x: 0.1, y: 0.26, width: 0.8, height: 0.48 }, details: { x: 0.1, y: 0.78, width: 0.8, height: 0.16 } }
            },
            { id: 160, name: 'Land For Sale', category: 'realestate', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#16a34a', '#15803d'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.14 }, map: { x: 0.15, y: 0.38, width: 0.7, height: 0.36 }, acreage: { x: 0.35, y: 0.78, width: 0.3, height: 0.14 } }
            },

            // ============================================
            // EDUCATION TEMPLATES - BATCH 9 (20 Templates)
            // ============================================
            
            // Courses & Classes (161-165)
            { id: 161, name: 'Online Course Launch', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { title: { x: 0.1, y: 0.18, width: 0.8, height: 0.16 }, description: { x: 0.1, y: 0.38, width: 0.8, height: 0.28 }, enroll: { x: 0.35, y: 0.7, width: 0.3, height: 0.16 } }
            },
            { id: 162, name: 'Enroll Now Banner', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { badge: { x: 0.3, y: 0.12, width: 0.4, height: 0.12 }, course: { x: 0.1, y: 0.28, width: 0.8, height: 0.44 }, cta: { x: 0.3, y: 0.76, width: 0.4, height: 0.12 }, deadline: { x: 0.25, y: 0.92, width: 0.5, height: 0.06 } }
            },
            { id: 163, name: 'New Course Alert', category: 'education', width: 1200, height: 628,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { badge: { x: 0.08, y: 0.12, width: 0.2, height: 0.14 }, title: { x: 0.08, y: 0.3, width: 0.84, height: 0.18 }, details: { x: 0.08, y: 0.52, width: 0.84, height: 0.24 }, button: { x: 0.35, y: 0.8, width: 0.3, height: 0.14 } }
            },
            { id: 164, name: 'Class Schedule', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#dbeafe', '#bfdbfe'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, schedule: { x: 0.1, y: 0.26, width: 0.8, height: 0.6 }, register: { x: 0.3, y: 0.9, width: 0.4, height: 0.08 } }
            },
            { id: 165, name: 'Certification Program', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#a855f7', '#9333ea'] },
              layout: { cert_icon: { x: 0.42, y: 0.1, width: 0.16, height: 0.2 }, program: { x: 0.15, y: 0.36, width: 0.7, height: 0.14 }, benefits: { x: 0.15, y: 0.54, width: 0.7, height: 0.26 }, apply: { x: 0.35, y: 0.84, width: 0.3, height: 0.12 } }
            },

            // Workshops & Webinars (166-170)
            { id: 166, name: 'Workshop Invitation', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { title: { x: 0.1, y: 0.15, width: 0.8, height: 0.18 }, speaker: { x: 0.1, y: 0.38, width: 0.4, height: 0.14 }, date: { x: 0.54, y: 0.38, width: 0.36, height: 0.14 }, topics: { x: 0.1, y: 0.56, width: 0.8, height: 0.2 }, register: { x: 0.35, y: 0.8, width: 0.3, height: 0.14 } }
            },
            { id: 167, name: 'Free Webinar', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { free_badge: { x: 0.35, y: 0.08, width: 0.3, height: 0.12 }, topic: { x: 0.1, y: 0.24, width: 0.8, height: 0.16 }, presenter: { x: 0.1, y: 0.44, width: 0.8, height: 0.28 }, join: { x: 0.3, y: 0.76, width: 0.4, height: 0.12 }, datetime: { x: 0.2, y: 0.92, width: 0.6, height: 0.06 } }
            },
            { id: 168, name: 'Masterclass Series', category: 'education', width: 1200, height: 628,
              background: { type: 'solid', color: '#1e293b' },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.16 }, instructor: { x: 0.15, y: 0.4, width: 0.7, height: 0.24 }, enroll: { x: 0.35, y: 0.68, width: 0.3, height: 0.16 } }
            },
            { id: 169, name: 'Training Session', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, content: { x: 0.1, y: 0.3, width: 0.8, height: 0.48 }, signup: { x: 0.3, y: 0.82, width: 0.4, height: 0.12 } }
            },
            { id: 170, name: 'Expert Talk', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#7c3aed', '#6d28d9'] },
              layout: { expert: { x: 0.08, y: 0.18, width: 0.32, height: 0.64 }, topic: { x: 0.44, y: 0.22, width: 0.48, height: 0.18 }, details: { x: 0.44, y: 0.44, width: 0.48, height: 0.26 }, reserve: { x: 0.44, y: 0.74, width: 0.28, height: 0.12 } }
            },

            // Student Life (171-175)
            { id: 171, name: 'Campus Life', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fbbf24', '#f59e0b'] },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, images: { x: 0.1, y: 0.3, width: 0.8, height: 0.52 }, tagline: { x: 0.15, y: 0.86, width: 0.7, height: 0.1 } }
            },
            { id: 172, name: 'Student Achievement', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#3b82f6', '#2563eb'] },
              layout: { trophy: { x: 0.08, y: 0.2, width: 0.24, height: 0.6 }, student: { x: 0.36, y: 0.22, width: 0.56, height: 0.14 }, achievement: { x: 0.36, y: 0.4, width: 0.56, height: 0.24 }, congrats: { x: 0.36, y: 0.68, width: 0.4, height: 0.12 } }
            },
            { id: 173, name: 'Study Tips', category: 'education', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, tip1: { x: 0.1, y: 0.26, width: 0.8, height: 0.18 }, tip2: { x: 0.1, y: 0.48, width: 0.8, height: 0.18 }, tip3: { x: 0.1, y: 0.7, width: 0.8, height: 0.18 } }
            },
            { id: 174, name: 'Scholarship Available', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { badge: { x: 0.3, y: 0.12, width: 0.4, height: 0.18 }, amount: { x: 0.25, y: 0.36, width: 0.5, height: 0.16 }, eligibility: { x: 0.15, y: 0.56, width: 0.7, height: 0.2 }, apply: { x: 0.35, y: 0.8, width: 0.3, height: 0.14 } }
            },
            { id: 175, name: 'Alumni Network', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#1e40af', '#1e3a8a'] },
              layout: { title: { x: 0.1, y: 0.15, width: 0.8, height: 0.14 }, stats: { x: 0.1, y: 0.34, width: 0.8, height: 0.42 }, join: { x: 0.3, y: 0.8, width: 0.4, height: 0.12 } }
            },

            // E-Learning (176-180)
            { id: 176, name: 'Learn at Your Pace', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#a855f7', '#9333ea'] },
              layout: { icon: { x: 0.42, y: 0.12, width: 0.16, height: 0.2 }, title: { x: 0.15, y: 0.38, width: 0.7, height: 0.14 }, benefits: { x: 0.15, y: 0.56, width: 0.7, height: 0.2 }, start: { x: 0.35, y: 0.8, width: 0.3, height: 0.14 } }
            },
            { id: 177, name: 'Digital Learning', category: 'education', width: 1080, height: 1080,
              background: { type: 'solid', color: '#e0f2fe' },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, features: { x: 0.1, y: 0.3, width: 0.8, height: 0.52 }, cta: { x: 0.3, y: 0.86, width: 0.4, height: 0.1 } }
            },
            { id: 178, name: 'Video Course', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { play_icon: { x: 0.42, y: 0.28, width: 0.16, height: 0.24 }, title: { x: 0.15, y: 0.58, width: 0.7, height: 0.12 }, duration: { x: 0.35, y: 0.74, width: 0.3, height: 0.08 }, watch: { x: 0.35, y: 0.86, width: 0.3, height: 0.1 } }
            },
            { id: 179, name: 'Interactive Lessons', category: 'education', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#ec4899', '#be185d'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, lesson: { x: 0.1, y: 0.26, width: 0.8, height: 0.5 }, try: { x: 0.3, y: 0.8, width: 0.4, height: 0.12 }, free: { x: 0.35, y: 0.94, width: 0.3, height: 0.04 } }
            },
            { id: 180, name: 'Learning Platform', category: 'education', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { logo: { x: 0.08, y: 0.12, width: 0.16, height: 0.16 }, platform: { x: 0.08, y: 0.34, width: 0.84, height: 0.16 }, courses: { x: 0.08, y: 0.54, width: 0.84, height: 0.24 }, join: { x: 0.35, y: 0.82, width: 0.3, height: 0.12 } }
            },

            // ============================================
            // HEALTHCARE TEMPLATES - BATCH 10 (20 Templates)
            // ============================================
            
            // Medical Services (181-185)
            { id: 181, name: 'Medical Clinic Banner', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { logo: { x: 0.08, y: 0.15, width: 0.18, height: 0.18 }, title: { x: 0.08, y: 0.38, width: 0.84, height: 0.14 }, services: { x: 0.08, y: 0.56, width: 0.84, height: 0.22 }, book: { x: 0.35, y: 0.82, width: 0.3, height: 0.12 } }
            },
            { id: 182, name: 'Health Checkup Promo', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.14 }, package: { x: 0.1, y: 0.28, width: 0.8, height: 0.44 }, price: { x: 0.35, y: 0.76, width: 0.3, height: 0.12 }, schedule: { x: 0.3, y: 0.92, width: 0.4, height: 0.06 } }
            },
            { id: 183, name: 'Vaccination Drive', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'solid', color: '#ecfdf5' },
              layout: { icon: { x: 0.08, y: 0.22, width: 0.2, height: 0.56 }, title: { x: 0.32, y: 0.2, width: 0.6, height: 0.16 }, details: { x: 0.32, y: 0.4, width: 0.6, height: 0.28 }, register: { x: 0.32, y: 0.72, width: 0.28, height: 0.14 } }
            },
            { id: 184, name: 'Dental Care Offer', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#6366f1', '#4f46e5'] },
              layout: { header: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, services: { x: 0.1, y: 0.3, width: 0.8, height: 0.46 }, discount: { x: 0.25, y: 0.8, width: 0.5, height: 0.14 } }
            },
            { id: 185, name: 'Eye Care Center', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#a855f7', '#9333ea'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.16 }, services: { x: 0.15, y: 0.4, width: 0.7, height: 0.32 }, contact: { x: 0.35, y: 0.76, width: 0.3, height: 0.14 } }
            },

            // Wellness & Fitness (186-190)
            { id: 186, name: 'Gym Membership Deal', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#ef4444', '#dc2626'] },
              layout: { offer: { x: 0.15, y: 0.15, width: 0.7, height: 0.18 }, benefits: { x: 0.15, y: 0.38, width: 0.7, height: 0.32 }, join: { x: 0.35, y: 0.74, width: 0.3, height: 0.16 } }
            },
            { id: 187, name: 'Yoga Class Schedule', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#fef3c7', '#fde68a'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, classes: { x: 0.1, y: 0.26, width: 0.8, height: 0.6 }, register: { x: 0.3, y: 0.9, width: 0.4, height: 0.08 } }
            },
            { id: 188, name: 'Fitness Challenge', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { badge: { x: 0.35, y: 0.12, width: 0.3, height: 0.16 }, challenge: { x: 0.15, y: 0.34, width: 0.7, height: 0.28 }, participate: { x: 0.35, y: 0.66, width: 0.3, height: 0.14 }, dates: { x: 0.25, y: 0.84, width: 0.5, height: 0.1 } }
            },
            { id: 189, name: 'Wellness Program', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'solid', color: '#d1fae5' },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, features: { x: 0.1, y: 0.3, width: 0.8, height: 0.52 }, enroll: { x: 0.3, y: 0.86, width: 0.4, height: 0.1 } }
            },
            { id: 190, name: 'Nutrition Consultation', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { icon: { x: 0.08, y: 0.24, width: 0.2, height: 0.52 }, service: { x: 0.32, y: 0.22, width: 0.6, height: 0.14 }, details: { x: 0.32, y: 0.4, width: 0.6, height: 0.24 }, book: { x: 0.32, y: 0.68, width: 0.28, height: 0.14 } }
            },

            // Mental Health (191-195)
            { id: 191, name: 'Mental Health Awareness', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#c4b5fd', '#a78bfa'] },
              layout: { icon: { x: 0.4, y: 0.12, width: 0.2, height: 0.18 }, title: { x: 0.1, y: 0.36, width: 0.8, height: 0.14 }, message: { x: 0.1, y: 0.54, width: 0.8, height: 0.28 }, resources: { x: 0.3, y: 0.86, width: 0.4, height: 0.1 } }
            },
            { id: 192, name: 'Therapy Services', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#7c3aed', '#6d28d9'] },
              layout: { title: { x: 0.15, y: 0.18, width: 0.7, height: 0.16 }, services: { x: 0.15, y: 0.4, width: 0.7, height: 0.28 }, schedule: { x: 0.35, y: 0.72, width: 0.3, height: 0.14 } }
            },
            { id: 193, name: 'Meditation App', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'solid', color: '#e0f2fe' },
              layout: { title: { x: 0.1, y: 0.15, width: 0.8, height: 0.12 }, app_screen: { x: 0.2, y: 0.32, width: 0.6, height: 0.44 }, download: { x: 0.3, y: 0.8, width: 0.4, height: 0.12 }, free: { x: 0.35, y: 0.94, width: 0.3, height: 0.04 } }
            },
            { id: 194, name: 'Stress Relief Tips', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#fae8ff', '#f5d0fe'] },
              layout: { header: { x: 0.15, y: 0.12, width: 0.7, height: 0.14 }, tip1: { x: 0.08, y: 0.32, width: 0.42, height: 0.56 }, tip2: { x: 0.52, y: 0.32, width: 0.42, height: 0.56 } }
            },
            { id: 195, name: 'Counseling Services', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#14b8a6', '#0d9488'] },
              layout: { title: { x: 0.1, y: 0.14, width: 0.8, height: 0.14 }, info: { x: 0.1, y: 0.32, width: 0.8, height: 0.44 }, contact: { x: 0.3, y: 0.8, width: 0.4, height: 0.12 }, confidential: { x: 0.2, y: 0.94, width: 0.6, height: 0.04 } }
            },

            // Healthcare Tips & Prevention (196-200)
            { id: 196, name: 'Health Tips Daily', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fef3c7' },
              layout: { icon: { x: 0.4, y: 0.1, width: 0.2, height: 0.16 }, tip_title: { x: 0.1, y: 0.3, width: 0.8, height: 0.12 }, content: { x: 0.1, y: 0.46, width: 0.8, height: 0.4 } }
            },
            { id: 197, name: 'Disease Prevention', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#0ea5e9', '#0284c7'] },
              layout: { title: { x: 0.15, y: 0.15, width: 0.7, height: 0.14 }, steps: { x: 0.1, y: 0.34, width: 0.8, height: 0.48 }, learn_more: { x: 0.35, y: 0.86, width: 0.3, height: 0.1 } }
            },
            { id: 198, name: 'Healthy Lifestyle', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'gradient', colors: ['#10b981', '#059669'] },
              layout: { header: { x: 0.1, y: 0.1, width: 0.8, height: 0.12 }, habits: { x: 0.1, y: 0.26, width: 0.8, height: 0.6 }, start: { x: 0.3, y: 0.9, width: 0.4, height: 0.08 } }
            },
            { id: 199, name: 'Annual Health Screen', category: 'healthcare', width: 1200, height: 628,
              background: { type: 'gradient', colors: ['#f59e0b', '#ea580c'] },
              layout: { badge: { x: 0.3, y: 0.1, width: 0.4, height: 0.16 }, tests: { x: 0.15, y: 0.32, width: 0.7, height: 0.36 }, book: { x: 0.35, y: 0.72, width: 0.3, height: 0.16 } }
            },
            { id: 200, name: 'Healthcare at Home', category: 'healthcare', width: 1080, height: 1080,
              background: { type: 'solid', color: '#fef2f2' },
              layout: { title: { x: 0.1, y: 0.12, width: 0.8, height: 0.14 }, services: { x: 0.1, y: 0.3, width: 0.8, height: 0.52 }, call: { x: 0.3, y: 0.86, width: 0.4, height: 0.1 } }
            }
        ];

        function openTemplatesPanel() {
            const modal = document.getElementById('templatesModal');
            modal.classList.add('active');
            renderTemplates('all');
            
            // Setup category filters
            document.querySelectorAll('#templatesModal .category-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#templatesModal .category-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderTemplates(btn.dataset.category);
                });
            });
        }

        function closeTemplatesPanel() {
            document.getElementById('templatesModal').classList.remove('active');
        }

        function renderTemplates(category) {
            const grid = document.getElementById('templatesGrid');
            const filtered = category === 'all' ? templates : templates.filter(t => t.category === category);
            
            grid.innerHTML = filtered.map(template => {
                // Create background style
                const bgStyle = template.background.type === 'gradient' 
                    ? `linear-gradient(135deg, ${template.background.colors[0]}, ${template.background.colors[1]})` 
                    : template.background.color;
                
                // Create layout visualization
                const layoutBoxes = template.layout ? Object.values(template.layout).map((pos, i) => {
                    const left = (pos.x * 100).toFixed(1);
                    const top = (pos.y * 100).toFixed(1);
                    const width = (pos.width * 100).toFixed(1);
                    const height = (pos.height * 100).toFixed(1);
                    return `<div style="position: absolute; left: ${left}%; top: ${top}%; width: ${width}%; height: ${height}%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); border-radius: 4px;"></div>`;
                }).join('') : '';
                
                return `
                    <div class="template-card" onclick="applyTemplate(${template.id})">
                        <div class="template-preview" style="background: ${bgStyle}; position: relative; overflow: hidden;">
                            ${layoutBoxes}
                        </div>
                        <div class="template-info">
                            <div class="template-name">${template.name}</div>
                            <div class="template-category">${template.width}  ${template.height}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function applyTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            // Save current state before applying template
            if (!appliedTemplate) {
                preTemplateState = {
                    dimensions: { ...canvasState.dimensions },
                    background: { ...canvasState.background },
                    elements: JSON.parse(JSON.stringify(canvasState.elements))
                };
            }
            
            appliedTemplate = template;
            
            // Apply template dimensions and background
            canvasState.dimensions = { width: template.width, height: template.height };
            canvasState.background = { ...template.background };
            
            // Update canvas size
            const canvas = document.getElementById('mainCanvas');
            canvas.width = template.width;
            canvas.height = template.height;
            
            // Update custom size inputs
            document.getElementById('customWidth').value = template.width;
            document.getElementById('customHeight').value = template.height;
            
            // Arrange existing elements according to template layout
            if (canvasState.elements.length > 0 && template.layout) {
                arrangeElementsToLayout(template.layout);
            }
            
            // Show remove template button
            const removeBtn = document.getElementById('removeTemplateBtn');
            if (removeBtn) removeBtn.style.display = 'block';
            
            closeTemplatesPanel();
            selectElement(null);
            renderCanvas();
            renderLayers();
            showToast(`Applied "${template.name}" layout`, 'success');
        }

        function arrangeElementsToLayout(layout) {
            const canvasWidth = canvasState.dimensions.width;
            const canvasHeight = canvasState.dimensions.height;
            const layoutKeys = Object.keys(layout);
            
            // Sort elements by type priority (text first, then images, then others)
            const sortedElements = [...canvasState.elements].sort((a, b) => {
                const priority = { text: 0, image: 1, shape: 2 };
                return (priority[a.type] || 3) - (priority[b.type] || 3);
            });
            
            // Assign elements to layout positions
            sortedElements.forEach((element, index) => {
                if (index < layoutKeys.length) {
                    const layoutKey = layoutKeys[index];
                    const position = layout[layoutKey];
                    
                    // Convert relative positions to absolute pixels
                    element.x = Math.round(position.x * canvasWidth);
                    element.y = Math.round(position.y * canvasHeight);
                    element.width = Math.round(position.width * canvasWidth);
                    element.height = Math.round(position.height * canvasHeight);
                    
                    // Adjust text size proportionally if it's a text element
                    if (element.type === 'text' && element.fontSize) {
                        element.fontSize = Math.round((element.height * 0.6)); // Approximate font size
                    }
                }
            });
        }

        function removeTemplate() {
            if (!appliedTemplate || !preTemplateState) {
                showToast('No template applied', 'info');
                return;
            }
            
            // Restore pre-template state
            canvasState.dimensions = { ...preTemplateState.dimensions };
            canvasState.background = { ...preTemplateState.background };
            canvasState.elements = JSON.parse(JSON.stringify(preTemplateState.elements));
            
            // Update canvas size
            const canvas = document.getElementById('mainCanvas');
            canvas.width = preTemplateState.dimensions.width;
            canvas.height = preTemplateState.dimensions.height;
            
            // Update custom size inputs
            document.getElementById('customWidth').value = preTemplateState.dimensions.width;
            document.getElementById('customHeight').value = preTemplateState.dimensions.height;
            
            // Clear template state
            appliedTemplate = null;
            preTemplateState = null;
            
            // Hide remove template button
            const removeBtn = document.getElementById('removeTemplateBtn');
            if (removeBtn) removeBtn.style.display = 'none';
            
            selectElement(null);
            renderCanvas();
            renderLayers();
            showToast('Template removed - restored previous design', 'success');
        }

        // ============================================
        // RESIZE CANVAS
        // ============================================
        const resizePresets = [
            { name: 'Amazon Banner', width: 1200, height: 628, icon: 'fa-amazon', platform: 'amazon' },
            { name: 'Flipkart Banner', width: 1200, height: 628, icon: 'fa-shopping-cart', platform: 'flipkart' },
            { name: 'Instagram Post', width: 1080, height: 1080, icon: 'fa-instagram', platform: 'instagram' },
            { name: 'Instagram Story', width: 1080, height: 1920, icon: 'fa-mobile-alt', platform: 'story' },
            { name: 'Facebook Ad', width: 1200, height: 628, icon: 'fa-facebook', platform: 'facebook' },
            { name: 'Twitter Post', width: 1200, height: 675, icon: 'fa-twitter', platform: 'twitter' },
            { name: 'YouTube Thumbnail', width: 1280, height: 720, icon: 'fa-youtube', platform: 'youtube' },
            { name: 'LinkedIn Post', width: 1200, height: 627, icon: 'fa-linkedin', platform: 'linkedin' }
        ];

        function openResizePanel() {
            const modal = document.getElementById('resizeModal');
            modal.classList.add('active');
            
            const optionsContainer = document.getElementById('resizeOptions');
            optionsContainer.innerHTML = resizePresets.map((preset, i) => `
                <div class="resize-option" data-index="${i}" onclick="selectResizePreset(${i})">
                    <div class="resize-icon">
                        <i class="fab ${preset.icon}"></i>
                    </div>
                    <div class="resize-name">${preset.name}</div>
                    <div class="resize-dimensions">${preset.width}  ${preset.height}</div>
                </div>
            `).join('');
            
            // Update custom inputs with current size
            document.getElementById('customWidth').value = canvasState.dimensions.width;
            document.getElementById('customHeight').value = canvasState.dimensions.height;
        }

        function closeResizePanel() {
            document.getElementById('resizeModal').classList.remove('active');
        }

        function selectResizePreset(index) {
            const preset = resizePresets[index];
            
            // Update selection UI
            document.querySelectorAll('.resize-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.resize-option[data-index="${index}"]`).classList.add('selected');
            
            // Update custom inputs
            document.getElementById('customWidth').value = preset.width;
            document.getElementById('customHeight').value = preset.height;
            
            // Apply resize
            resizeCanvas(preset.width, preset.height);
            closeResizePanel();
            showToast(`Resized to ${preset.name} (${preset.width}${preset.height})`, 'success');
        }

        function applyCustomSize() {
            const width = parseInt(document.getElementById('customWidth').value);
            const height = parseInt(document.getElementById('customHeight').value);
            
            if (width < 100 || height < 100) {
                showToast('Minimum size is 100100', 'error');
                return;
            }
            if (width > 4096 || height > 4096) {
                showToast('Maximum size is 40964096', 'error');
                return;
            }
            
            resizeCanvas(width, height);
            closeResizePanel();
            showToast(`Canvas resized to ${width}${height}`, 'success');
        }

        function resizeCanvas(newWidth, newHeight) {
            const oldWidth = canvasState.dimensions.width;
            const oldHeight = canvasState.dimensions.height;
            
            // Scale factor
            const scaleX = newWidth / oldWidth;
            const scaleY = newHeight / oldHeight;
            const scale = Math.min(scaleX, scaleY);
            
            // Update dimensions
            canvasState.dimensions = { width: newWidth, height: newHeight };
            
            // Scale elements (optional - preserve proportions)
            canvasState.elements.forEach(el => {
                el.x = Math.round(el.x * scaleX);
                el.y = Math.round(el.y * scaleY);
                // Optionally scale size
                // el.width = Math.round(el.width * scale);
                // el.height = Math.round(el.height * scale);
                // el.fontSize = Math.round(el.fontSize * scale);
            });
            
            // Update canvas
            const canvas = document.getElementById('mainCanvas');
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            renderCanvas();
        }

        // ============================================
        // IMAGE UPLOAD & HANDLING
        // ============================================
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Calculate position (center of canvas)
                    const maxWidth = canvasState.dimensions.width * 0.5;
                    const maxHeight = canvasState.dimensions.height * 0.5;
                    const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);
                    const width = Math.round(img.width * scale);
                    const height = Math.round(img.height * scale);
                    
                    const newElement = {
                        id: `el-${Date.now()}`,
                        type: 'image',
                        name: `Image ${canvasState.elements.filter(el => el.type === 'image').length + 1}`,
                        src: e.target.result,
                        x: Math.round((canvasState.dimensions.width - width) / 2),
                        y: Math.round((canvasState.dimensions.height - height) / 2),
                        width: width,
                        height: height,
                        visible: true,
                        effects: {
                            brightness: 100,
                            contrast: 100,
                            saturation: 100,
                            opacity: 100
                        }
                    };
                    
                    canvasState.elements.push(newElement);
                    selectElement(newElement);
                    renderCanvas();
                    renderLayers();
                    showToast('Image added', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Reset input
            event.target.value = '';
        }

        // ============================================
        // BACKGROUND REMOVAL (AI) - Using Python rembg
        // ============================================
        
        async function removeBackground() {
            if (!selectedElement || selectedElement.type !== 'image') {
                showToast('Select an image element first', 'warning');
                return;
            }
            
            showProcessing('Connecting to AI server...');
            
            try {
                // Get image data
                let blob;
                if (selectedElement.src.startsWith('data:')) {
                    // Convert data URL to blob
                    const response = await fetch(selectedElement.src);
                    blob = await response.blob();
                } else {
                    const response = await fetch(selectedElement.src);
                    blob = await response.blob();
                }
                
                const formData = new FormData();
                formData.append('file', blob, 'image.png');
                
                showProcessing('Removing background with AI (this may take 10-30 seconds on first use)...');
                
                // Call the backend API with longer timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
                
                let result;
                try {
                    result = await fetch('http://localhost:8000/api/ai/remove-background', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    throw new Error('Cannot connect to AI server. Make sure backend is running on port 8000.');
                }
                
                clearTimeout(timeoutId);
                
                // Read response body once
                const responseText = await result.text();
                console.log('Background removal raw response:', responseText.substring(0, 200));
                
                if (!result.ok) {
                    throw new Error(`Server error: ${result.status} - ${responseText}`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error('Invalid response from server');
                }
                
                console.log('Background removal parsed:', data.success, data.error);
                
                if (data.success && data.image) {
                    // Handle both base64 and data URL formats
                    let imageData = data.image;
                    if (!imageData.startsWith('data:')) {
                        imageData = 'data:image/png;base64,' + imageData;
                    }
                    
                    delete selectedElement._imageCache;
                    selectedElement.src = imageData;
                    renderCanvas();
                    hideProcessing();
                    showToast('Background removed successfully!', 'success');
                    return;
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    throw new Error('Unknown error from server');
                }
                
            } catch (error) {
                console.error('Background removal error:', error);
                hideProcessing();
                
                if (error.name === 'AbortError') {
                    showToast('Background removal timed out. Please try again.', 'error');
                } else {
                    showToast(`Background removal failed: ${error.message}`, 'error');
                }
            }
        }

        function showProcessing(message) {
            // Remove existing overlay first
            hideProcessing();
            
            const overlay = document.createElement('div');
            overlay.className = 'processing-overlay';
            overlay.id = 'processingOverlay';
            overlay.innerHTML = `
                <div class="processing-spinner"></div>
                <div class="processing-text">${message}</div>
            `;
            document.body.appendChild(overlay);
        }

        function hideProcessing() {
            const overlay = document.getElementById('processingOverlay');
            if (overlay) overlay.remove();
        }

        // ============================================
        // IMAGE EFFECTS
        // ============================================
        function openEffectsPanel() {
            if (!selectedElement || selectedElement.type !== 'image') {
                showToast('Select an image element first', 'warning');
                return;
            }
            
            const modal = document.getElementById('effectsModal');
            modal.classList.add('active');
            
            // Set sliders to current values
            const effects = selectedElement.effects || { brightness: 100, contrast: 100, saturation: 100, opacity: 100 };
            document.getElementById('brightnessSlider').value = effects.brightness;
            document.getElementById('contrastSlider').value = effects.contrast;
            document.getElementById('saturationSlider').value = effects.saturation;
            document.getElementById('opacitySlider').value = effects.opacity;
            
            updateEffectLabels();
        }

        function closeEffectsPanel() {
            document.getElementById('effectsModal').classList.remove('active');
        }

        function updateEffect(type, value) {
            if (!selectedElement) return;
            
            if (!selectedElement.effects) {
                selectedElement.effects = { brightness: 100, contrast: 100, saturation: 100, opacity: 100 };
            }
            
            selectedElement.effects[type] = parseInt(value);
            updateEffectLabels();
            renderCanvas();
        }

        function updateEffectLabels() {
            document.getElementById('brightnessValue').textContent = document.getElementById('brightnessSlider').value + '%';
            document.getElementById('contrastValue').textContent = document.getElementById('contrastSlider').value + '%';
            document.getElementById('saturationValue').textContent = document.getElementById('saturationSlider').value + '%';
            document.getElementById('opacityValue').textContent = document.getElementById('opacitySlider').value + '%';
        }

        function applyEffect(effect) {
            if (!selectedElement || selectedElement.type !== 'image') {
                showToast('Select an image element first', 'warning');
                return;
            }
            
            if (!selectedElement.effects) {
                selectedElement.effects = { brightness: 100, contrast: 100, saturation: 100, opacity: 100 };
            }
            
            switch (effect) {
                case 'grayscale':
                    selectedElement.effects.saturation = 0;
                    document.getElementById('saturationSlider').value = 0;
                    break;
                case 'sepia':
                    selectedElement.effects.sepia = 100;
                    break;
                case 'invert':
                    selectedElement.effects.invert = true;
                    break;
                case 'blur':
                    selectedElement.effects.blur = 5;
                    break;
            }
            
            updateEffectLabels();
            renderCanvas();
            showToast(`${effect} effect applied`, 'success');
        }

        function resetEffects() {
            if (!selectedElement) return;
            
            // Reset ALL effects including special ones
            selectedElement.effects = { 
                brightness: 100, 
                contrast: 100, 
                saturation: 100, 
                opacity: 100,
                sepia: 0,
                invert: false,
                blur: 0
            };
            document.getElementById('brightnessSlider').value = 100;
            document.getElementById('contrastSlider').value = 100;
            document.getElementById('saturationSlider').value = 100;
            document.getElementById('opacitySlider').value = 100;
            updateEffectLabels();
            renderCanvas();
            showToast('Effects reset', 'success');
        }

        // ============================================
        // ENHANCED LAYER CONTROLS
        // ============================================
        function renderLayers() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';
            
            [...canvasState.elements].reverse().forEach(el => {
                const item = document.createElement('div');
                item.className = `layer-item ${el === selectedElement ? 'selected' : ''} ${el.locked ? 'locked' : ''}`;
                item.dataset.id = el.id;
                
                const icon = el.type === 'button' ? 'fa-square' : el.type === 'image' ? 'fa-image' : 'fa-font';
                
                item.innerHTML = `
                    <div class="layer-icon"><i class="fas ${icon}"></i></div>
                    <div class="layer-info">
                        <div class="layer-name">${el.name || el.type}</div>
                        <div class="layer-type">${el.type}</div>
                    </div>
                    <div class="layer-controls">
                        <button class="layer-control-btn" onclick="toggleLock('${el.id}', event)" title="${el.locked ? 'Unlock' : 'Lock'}">
                            <i class="fas fa-${el.locked ? 'lock' : 'lock-open'}"></i>
                        </button>
                        <button class="layer-control-btn" onclick="duplicateLayerElement('${el.id}', event)" title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="layer-control-btn" onclick="deleteLayerElement('${el.id}', event)" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="layer-visibility" onclick="toggleVisibility('${el.id}', event)">
                        <i class="fas fa-${el.visible ? 'eye' : 'eye-slash'}"></i>
                    </div>
                `;
                
                item.addEventListener('click', () => selectElement(el));
                
                // Make layers draggable for reordering
                item.draggable = true;
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', el.id);
                    item.style.opacity = '0.5';
                });
                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.style.borderTop = '2px solid var(--primary)';
                });
                item.addEventListener('dragleave', () => {
                    item.style.borderTop = '';
                });
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.style.borderTop = '';
                    const draggedId = e.dataTransfer.getData('text/plain');
                    reorderLayers(draggedId, el.id);
                });
                
                list.appendChild(item);
            });
        }

        function toggleLock(id, event) {
            event.stopPropagation();
            const el = canvasState.elements.find(e => e.id === id);
            if (el) {
                el.locked = !el.locked;
                renderLayers();
                showToast(el.locked ? 'Layer locked' : 'Layer unlocked', 'info');
            }
        }

        function duplicateLayerElement(id, event) {
            event.stopPropagation();
            const el = canvasState.elements.find(e => e.id === id);
            if (el) {
                const newEl = {
                    ...el,
                    id: `el-${Date.now()}`,
                    name: el.name + ' copy',
                    x: el.x + 20,
                    y: el.y + 20,
                    locked: false
                };
                canvasState.elements.push(newEl);
                selectElement(newEl);
                renderCanvas();
                renderLayers();
                showToast('Layer duplicated', 'success');
            }
        }

        function deleteLayerElement(id, event) {
            event.stopPropagation();
            const el = canvasState.elements.find(e => e.id === id);
            if (el && !el.locked) {
                canvasState.elements = canvasState.elements.filter(e => e.id !== id);
                if (selectedElement?.id === id) selectElement(null);
                renderCanvas();
                renderLayers();
                showToast('Layer deleted', 'success');
            } else if (el?.locked) {
                showToast('Unlock layer first', 'warning');
            }
        }

        function reorderLayers(draggedId, targetId) {
            const draggedIndex = canvasState.elements.findIndex(e => e.id === draggedId);
            const targetIndex = canvasState.elements.findIndex(e => e.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            const [dragged] = canvasState.elements.splice(draggedIndex, 1);
            // Since layers are displayed in reverse, we need to adjust
            const insertIndex = targetIndex > draggedIndex ? targetIndex : targetIndex;
            canvasState.elements.splice(insertIndex, 0, dragged);
            
            renderCanvas();
            renderLayers();
        }

        // ============================================
        // UPDATED DRAW ELEMENTS (with image support & effects)
        // ============================================
        function drawElements(ctx) {
            console.log('Drawing', canvasState.elements.length, 'elements');
            canvasState.elements.forEach(el => {
                if (!el.visible) return;
                
                ctx.save();
                
                // Apply effects for images
                if (el.type === 'image' && el.effects) {
                    // Apply opacity
                    ctx.globalAlpha = (el.effects.opacity || 100) / 100;
                    
                    // Build CSS filter string for other effects
                    let filterString = '';
                    
                    if (el.effects.brightness !== undefined && el.effects.brightness !== 100) {
                        filterString += `brightness(${el.effects.brightness}%) `;
                    }
                    if (el.effects.contrast !== undefined && el.effects.contrast !== 100) {
                        filterString += `contrast(${el.effects.contrast}%) `;
                    }
                    if (el.effects.saturation !== undefined && el.effects.saturation !== 100) {
                        filterString += `saturate(${el.effects.saturation}%) `;
                    }
                    if (el.effects.sepia) {
                        filterString += `sepia(${el.effects.sepia}%) `;
                    }
                    if (el.effects.invert) {
                        filterString += `invert(100%) `;
                    }
                    if (el.effects.blur) {
                        filterString += `blur(${el.effects.blur}px) `;
                    }
                    
                    if (filterString) {
                        ctx.filter = filterString.trim();
                    }
                }
                
                if (el.type === 'image' && el.src) {
                    // Check if we need to reload the image (cache miss or src changed)
                    if (!el._imageCache || el._imageCache.src !== el.src || !el._imageCache.complete) {
                        const img = new Image();
                        img.onload = function() {
                            el._imageCache = img;
                            // Re-render after image loads
                            renderCanvas();
                        };
                        img.onerror = function() {
                            console.error('Failed to load image:', el.src.substring(0, 50));
                        };
                        img.src = el.src;
                        el._imageCache = img; // Store reference even before load
                    }
                    
                    // Draw if image is loaded
                    if (el._imageCache && el._imageCache.complete && el._imageCache.naturalWidth > 0) {
                        ctx.drawImage(el._imageCache, el.x, el.y, el.width, el.height);
                    } else {
                        // Draw placeholder while loading
                        ctx.fillStyle = '#333';
                        ctx.fillRect(el.x, el.y, el.width, el.height);
                        ctx.strokeStyle = '#666';
                        ctx.strokeRect(el.x, el.y, el.width, el.height);
                        ctx.fillStyle = '#888';
                        ctx.font = '14px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('Loading...', el.x + el.width/2, el.y + el.height/2);
                    }
                } else if (el.type === 'button') {
                    ctx.fillStyle = el.backgroundColor || '#6366f1';
                    ctx.beginPath();
                    ctx.roundRect(el.x, el.y, el.width, el.height, 8);
                    ctx.fill();
                    
                    if (el.text) {
                        ctx.font = `${el.fontSize || 16}px Inter, sans-serif`;
                        ctx.fillStyle = el.color || '#ffffff';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(el.text, el.x + el.width / 2, el.y + el.height / 2);
                    }
                } else if (el.text) {
                    ctx.font = `${el.fontSize || 16}px Inter, sans-serif`;
                    ctx.fillStyle = el.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(el.text, el.x + el.width / 2, el.y + el.height / 2);
                }
                
                // Selection highlight
                if (el === selectedElement) {
                    ctx.strokeStyle = '#6366f1';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(el.x - 4, el.y - 4, el.width + 8, el.height + 8);
                    ctx.setLineDash([]);
                    
                    const handles = [
                        { x: el.x - 4, y: el.y - 4 },
                        { x: el.x + el.width, y: el.y - 4 },
                        { x: el.x - 4, y: el.y + el.height },
                        { x: el.x + el.width, y: el.y + el.height }
                    ];
                    
                    ctx.fillStyle = '#ffffff';
                    handles.forEach(h => {
                        ctx.fillRect(h.x, h.y, 8, 8);
                        ctx.strokeRect(h.x, h.y, 8, 8);
                    });
                }
                
                ctx.restore();
            });
        }

        // ============================================
        // ADDITIONAL KEYBOARD SHORTCUTS
        // ============================================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts when typing in inputs, textareas, or when modal is open
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if (e.target.isContentEditable) return;
                
                // Check if any modal is open - don't intercept shortcuts
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) return;
                
                switch (e.key.toLowerCase()) {
                    case 'delete':
                    case 'backspace':
                        if (selectedElement && !selectedElement.locked) deleteElement();
                        break;
                    case 'v':
                        setTool('select');
                        break;
                    case 'm':
                        setTool('move');
                        break;
                    case 't':
                        setTool('text');
                        break;
                    case 's':
                        if (!e.ctrlKey && !e.metaKey) {
                            setTool('shape');
                        }
                        break;
                    case 'i':
                        document.getElementById('imageUploadInput').click();
                        break;
                    case 'e':
                        setTool('eraser');
                        break;
                    case 'c':
                        if (!e.ctrlKey && !e.metaKey) {
                            setTool('crop');
                        }
                        break;
                    case 'escape':
                        selectElement(null);
                        closeTemplatesPanel();
                        closeResizePanel();
                        closeEffectsPanel();
                        break;
                    case '+':
                    case '=':
                        zoomIn();
                        break;
                    case '-':
                        zoomOut();
                        break;
                    case '0':
                        zoomReset();
                        break;
                    case 'l':
                        if (selectedElement) {
                            selectedElement.locked = !selectedElement.locked;
                            renderLayers();
                            showToast(selectedElement.locked ? 'Layer locked' : 'Layer unlocked', 'info');
                        }
                        break;
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case 'd':
                            e.preventDefault();
                            duplicateElement();
                            break;
                        case 's':
                            e.preventDefault();
                            exportCreative();
                            break;
                        case 'z':
                            e.preventDefault();
                            if (e.shiftKey) {
                                redo();
                            } else {
                                undo();
                            }
                            break;
                        case 'y':
                            e.preventDefault();
                            redo();
                            break;
                        case 'e':
                            e.preventDefault();
                            if (selectedElement?.type === 'image') openEffectsPanel();
                            break;
                    }
                }
            });
        }

        // ============================================
        // TOOL SETUP UPDATE (handle new tools)
        // ============================================
        function setupTools() {
            const toolButtons = document.querySelectorAll('.tool-btn[data-tool]');
            
            toolButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tool = btn.dataset.tool;
                    if (!tool) return; // Skip buttons without data-tool
                    
                    // Handle special tool actions
                    if (tool === 'image') {
                        document.getElementById('imageUploadInput').click();
                        return;
                    }
                    
                    // Remove active from all tool buttons
                    toolButtons.forEach(b => b.classList.remove('active'));
                    // Add active to clicked
                    btn.classList.add('active');
                    // Update current tool
                    currentTool = tool;
                    
                    // Update cursor based on tool
                    const canvas = document.getElementById('mainCanvas');
                    switch(currentTool) {
                        case 'select':
                            canvas.style.cursor = 'default';
                            break;
                        case 'move':
                            canvas.style.cursor = 'move';
                            break;
                        case 'text':
                            canvas.style.cursor = 'text';
                            break;
                        case 'shape':
                            canvas.style.cursor = 'crosshair';
                            break;
                        case 'eraser':
                            canvas.style.cursor = 'crosshair';
                            break;
                        case 'crop':
                            canvas.style.cursor = 'crosshair';
                            break;
                    }
                    
                    showToast(`${currentTool.charAt(0).toUpperCase() + currentTool.slice(1)} tool selected`, 'info');
                });
            });
        }

        function setTool(tool) {
            currentTool = tool;
            const canvas = document.getElementById('mainCanvas');
            
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tool === tool);
            });
            
            // Update cursor
            switch(tool) {
                case 'select':
                    canvas.style.cursor = 'default';
                    break;
                case 'move':
                    canvas.style.cursor = 'move';
                    break;
                case 'text':
                    canvas.style.cursor = 'text';
                    break;
                case 'shape':
                case 'crop':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'eraser':
                    canvas.style.cursor = 'not-allowed';
                    break;
            }
            
            showToast(`${tool.charAt(0).toUpperCase() + tool.slice(1)} tool (${tool[0].toUpperCase()})`, 'info');
        }

        // Close modals on escape or click outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        // ============================================
        // TEXT PRESETS
        // ============================================
        const textPresets = {
            headline: { fontSize: 48, fontWeight: 700, color: '#ffffff', text: 'Your Headline', width: 500, height: 70 },
            subheadline: { fontSize: 28, fontWeight: 500, color: '#ffffff', text: 'Subheading Text', width: 400, height: 50 },
            body: { fontSize: 16, fontWeight: 400, color: '#e2e8f0', text: 'Body text goes here', width: 300, height: 35 },
            price: { fontSize: 42, fontWeight: 800, color: '#10b981', text: '999', width: 150, height: 60 },
            discount: { fontSize: 36, fontWeight: 700, color: '#ef4444', text: '50% OFF', width: 200, height: 55 },
            label: { fontSize: 14, fontWeight: 500, color: '#94a3b8', text: 'LABEL TEXT', width: 150, height: 30 }
        };

        function addTextPreset(presetName) {
            const preset = textPresets[presetName];
            if (!preset) return;

            const newElement = {
                id: `el-${Date.now()}`,
                type: 'text',
                name: presetName.charAt(0).toUpperCase() + presetName.slice(1),
                text: preset.text,
                x: Math.round((canvasState.dimensions.width - preset.width) / 2),
                y: Math.round((canvasState.dimensions.height - preset.height) / 2),
                width: preset.width,
                height: preset.height,
                fontSize: preset.fontSize,
                color: preset.color,
                visible: true
            };

            canvasState.elements.push(newElement);
            selectElement(newElement);
            renderCanvas();
            renderLayers();
            saveToHistory({ action: 'Add Text Preset', preset: presetName });
            showToast(`Added ${presetName} text`, 'success');
        }

        // ============================================
        // QUICK SHAPES
        // ============================================
        function addQuickShape(shapeType) {
            let newElement;
            const centerX = canvasState.dimensions.width / 2;
            const centerY = canvasState.dimensions.height / 2;

            switch (shapeType) {
                case 'rectangle':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'Rectangle',
                        text: '',
                        x: centerX - 100,
                        y: centerY - 50,
                        width: 200,
                        height: 100,
                        backgroundColor: '#6366f1',
                        visible: true
                    };
                    break;
                case 'roundedRect':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'Rounded Rectangle',
                        text: '',
                        x: centerX - 100,
                        y: centerY - 50,
                        width: 200,
                        height: 100,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 16,
                        visible: true
                    };
                    break;
                case 'button':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'CTA Button',
                        text: 'Click Here',
                        x: centerX - 100,
                        y: centerY - 25,
                        width: 200,
                        height: 50,
                        fontSize: 18,
                        color: '#ffffff',
                        backgroundColor: '#6366f1',
                        visible: true
                    };
                    break;
                case 'badge':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'Badge',
                        text: 'NEW',
                        x: centerX - 40,
                        y: centerY - 20,
                        width: 80,
                        height: 40,
                        fontSize: 14,
                        color: '#ffffff',
                        backgroundColor: '#ef4444',
                        visible: true
                    };
                    break;
            }

            if (newElement) {
                canvasState.elements.push(newElement);
                selectElement(newElement);
                renderCanvas();
                renderLayers();
                saveToHistory({ action: 'Add Shape', shapeType: shapeType });
                showToast(`Added ${shapeType}`, 'success');
            }
        }

        // ============================================
        // TESCO ELEMENTS FUNCTIONS
        // ============================================
        
        // Tesco Value Tiles
        function addTescoValueTile(tileType) {
            let newElement;
            const centerX = canvasState.dimensions.width / 2;
            const centerY = canvasState.dimensions.height / 2;

            switch (tileType) {
                case 'new':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'Tesco NEW Tile',
                        text: 'NEW',
                        x: centerX - 60,
                        y: 40,
                        width: 120,
                        height: 45,
                        fontSize: 20,
                        fontWeight: 700,
                        color: '#0050AA',
                        backgroundColor: '#FFFFFF',
                        borderRadius: 4,
                        editable: false,
                        tesco: { type: 'valueTile', subtype: 'new' },
                        visible: true
                    };
                    break;
                case 'white':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'button',
                        name: 'Tesco Price Tile',
                        text: '9.99',
                        x: centerX - 70,
                        y: 40,
                        width: 140,
                        height: 50,
                        fontSize: 28,
                        fontWeight: 700,
                        color: '#0050AA',
                        backgroundColor: '#FFFFFF',
                        borderRadius: 4,
                        tesco: { type: 'valueTile', subtype: 'white', editable: true },
                        visible: true
                    };
                    break;
                case 'clubcard':
                    newElement = {
                        id: `el-${Date.now()}`,
                        type: 'text',
                        name: 'Clubcard Price Tile',
                        text: '7.99\nClubcard Price',
                        x: centerX - 80,
                        y: 40,
                        width: 160,
                        height: 70,
                        fontSize: 24,
                        fontWeight: 700,
                        color: '#FFFFFF',
                        backgroundColor: '#0050AA',
                        borderRadius: 4,
                        textAlign: 'center',
                        tesco: { 
                            type: 'valueTile', 
                            subtype: 'clubcard', 
                            editable: true,
                            requiresEndDate: true 
                        },
                        visible: true
                    };
                    break;
            }

            if (newElement) {
                canvasState.elements.push(newElement);
                selectElement(newElement);
                renderCanvas();
                renderLayers();
                saveToHistory({ action: 'Add Tesco Value Tile', tileType: tileType });
                showToast(`Added Tesco ${tileType} value tile`, 'success');
            }
        }

        // Tesco Tags
        function addTescoTag(tagType) {
            let tagText = '';
            const centerX = canvasState.dimensions.width / 2;
            const bottomY = canvasState.dimensions.height - 60;

            switch (tagType) {
                case 'only':
                    tagText = 'Only at Tesco';
                    break;
                case 'available':
                    tagText = 'Available at Tesco';
                    break;
                case 'selected':
                    tagText = 'Selected stores. While stocks last';
                    break;
                case 'clubcard':
                    tagText = 'Available in selected stores. Clubcard/app required. Ends DD/MM';
                    break;
            }

            const newElement = {
                id: `el-${Date.now()}`,
                type: 'text',
                name: `Tesco Tag: ${tagType}`,
                text: tagText,
                x: centerX - 150,
                y: bottomY,
                width: 300,
                height: 30,
                fontSize: 12,
                fontWeight: 400,
                color: '#64748b',
                textAlign: 'center',
                tesco: { type: 'tag', approved: true },
                visible: true
            };

            canvasState.elements.push(newElement);
            selectElement(newElement);
            renderCanvas();
            renderLayers();
            saveToHistory({ action: 'Add Tesco Tag', tagType: tagType });
            showToast(`Added Tesco tag: ${tagText}`, 'success');
        }

        // Add Drinkaware Logo
        function addDrinkawareLogo() {
            const newElement = {
                id: `el-${Date.now()}`,
                type: 'text',
                name: 'Drinkaware',
                text: 'drinkaware.co.uk',
                x: canvasState.dimensions.width - 150,
                y: canvasState.dimensions.height - 50,
                width: 130,
                height: 30,
                fontSize: 12,
                fontWeight: 500,
                color: '#000000',
                tesco: { type: 'drinkaware', mandatory: true, minHeight: 20 },
                visible: true
            };

            canvasState.elements.push(newElement);
            selectElement(newElement);
            renderCanvas();
            renderLayers();
            saveToHistory({ action: 'Add Drinkaware Logo' });
            showToast('Added Drinkaware logo - Required for alcohol promotions', 'info');
        }

        // Toggle Tesco Elements Section
        function toggleTescoElements(show) {
            const tescoSection = document.getElementById('tescoElementsSection');
            if (tescoSection) {
                tescoSection.style.display = show ? 'block' : 'none';
            }
        }

        // ============================================
        // COLOR PALETTE & ELEMENT COLORS
        // ============================================
        function setElementColor(color) {
            if (!selectedElement) {
                showToast('Select an element first', 'warning');
                return;
            }

            if (selectedElement.type === 'button') {
                selectedElement.backgroundColor = color;
            } else {
                selectedElement.color = color;
            }

            renderCanvas();
            updatePropertyPanel();
            showToast('Color applied', 'success');
        }

        function applyFilter(filterType) {
            if (!selectedElement || selectedElement.type !== 'image') {
                showToast('Select an image first', 'warning');
                return;
            }

            if (!selectedElement.effects) {
                selectedElement.effects = { brightness: 100, contrast: 100, saturation: 100, opacity: 100 };
            }

            switch (filterType) {
                case 'grayscale':
                    selectedElement.effects.saturation = 0;
                    break;
                case 'sepia':
                    selectedElement.effects.sepia = 100;
                    break;
            }

            renderCanvas();
            showToast(`${filterType} filter applied`, 'success');
        }

        // ============================================
        // TOGGLE VISIBILITY (exported function)
        // ============================================
        function toggleVisibility(id, event) {
            event.stopPropagation();
            const el = canvasState.elements.find(e => e.id === id);
            if (el) {
                el.visible = !el.visible;
                renderCanvas();
                renderLayers();
            }
        }

        // ============================================
        // UNDO / REDO HISTORY
        // ============================================
        // Note: History system is now managed by the AI section (lines 3839-3940)
        // with backend persistence support. This section is kept for compatibility.
        
        // historyStack and historyIndex are already defined in AI section
        // Uncomment below if AI section is removed:
        // let historyStack = [];
        // let historyIndex = -1;
        // const MAX_HISTORY = 50;

        // The saveToHistory function with metadata support is in AI section
        // This is a wrapper for compatibility
        if (typeof saveToHistory === 'undefined') {
            function saveToHistory() {
                // Remove any redo states
                historyStack = historyStack.slice(0, historyIndex + 1);
                
                // Deep clone the current state
                const snapshot = JSON.stringify({
                    elements: canvasState.elements,
                    background: canvasState.background,
                    dimensions: canvasState.dimensions
                });
                
                historyStack.push(snapshot);
                
                // Limit history size
                if (historyStack.length > MAX_HISTORY) {
                    historyStack.shift();
                } else {
                    historyIndex++;
                }
                
                updateHistoryButtons();
            }
        }

        // Note: undo() and redo() functions are defined earlier in the AI section (lines 3914-3940)
        // with backend integration support

        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= historyStack.length - 1;
        }

        // Save initial state
        setTimeout(() => {
            if (typeof saveToHistory === 'function') {
                saveToHistory({ action: 'Initial State', timestamp: Date.now() });
            }
        }, 100);



        // ============================================
        // GUIDELINE CHECKER
        // ============================================
        let guidelineResults = [];

        function openGuidelinePanel() {
            document.getElementById('guidelineModal').classList.add('active');
            runGuidelineCheck();
        }

        function closeGuidelinePanel() {
            document.getElementById('guidelineModal').classList.remove('active');
        }

        async function runGuidelineCheck() {
            showToast('Checking guidelines...', 'info');
            
            guidelineResults = [];
            
            // Check canvas dimensions
            const expectedSizes = {
                amazon: { width: 1200, height: 628 },
                flipkart: { width: 1200, height: 628 },
                instagram: { width: 1080, height: 1080 },
                story: { width: 1080, height: 1920 }
            };
            
            const expected = expectedSizes[platform] || expectedSizes.amazon;
            const dimPass = canvasState.dimensions.width === expected.width && 
                           canvasState.dimensions.height === expected.height;
            
            guidelineResults.push({
                pass: dimPass,
                text: dimPass ? 
                    'Canvas dimensions match platform requirements' : 
                    `Canvas size (${canvasState.dimensions.width}${canvasState.dimensions.height}) doesn't match ${platform} (${expected.width}${expected.height})`,
                fix: dimPass ? null : () => resizeCanvas(expected.width, expected.height)
            });
            
            // Check safe zone (10% margin)
            const safeMargin = Math.min(canvasState.dimensions.width, canvasState.dimensions.height) * 0.1;
            let safeZonePass = true;
            
            canvasState.elements.forEach(el => {
                if (el.visible && (el.x < safeMargin || el.y < safeMargin ||
                    el.x + el.width > canvasState.dimensions.width - safeMargin ||
                    el.y + el.height > canvasState.dimensions.height - safeMargin)) {
                    safeZonePass = false;
                }
            });
            
            guidelineResults.push({
                pass: safeZonePass,
                text: safeZonePass ? 
                    'All elements are within safe zone' : 
                    'Some elements extend beyond safe zone (10% margin)',
                fix: safeZonePass ? null : fixSafeZone
            });
            
            // Check minimum font size
            let fontSizePass = true;
            const minFontSize = 12;
            
            canvasState.elements.forEach(el => {
                if (el.visible && el.fontSize && el.fontSize < minFontSize) {
                    fontSizePass = false;
                }
            });
            
            guidelineResults.push({
                pass: fontSizePass,
                text: fontSizePass ? 
                    `Minimum font size met (${minFontSize}px)` : 
                    `Some text is smaller than ${minFontSize}px minimum`,
                fix: fontSizePass ? null : fixFontSizes
            });
            
            // Check for required elements
            const hasHeadline = canvasState.elements.some(el => 
                el.type === 'text' && el.fontSize >= 36
            );
            const hasCTA = canvasState.elements.some(el => 
                el.type === 'button' && el.text
            );
            
            guidelineResults.push({
                pass: hasHeadline,
                text: hasHeadline ? 
                    'Has prominent headline' : 
                    'Missing prominent headline (36px+ text)',
                fix: null
            });
            
            guidelineResults.push({
                pass: hasCTA,
                text: hasCTA ? 
                    'Has call-to-action button' : 
                    'Missing call-to-action button',
                fix: null
            });
            
            // Update UI
            updateGuidelineUI();
            
            // Try to call backend for more detailed check
            try {
                const response = await fetch(`${API_BASE}/api/check-guidelines`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        canvas: canvasState,
                        platform: platform
                    })
                });
                
                if (response.ok) {
                    const backendResults = await response.json();
                    // Merge backend results if available
                }
            } catch (e) {
                // Backend check optional
            }
        }

        function updateGuidelineUI() {
            const resultsContainer = document.getElementById('guidelineResults');
            const overallStatus = document.getElementById('guidelineOverallStatus');
            const headerStatus = document.getElementById('complianceStatus');
            
            const allPass = guidelineResults.every(r => r.pass);
            const hasWarnings = guidelineResults.some(r => !r.pass && !r.critical);
            const hasFails = guidelineResults.some(r => !r.pass && r.critical);
            
            // Update overall status
            if (allPass) {
                overallStatus.className = 'guideline-status pass';
                overallStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>All Checks Passed</span>';
                headerStatus.className = 'compliance-indicator compliant';
                headerStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Compliant</span>';
            } else {
                overallStatus.className = 'guideline-status warning';
                overallStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Issues Found</span>';
                headerStatus.className = 'compliance-indicator issues';
                headerStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Issues</span>';
            }
            
            // Update results list
            resultsContainer.innerHTML = guidelineResults.map(r => `
                <div class="guideline-item ${r.pass ? 'pass' : 'fail'}">
                    <i class="fas fa-${r.pass ? 'check' : 'times'}"></i>
                    <span class="guideline-item-text">${r.text}</span>
                    ${!r.pass && r.fix ? `<button class="guideline-fix-btn" onclick="(${r.fix.toString()})()">Fix</button>` : ''}
                </div>
            `).join('');
        }

        function fixSafeZone() {
            const safeMargin = Math.min(canvasState.dimensions.width, canvasState.dimensions.height) * 0.1;
            
            saveToHistory();
            canvasState.elements.forEach(el => {
                if (el.x < safeMargin) el.x = safeMargin;
                if (el.y < safeMargin) el.y = safeMargin;
                if (el.x + el.width > canvasState.dimensions.width - safeMargin) {
                    el.x = canvasState.dimensions.width - safeMargin - el.width;
                }
                if (el.y + el.height > canvasState.dimensions.height - safeMargin) {
                    el.y = canvasState.dimensions.height - safeMargin - el.height;
                }
            });
            
            renderCanvas();
            runGuidelineCheck();
            showToast('Moved elements to safe zone', 'success');
        }

        function fixFontSizes() {
            const minFontSize = 12;
            
            saveToHistory();
            canvasState.elements.forEach(el => {
                if (el.fontSize && el.fontSize < minFontSize) {
                    el.fontSize = minFontSize;
                }
            });
            
            renderCanvas();
            runGuidelineCheck();
            showToast('Fixed font sizes', 'success');
        }

        function autoFixAll() {
            guidelineResults.forEach(r => {
                if (!r.pass && r.fix) {
                    r.fix();
                }
            });
            showToast('Applied all available fixes', 'success');
        }

        // ============================================
        // EXPORT PANEL
        // ============================================
        let exportSettings = {
            format: 'png',
            scale: 1,
            quality: 90
        };

        function openExportPanel() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportPanel() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function selectExportFormat(format) {
            exportSettings.format = format;
            document.querySelectorAll('.export-format').forEach(el => {
                el.classList.toggle('selected', el.dataset.format === format);
            });
        }

        function selectExportScale(scale) {
            exportSettings.scale = scale;
            document.querySelectorAll('.export-size-option[data-scale]').forEach(el => {
                el.classList.toggle('selected', parseInt(el.dataset.scale) === scale);
            });
        }

        function doExport() {
            exportSettings.quality = parseInt(document.getElementById('exportQualitySlider').value);
            
            const canvas = document.getElementById('mainCanvas');
            const wasSelected = selectedElement;
            selectElement(null);
            renderCanvas();
            
            // Create scaled canvas if needed
            let exportCanvas = canvas;
            if (exportSettings.scale !== 1) {
                exportCanvas = document.createElement('canvas');
                exportCanvas.width = canvas.width * exportSettings.scale;
                exportCanvas.height = canvas.height * exportSettings.scale;
                const ctx = exportCanvas.getContext('2d');
                ctx.scale(exportSettings.scale, exportSettings.scale);
                ctx.drawImage(canvas, 0, 0);
            }
            
            // Export
            const mimeType = exportSettings.format === 'jpg' ? 'image/jpeg' : 
                           exportSettings.format === 'webp' ? 'image/webp' : 'image/png';
            const quality = exportSettings.format === 'png' ? undefined : exportSettings.quality / 100;
            
            const link = document.createElement('a');
            link.download = `creative-${platform}-${exportSettings.scale}x-${Date.now()}.${exportSettings.format}`;
            link.href = exportCanvas.toDataURL(mimeType, quality);
            link.click();
            
            selectElement(wasSelected);
            renderCanvas();
            closeExportPanel();
            showToast(`Exported as ${exportSettings.format.toUpperCase()} (${exportSettings.scale}x)`, 'success');
        }

        function exportAllPlatforms() {
            const platforms = [
                { name: 'amazon', width: 1200, height: 628 },
                { name: 'flipkart', width: 1200, height: 628 },
                { name: 'instagram-post', width: 1080, height: 1080 },
                { name: 'instagram-story', width: 1080, height: 1920 },
                { name: 'facebook', width: 1200, height: 628 }
            ];
            
            const wasSelected = selectedElement;
            selectElement(null);
            
            // Store original state
            const originalDimensions = { ...canvasState.dimensions };
            
            platforms.forEach((p, index) => {
                setTimeout(() => {
                    // Resize canvas
                    canvasState.dimensions = { width: p.width, height: p.height };
                    const canvas = document.getElementById('mainCanvas');
                    canvas.width = p.width;
                    canvas.height = p.height;
                    renderCanvas();
                    
                    // Export
                    const link = document.createElement('a');
                    link.download = `creative-${p.name}-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Restore if last
                    if (index === platforms.length - 1) {
                        canvasState.dimensions = originalDimensions;
                        canvas.width = originalDimensions.width;
                        canvas.height = originalDimensions.height;
                        selectElement(wasSelected);
                        renderCanvas();
                        closeExportPanel();
                        showToast(`Exported ${platforms.length} variants`, 'success');
                    }
                }, index * 500);
            });
        }

        // ============================================
        // AI HEADLINE SUGGESTIONS
        // ============================================
        async function getAISuggestions() {
            try {
                const response = await fetch(`${API_BASE}/api/ai/suggest-prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        context: `${platform} banner`,
                        partial_text: '',
                        category: 'retail'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.suggestions || [];
                }
            } catch (e) {}
            
            // Fallback suggestions
            return [
                'MEGA SALE - Up to 70% OFF',
                'New Arrivals Just Dropped',
                'Limited Time Offer - Shop Now',
                'Best Deals of the Season'
            ];
        }

        // ============================================
        // KEYBOARD SHORTCUTS UPDATE
        // ============================================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                }
            }
        });

        // ============================================
        // WRAP ELEMENT MODIFICATIONS WITH HISTORY
        // ============================================
        const originalAddTextElement = addTextElement;
        addTextElement = function(x, y) {
            saveToHistory();
            originalAddTextElement(x, y);
        };

        const originalAddShapeElement = addShapeElement;
        addShapeElement = function(x, y) {
            saveToHistory();
            originalAddShapeElement(x, y);
        };

        const originalDeleteElement = deleteElement;
        deleteElement = function() {
            saveToHistory();
            originalDeleteElement();
        };

        const originalDuplicateElement = duplicateElement;
        duplicateElement = function() {
            saveToHistory();
            originalDuplicateElement();
        };

        // ============================================
        // DEMO TOUR SYSTEM
        // ============================================
        const tourSteps = [
            {
                type: 'welcome',
                title: 'Welcome to Creative Editor!',
                content: 'Let me show you around the editor and teach you the keyboard shortcuts to boost your productivity.',
                icon: 'fa-magic'
            },
            {
                type: 'element',
                target: '.tool-btn[data-tool="select"]',
                title: 'Selection Tools',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-mouse-pointer"></i></div>
                    <p>Use these tools to select and manipulate elements on the canvas.</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">V</span><span class="tour-shortcut-desc">Select</span></div>
                        <div class="tour-shortcut"><span class="tour-key">M</span><span class="tour-shortcut-desc">Move</span></div>
                    </div>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '.tool-btn[data-tool="text"]',
                title: 'Create Elements',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-font"></i></div>
                    <p>Add text, shapes, and images to your creative.</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">T</span><span class="tour-shortcut-desc">Text tool</span></div>
                        <div class="tour-shortcut"><span class="tour-key">S</span><span class="tour-shortcut-desc">Shape tool</span></div>
                        <div class="tour-shortcut"><span class="tour-key">I</span><span class="tour-shortcut-desc">Image upload</span></div>
                    </div>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '.tool-btn[data-tool="eraser"]',
                title: 'Edit Tools',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-eraser"></i></div>
                    <p>Erase and crop elements for precise editing.</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">E</span><span class="tour-shortcut-desc">Eraser</span></div>
                        <div class="tour-shortcut"><span class="tour-key">C</span><span class="tour-shortcut-desc">Crop</span></div>
                    </div>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '.tool-btn[onclick*="openTemplatesPanel"]',
                title: 'Quick Actions',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-th-large"></i></div>
                    <p>Access templates, resize options, and background removal.</p>
                    <ul style="color: var(--text-muted); font-size: 0.85rem; padding-left: 1.25rem; margin-top: 0.5rem;">
                        <li>Templates - Pre-made designs</li>
                        <li>Resize - Platform presets</li>
                        <li>Remove BG - AI background removal</li>

                    </ul>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '.history-controls',
                title: 'Undo & Redo',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-undo"></i></div>
                    <p>Made a mistake? No problem! Use undo and redo.</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">Ctrl</span>+<span class="tour-key">Z</span><span class="tour-shortcut-desc">Undo</span></div>
                        <div class="tour-shortcut"><span class="tour-key">Ctrl</span>+<span class="tour-key">Y</span><span class="tour-shortcut-desc">Redo</span></div>
                    </div>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '#layersSidebar',
                title: 'Layers Panel',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-layer-group"></i></div>
                    <p>Manage your design layers here. Lock, reorder, and control visibility.</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">L</span><span class="tour-shortcut-desc">Lock/unlock layer</span></div>
                        <div class="tour-shortcut"><span class="tour-key">Del</span><span class="tour-shortcut-desc">Delete selected</span></div>
                    </div>
                `,
                position: 'right'
            },
            {
                type: 'element',
                target: '#propertiesSidebar',
                title: 'AI Assistant & Properties',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-robot"></i></div>
                    <p>Chat with AI to edit your design using natural language, or manually adjust properties.</p>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Try: "Make the headline bigger" or "Change background to blue"</p>
                `,
                position: 'left'
            },
            {
                type: 'element',
                target: '#complianceStatus',
                title: 'Guideline Checker',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-check-double"></i></div>
                    <p>Ensure your creative meets platform guidelines. Click to see detailed compliance checks and auto-fix issues.</p>
                `,
                position: 'bottom'
            },
            {
                type: 'element',
                target: '.export-btn',
                title: 'Export Your Creative',
                content: `
                    <div class="tour-feature-icon"><i class="fas fa-download"></i></div>
                    <p>Export in multiple formats (PNG, JPG, WebP) and sizes (1x, 2x, 3x). Or export all platform sizes at once!</p>
                    <div class="tour-shortcuts-grid">
                        <div class="tour-shortcut"><span class="tour-key">Ctrl</span>+<span class="tour-key">S</span><span class="tour-shortcut-desc">Quick export</span></div>
                    </div>
                `,
                position: 'bottom'
            },
            {
                type: 'shortcuts',
                title: 'All Keyboard Shortcuts',
                content: `
                    <div style="max-height: 300px; overflow-y: auto;">
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Tools</div>
                            <div class="tour-shortcuts-grid">
                                <div class="tour-shortcut"><span class="tour-key">V</span><span class="tour-shortcut-desc">Select</span></div>
                                <div class="tour-shortcut"><span class="tour-key">M</span><span class="tour-shortcut-desc">Move</span></div>
                                <div class="tour-shortcut"><span class="tour-key">T</span><span class="tour-shortcut-desc">Text</span></div>
                                <div class="tour-shortcut"><span class="tour-key">S</span><span class="tour-shortcut-desc">Shape</span></div>
                                <div class="tour-shortcut"><span class="tour-key">I</span><span class="tour-shortcut-desc">Image</span></div>
                                <div class="tour-shortcut"><span class="tour-key">E</span><span class="tour-shortcut-desc">Eraser</span></div>
                                <div class="tour-shortcut"><span class="tour-key">C</span><span class="tour-shortcut-desc">Crop</span></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Actions</div>
                            <div class="tour-shortcuts-grid">
                                <div class="tour-shortcut"><span class="tour-key">Ctrl+Z</span><span class="tour-shortcut-desc">Undo</span></div>
                                <div class="tour-shortcut"><span class="tour-key">Ctrl+Y</span><span class="tour-shortcut-desc">Redo</span></div>
                                <div class="tour-shortcut"><span class="tour-key">Ctrl+D</span><span class="tour-shortcut-desc">Duplicate</span></div>
                                <div class="tour-shortcut"><span class="tour-key">Ctrl+S</span><span class="tour-shortcut-desc">Export</span></div>
                                <div class="tour-shortcut"><span class="tour-key">Del</span><span class="tour-shortcut-desc">Delete</span></div>
                                <div class="tour-shortcut"><span class="tour-key">L</span><span class="tour-shortcut-desc">Lock layer</span></div>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Zoom</div>
                            <div class="tour-shortcuts-grid">
                                <div class="tour-shortcut"><span class="tour-key">+</span><span class="tour-shortcut-desc">Zoom in</span></div>
                                <div class="tour-shortcut"><span class="tour-key">-</span><span class="tour-shortcut-desc">Zoom out</span></div>
                                <div class="tour-shortcut"><span class="tour-key">0</span><span class="tour-shortcut-desc">Reset zoom</span></div>
                                <div class="tour-shortcut"><span class="tour-key">Esc</span><span class="tour-shortcut-desc">Deselect</span></div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                type: 'finish',
                title: 'You\'re All Set! ',
                content: 'You now know all the shortcuts to work like a pro. Start creating amazing retail creatives!',
                icon: 'fa-rocket'
            }
        ];

        let currentTourStep = 0;
        let tourActive = false;

        function startTour() {
            try {
                tourActive = true;
                currentTourStep = 0;
                document.getElementById('tourOverlay').classList.add('active');
                showTourStep(0);
            } catch (e) {
                console.error('Tour error:', e);
                endTour(false);
            }
        }

        function endTour(dontShowAgain = false) {
            tourActive = false;
            const overlay = document.getElementById('tourOverlay');
            const spotlight = document.getElementById('tourSpotlight');
            const card = document.getElementById('tourCard');
            
            if (overlay) overlay.classList.remove('active');
            if (spotlight) spotlight.style.display = 'none';
            if (card) card.style.display = 'none';
            
            if (dontShowAgain) {
                localStorage.setItem('hideDemoTour', 'true');
            }
            
            showToast('Tip: Press ? anytime to see shortcuts', 'info');
        }

        // Manual reset function - call resetTour() in console to clear
        function resetTour() {
            localStorage.removeItem('hideDemoTour');
            endTour(false);
            console.log('Tour reset. Refresh page to see tour again.');
        }

        function showTourStep(stepIndex) {
            const step = tourSteps[stepIndex];
            const overlay = document.getElementById('tourOverlay');
            const spotlight = document.getElementById('tourSpotlight');
            const card = document.getElementById('tourCard');
            
            if (step.type === 'welcome' || step.type === 'finish' || step.type === 'shortcuts') {
                // Center card, no spotlight
                spotlight.style.display = 'none';
                overlay.classList.add('active');
                
                let icon = step.icon || 'fa-info-circle';
                let cardContent = '';
                
                if (step.type === 'welcome') {
                    cardContent = `
                        <div class="tour-welcome">
                            <div class="tour-welcome-icon"><i class="fas ${icon}"></i></div>
                            <h2>${step.title}</h2>
                            <p>${step.content}</p>
                            <button class="tour-btn tour-btn-primary" onclick="nextTourStep()" style="width: 100%;">
                                Start Tour <i class="fas fa-arrow-right" style="margin-left: 0.5rem;"></i>
                            </button>
                            <span class="tour-skip-link" onclick="endTour(false)">Skip tour</span>
                        </div>
                    `;
                } else if (step.type === 'finish') {
                    cardContent = `
                        <div class="tour-welcome">
                            <div class="tour-welcome-icon"><i class="fas ${icon}"></i></div>
                            <h2>${step.title}</h2>
                            <p>${step.content}</p>
                            <button class="tour-btn tour-btn-primary" onclick="endTour(false)" style="width: 100%;">
                                Get Started <i class="fas fa-check" style="margin-left: 0.5rem;"></i>
                            </button>
                            <div class="tour-dont-show">
                                <input type="checkbox" id="dontShowTour">
                                <label for="dontShowTour">Don't show this again</label>
                            </div>
                        </div>
                    `;
                } else if (step.type === 'shortcuts') {
                    cardContent = `
                        <div class="tour-card-header">
                            <div class="tour-step-badge">${stepIndex}</div>
                            <div class="tour-card-title">${step.title}</div>
                        </div>
                        <div class="tour-card-content">${step.content}</div>
                        <div class="tour-card-footer">
                            <div class="tour-progress">${renderTourProgress(stepIndex)}</div>
                            <div class="tour-buttons">
                                <button class="tour-btn tour-btn-secondary" onclick="prevTourStep()">Back</button>
                                <button class="tour-btn tour-btn-primary" onclick="nextTourStep()">Next</button>
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = cardContent;
                card.style.display = 'block';
                card.style.top = '50%';
                card.style.left = '50%';
                card.style.transform = 'translate(-50%, -50%)';
                
            } else if (step.type === 'element') {
                // Spotlight on element
                const target = document.querySelector(step.target);
                
                if (target) {
                    const rect = target.getBoundingClientRect();
                    const padding = 8;
                    
                    spotlight.style.display = 'block';
                    spotlight.style.top = (rect.top - padding) + 'px';
                    spotlight.style.left = (rect.left - padding) + 'px';
                    spotlight.style.width = (rect.width + padding * 2) + 'px';
                    spotlight.style.height = (rect.height + padding * 2) + 'px';
                    
                    // Position card relative to spotlight
                    card.innerHTML = `
                        <div class="tour-card-header">
                            <div class="tour-step-badge">${stepIndex}</div>
                            <div class="tour-card-title">${step.title}</div>
                        </div>
                        <div class="tour-card-content">${step.content}</div>
                        <div class="tour-card-footer">
                            <div class="tour-progress">${renderTourProgress(stepIndex)}</div>
                            <div class="tour-buttons">
                                ${stepIndex > 0 ? '<button class="tour-btn tour-btn-secondary" onclick="prevTourStep()">Back</button>' : ''}
                                <button class="tour-btn tour-btn-primary" onclick="nextTourStep()">
                                    ${stepIndex === tourSteps.length - 1 ? 'Finish' : 'Next'}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    card.style.display = 'block';
                    card.style.transform = 'none';
                    
                    // Position based on preference
                    const cardWidth = 380;
                    const cardHeight = card.offsetHeight || 250;
                    const margin = 16;
                    
                    switch (step.position) {
                        case 'bottom':
                            card.style.top = (rect.bottom + margin) + 'px';
                            card.style.left = Math.max(margin, Math.min(rect.left, window.innerWidth - cardWidth - margin)) + 'px';
                            break;
                        case 'top':
                            card.style.top = (rect.top - cardHeight - margin) + 'px';
                            card.style.left = Math.max(margin, rect.left) + 'px';
                            break;
                        case 'left':
                            card.style.top = rect.top + 'px';
                            card.style.left = Math.max(margin, rect.left - cardWidth - margin) + 'px';
                            break;
                        case 'right':
                            card.style.top = rect.top + 'px';
                            card.style.left = (rect.right + margin) + 'px';
                            break;
                    }
                } else {
                    // Target not found, skip to next
                    nextTourStep();
                }
            }
        }

        function renderTourProgress(current) {
            return tourSteps.map((_, i) => {
                if (i < current) return '<div class="tour-dot completed"></div>';
                if (i === current) return '<div class="tour-dot active"></div>';
                return '<div class="tour-dot"></div>';
            }).join('');
        }

        function nextTourStep() {
            if (currentTourStep < tourSteps.length - 1) {
                currentTourStep++;
                showTourStep(currentTourStep);
            } else {
                // Check if "don't show again" is checked
                const checkbox = document.getElementById('dontShowTour');
                endTour(checkbox && checkbox.checked);
            }
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                currentTourStep--;
                showTourStep(currentTourStep);
            }
        }

        // Auto-start tour on page load (if not hidden)
        function checkAndStartTour() {
            const hideTour = localStorage.getItem('hideDemoTour');
            if (hideTour !== 'true') {
                // Longer delay to ensure everything is loaded
                setTimeout(() => {
                    try {
                        startTour();
                    } catch (e) {
                        console.error('Failed to start tour:', e);
                    }
                }, 1000);
            }
        }

        // Add keyboard shortcut to show tour anytime
        document.addEventListener('keydown', (e) => {
            // Only trigger ? when not typing in an input
            if (e.key === '?' && !tourActive && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                startTour();
            }
            if (e.key === 'Escape' && tourActive) {
                e.preventDefault();
                endTour(false);
            }
        });

        // Close tour on overlay click
        document.getElementById('tourOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                endTour(false);
            }
        });

        // Start tour on page load
        window.addEventListener('load', checkAndStartTour);
    </script>

    <!-- Additional JavaScript Modules -->
    <script src="js/api.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/shortcuts.js"></script>
    <script src="js/history.js"></script>
    <script src="js/layers.js"></script>
    <script src="js/colorpalette.js"></script>
    <script src="js/compliance.js"></script>
    <script src="js/export.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/dragdrop.js"></script>
    <script src="js/ai-agent.js"></script>
    <script>
        // Initialize AI Agent - Robust initialization
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing AI Agent...');
            
            // Create a simple editor object if it doesn't exist
            if (!window.editor) {
                console.log('window.editor not found, creating simple editor object');
                window.editor = {
                    elements: canvasState?.elements || [],
                    canvas: document.getElementById('mainCanvas'),
                    context: document.getElementById('mainCanvas')?.getContext('2d')
                };
            }
            
            // Initialize AI Agent immediately
            try {
                initAIAgent(window.editor);
                console.log(' AI Agent initialized successfully');
            } catch (error) {
                console.error(' Failed to initialize AI Agent:', error);
                
                // Retry after a delay
                setTimeout(() => {
                    try {
                        if (!window.aiAgent) {
                            console.log('Retrying AI Agent initialization...');
                            initAIAgent(window.editor);
                            console.log(' AI Agent initialized on retry');
                        }
                    } catch (retryError) {
                        console.error(' Retry failed:', retryError);
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
